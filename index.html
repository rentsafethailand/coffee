<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการร้านกาแฟ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for Light/Dark Mode */
    :root {
      /* Light Mode Colors */
      --bg-primary: #f3f4f6;
      --bg-secondary: #ffffff;
      --bg-gradient-from: #6366f1;
      --bg-gradient-to: #8b5cf6;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --card-bg: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Dark Mode Colors */
    body.dark-mode {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-gradient-from: #4f46e5;
      --bg-gradient-to: #7c3aed;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --border-color: #374151;
      --card-bg: #1f2937;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    /* Apply theme colors */
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%); transition: background 0.3s ease;
    }
    .page { display: none; }
    .page.active { display: block; }
    .gradient-bg { background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%); transition: background 0.3s ease; }
    .card-gradient { background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%); }
    .glass { background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: var(--shadow); transition: all 0.3s ease; }

    /* Print Styles */
    @media print {
      body * { visibility: hidden; }
      #receiptPrintModal, #receiptPrintModal * { visibility: visible; }
      #receiptPrintModal { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background: white; }
      #receiptPrintModal .bg-gray-800, #receiptPrintModal .bg-gray-100 { display: none !important; }
      #receiptContent { box-shadow: none !important; margin: 0 !important; }
    }

    /* Receipt Paper Sizes */
    .receipt-a4 { width: 210mm; min-height: 297mm; padding: 20mm; }
    .receipt-thermal-80 { width: 80mm; min-height: 100mm; padding: 5mm; font-size: 12px; }
    .receipt-thermal-58 { width: 58mm; min-height: 100mm; padding: 3mm; font-size: 10px; }

    @page { margin: 0; }
    /* Modern Card Design */
    .modern-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .modern-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }

    /* Smooth Transitions */
    * {
      transition-property: background-color, border-color, color, fill, stroke;
      transition-duration: 0.2s;
      transition-timing-function: ease-in-out;
    }

    /* Dark Mode Toggle Button */
    .dark-mode-toggle {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .dark-mode-toggle:hover {
      background: var(--card-bg);
      transform: scale(1.05);
    }

    /* Enhanced Glass Morphism */
    .glass-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    /* Modern Card Styles */
    .card-modern {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    /* Navigation Link Styles */
    .nav-link {
      color: var(--text-primary);
      transition: all 0.2s ease;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
    }

    .nav-link:hover {
      background: var(--bg-primary);
      color: #6366f1;
    }

    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-slideUp {
      animation: slideUp 0.4s ease-out;
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }

    /* Dark Mode Text Smoothing */
    body.dark-mode {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Input Focus Styles */
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Button Hover Effects */
    .btn-modern {
      transition: all 0.2s ease;
    }

    .btn-modern:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }

    .btn-modern:active {
      transform: translateY(0);
    }

    /* Modal Backdrop */
    .modal-backdrop {
      /* Removed backdrop-filter for solid backgrounds */
    }

    /* Gradient Text */
    .text-gradient {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Card Hover Effect */
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }
  
    /* Modern Product Card in Sales Page */
    .product-card {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 1rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover {
      border-color: #6366f1;
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);
      transform: translateY(-4px);
    }

    .product-card:active {
      transform: translateY(-2px);
    }

    /* Modern Table Styles */
    table {
      border-collapse: separate;
      border-spacing: 0;
    }

    table thead tr {
      background: var(--card-bg);
    }

    table tbody tr {
      transition: background-color 0.2s ease;
    }

    table tbody tr:hover {
      background: var(--bg-primary);
    }

    /* Modern Button Styles */
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }

    /* Modern Badge Styles */
    .badge-modern {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
</style>
</head>
<body class="min-h-screen transition-colors duration-300">

<!-- Top Navigation (Desktop & Tablet) -->
<nav id="topNav" class="hidden md:block transition-colors duration-300" style="display:none; background: var(--card-bg); box-shadow: var(--shadow-lg);">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center h-16">
      <div class="flex items-center space-x-4">
        <i class="fas fa-mug-hot text-3xl text-purple-600"></i>
        <div>
          <h1 class="text-xl font-bold text-gray-800" id="shopNameTop">Coffee Shop</h1>
          <p class="text-xs text-gray-500" id="shopEmailTop"></p>
        </div>
      </div>
      <div class="flex items-center space-x-6">
        <button onclick="showPage('dashboard')" class="nav-link"><i class="fas fa-chart-line mr-2"></i>หน้าหลัก</button>
        <button onclick="showPage('sales')" class="nav-link"><i class="fas fa-cash-register mr-2"></i>ขายหน้าร้าน</button>
        <button onclick="showPage('sales-history')" class="nav-link"><i class="fas fa-history mr-2"></i>ประวัติการขาย</button>
        <button onclick="showPage('products')" class="nav-link"><i class="fas fa-box mr-2"></i>สินค้า</button>
        <button onclick="showPage('materials')" class="nav-link"><i class="fas fa-warehouse mr-2"></i>วัตถุดิบ</button>
        <button onclick="showPage('costs')" class="nav-link"><i class="fas fa-money-bill mr-2"></i>ค่าใช้จ่าย</button>
        <button onclick="showPage('inventory')" class="nav-link"><i class="fas fa-boxes mr-2"></i>สต็อก</button>
        <button onclick="showPage('reports')" class="nav-link"><i class="fas fa-file-alt mr-2"></i>รายงาน</button>
        <button onclick="showPage('settings')" class="nav-link"><i class="fas fa-cog mr-2"></i>ตั้งค่า</button>

        <!-- Dark Mode Toggle -->
        <button onclick="toggleDarkMode()" class="dark-mode-toggle flex items-center text-gray-700 dark:text-gray-200 text-sm hover:scale-105 transition" title="สลับโหมดมืด/สว่าง">
          <i id="darkModeIcon" class="fas fa-moon mr-2"></i>
          <span id="darkModeText">โหมดมืด</span>
        </button>

        <button onclick="showVersionChangelog()" class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-sm hover:bg-purple-200 transition" title="ดูประวัติการอัปเดต">
          <i class="fas fa-code-branch mr-1"></i><span id="versionBadge">v1.0.0</span>
        </button>
        <button onclick="logout()" class="text-red-600 hover:text-red-800"><i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ</button>
      </div>
    </div>
  </div>
</nav>

<!-- Bottom Navigation (Mobile) -->
<div id="bottomNav" class="md:hidden fixed bottom-0 left-0 right-0 z-50 transition-colors duration-300" style="display:none; background: var(--card-bg); box-shadow: var(--shadow-lg); border-top: 2px solid var(--border-color);">
  <div class="flex justify-around py-2">
    <button onclick="showPage('dashboard')" class="flex flex-col items-center p-2"><i class="fas fa-chart-line text-xl"></i><span class="text-xs">หน้าหลัก</span></button>
    <button onclick="showPage('sales')" class="flex flex-col items-center p-2"><i class="fas fa-cash-register text-xl"></i><span class="text-xs">ขายหน้าร้าน</span></button>
    <button onclick="showPage('inventory')" class="flex flex-col items-center p-2"><i class="fas fa-boxes text-xl"></i><span class="text-xs">สต็อก</span></button>
    <button onclick="openMoreMenu()" class="flex flex-col items-center p-2"><i class="fas fa-cog text-xl"></i><span class="text-xs">เพิ่มเติม</span></button>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 modal-backdrop">
  <div class="card-modern max-w-md w-full mx-4 p-8 animate-slideUp">
    <div class="text-center mb-8">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-xl">
        <i class="fas fa-mug-hot text-4xl text-white"></i>
      </div>
      <h2 class="text-3xl font-bold mt-4 text-gradient">เข้าสู่ระบบ</h2>
      <p style="color: var(--text-secondary);" class="mt-2">ระบบจัดการร้านกาแฟ</p>
    </div>
    <form onsubmit="handleLogin(event)" class="space-y-4">
      <div>
        <label class="block font-medium mb-2" style="color: var(--text-primary);">อีเมล</label>
        <div class="relative">
          <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
          <input type="email" id="loginEmail" class="w-full pl-10 pr-4 py-3 rounded-xl border-2 transition-all" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" placeholder="your@email.com" required>
        </div>
      </div>
      <div>
        <label class="block font-medium mb-2" style="color: var(--text-primary);">รหัสผ่าน</label>
        <div class="relative">
          <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
          <input type="password" id="loginPassword" class="w-full pl-10 pr-4 py-3 rounded-xl border-2 transition-all" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" placeholder="••••••••" required>
        </div>
      </div>
      <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg btn-modern">
        <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
      </button>
    </form>
  </div>
</div>

<!-- Version Changelog Modal -->
<div id="changelogModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
  <div class="rounded-lg max-w-3xl" style="background: var(--card-bg); w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold"><i class="fas fa-code-branch mr-2"></i>ประวัติการอัปเดต</h2>
        <p class="text-sm opacity-90 mt-1">เวอร์ชันปัจจุบัน: <span id="currentVersionText">v1.0.0</span></p>
      </div>
      <button onclick="closeChangelogModal()" class="text-white hover:text-gray-200 text-2xl">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Content -->
    <div id="changelogContent" class="p-6 overflow-y-auto flex-1">
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-spinner fa-spin text-3xl"></i>
        <p class="mt-2">กำลังโหลด...</p>
      </div>
    </div>
  </div>
</div>

<!-- Product Options Modal -->
<div id="productOptionsModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50" style="display:none;">
  <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6">
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-2xl font-bold"><i class="fas fa-sliders-h mr-2"></i>ปรับแต่งสินค้า</h2>
          <p class="text-sm opacity-90 mt-1" id="optionsProductName">-</p>
        </div>
        <button onclick="closeProductOptionsModal()" class="text-white hover:text-gray-200 text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto flex-1">
      <!-- Price Display -->
      <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-6">
        <div class="flex justify-between items-center">
          <span class="text-gray-700 font-medium">ราคาปัจจุบัน:</span>
          <span id="optionsCurrentPrice" class="text-3xl font-bold text-purple-600">฿0.00</span>
        </div>
      </div>

      <!-- Options Sections -->
      <div id="optionsSections" class="space-y-6">
        <!-- Options will be loaded dynamically -->
      </div>

      <!-- Notes Section -->
      <div class="mt-6">
        <label class="block font-bold text-gray-700 mb-2">
          <i class="fas fa-comment mr-2"></i>หมายเหตุเพิ่มเติม (ถ้ามี)
        </label>
        <textarea
          id="productNotes"
          rows="3"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          placeholder="เช่น: ไม่ใส่น้ำตาล, ใส่กระดาษไว้ด้วย, ฯลฯ"></textarea>
      </div>

      <!-- Quantity -->
      <div class="mt-6">
        <label class="block font-bold text-gray-700 mb-2">
          <i class="fas fa-sort-numeric-up mr-2"></i>จำนวน
        </label>
        <div class="flex items-center space-x-4">
          <button onclick="adjustOptionsQuantity(-1)" class="w-12 h-12 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-xl transition">
            <i class="fas fa-minus"></i>
          </button>
          <input
            type="number"
            id="optionsQuantity"
            value="1"
            min="1"
            class="w-24 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg py-2"
            onchange="updateOptionsPrice()">
          <button onclick="adjustOptionsQuantity(1)" class="w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-xl transition">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Footer Actions -->
    <div class="border-t border-gray-200 p-4 bg-gray-50">
      <div class="flex space-x-3">
        <button onclick="closeProductOptionsModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-lg font-bold transition">
          <i class="fas fa-times mr-2"></i>ยกเลิก
        </button>
        <button onclick="confirmAddToCart()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white py-3 rounded-lg font-bold transition">
          <i class="fas fa-cart-plus mr-2"></i>เพิ่มลงตะกร้า
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Combo Selection Modal -->
<div id="comboModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50" style="display:none;">
  <div class="rounded-lg max-w-3xl" style="background: var(--card-bg); w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-teal-600 text-white p-6">
      <div class="flex justify-between items-start">
        <div>
          <h2 class="text-2xl font-bold"><i class="fas fa-layer-group mr-2"></i>เลือกคอมโบเซ็ต</h2>
          <p class="text-sm opacity-90 mt-1" id="comboProductName">-</p>
        </div>
        <button onclick="closeComboModal()" class="text-white hover:text-gray-200 text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto flex-1">
      <!-- Combo Price Display -->
      <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-6">
        <div class="flex justify-between items-center">
          <span class="text-gray-700 font-medium">ราคาคอมโบ:</span>
          <span id="comboCurrentPrice" class="text-3xl font-bold text-green-600">฿0.00</span>
        </div>
      </div>

      <!-- Combo Items Selection -->
      <div id="comboItemsSections" class="space-y-6">
        <!-- Combo items will be loaded dynamically -->
      </div>

      <!-- Combo Notes -->
      <div class="mt-6">
        <label class="block font-bold text-gray-700 mb-2">
          <i class="fas fa-comment mr-2"></i>หมายเหตุ
        </label>
        <textarea
          id="comboNotes"
          rows="2"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          placeholder="หมายเหตุเพิ่มเติมสำหรับคอมโบ"></textarea>
      </div>
    </div>

    <!-- Footer Actions -->
    <div class="border-t border-gray-200 p-4 bg-gray-50">
      <div class="flex space-x-3">
        <button onclick="closeComboModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-lg font-bold transition">
          <i class="fas fa-times mr-2"></i>ยกเลิก
        </button>
        <button onclick="confirmAddComboToCart()" class="flex-1 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white py-3 rounded-lg font-bold transition">
          <i class="fas fa-cart-plus mr-2"></i>เพิ่มคอมโบ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Success Modal -->
<div id="checkoutSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50" style="display:none;">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="bg-gradient-to-r from-green-500 to-green-700 text-white p-6 rounded-t-lg text-center">
      <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check text-5xl text-green-500"></i>
      </div>
      <h2 class="text-2xl font-bold">บันทึกรายการสำเร็จ!</h2>
      <p class="mt-2 opacity-90">Order #<span id="successOrderNumber"></span></p>
      <p class="text-lg font-bold mt-1">รวม ฿<span id="successTotal"></span></p>
    </div>

    <div class="p-6">
      <div class="grid grid-cols-2 gap-3">
        <button onclick="printReceipt()" class="bg-purple-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-purple-700 transition">
          <i class="fas fa-print mr-2"></i>พิมพ์ใบเสร็จ
        </button>
        <button onclick="closeCheckoutSuccess()" class="bg-gray-200 text-gray-800 py-3 px-4 rounded-lg font-bold hover:bg-gray-300 transition">
          <i class="fas fa-times mr-2"></i>ปิด
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Split Modal -->
<div id="paymentSplitModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50" style="display:none;">
  <div class="bg-white rounded-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-lg sticky top-0">
      <h2 class="text-xl font-bold">
        <i class="fas fa-money-check-alt mr-2"></i>แบ่งชำระเงิน
      </h2>
      <p class="text-sm opacity-90 mt-1">ยอดที่ต้องชำระ: ฿<span id="splitTotalAmount">0.00</span></p>
    </div>

    <!-- Body -->
    <div class="p-4">
      <!-- Payment Methods -->
      <div class="space-y-3 mb-4">
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <label class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <input type="checkbox" id="splitCash" class="mr-3 w-4 h-4 text-blue-600" onchange="toggleSplitMethod('cash')">
              <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
              <span class="font-medium">เงินสด</span>
            </div>
          </label>
          <input
            type="number"
            id="splitCashAmount"
            placeholder="จำนวนเงิน"
            min="0"
            step="0.01"
            disabled
            oninput="calculateSplitRemaining()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100">
        </div>

        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <label class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <input type="checkbox" id="splitTransfer" class="mr-3 w-4 h-4 text-blue-600" onchange="toggleSplitMethod('transfer')">
              <i class="fas fa-exchange-alt text-blue-600 mr-2"></i>
              <span class="font-medium">โอนเงิน</span>
            </div>
          </label>
          <input
            type="number"
            id="splitTransferAmount"
            placeholder="จำนวนเงิน"
            min="0"
            step="0.01"
            disabled
            oninput="calculateSplitRemaining()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100">
        </div>

        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <label class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <input type="checkbox" id="splitQR" class="mr-3 w-4 h-4 text-blue-600" onchange="toggleSplitMethod('qr')">
              <i class="fas fa-qrcode text-purple-600 mr-2"></i>
              <span class="font-medium">QR Code</span>
            </div>
          </label>
          <input
            type="number"
            id="splitQRAmount"
            placeholder="จำนวนเงิน"
            min="0"
            step="0.01"
            disabled
            oninput="calculateSplitRemaining()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100">
        </div>

        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <label class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <input type="checkbox" id="splitCredit" class="mr-3 w-4 h-4 text-blue-600" onchange="toggleSplitMethod('credit')">
              <i class="fas fa-credit-card text-orange-600 mr-2"></i>
              <span class="font-medium">บัตรเครดิต</span>
            </div>
          </label>
          <input
            type="number"
            id="splitCreditAmount"
            placeholder="จำนวนเงิน"
            min="0"
            step="0.01"
            disabled
            oninput="calculateSplitRemaining()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100">
        </div>
      </div>

      <!-- Summary -->
      <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200 space-y-2">
        <div class="flex justify-between text-sm">
          <span class="text-gray-700" style="color: var(--text-primary);">ยอดที่ต้องชำระ:</span>
          <span class="font-bold text-gray-800">฿<span id="splitTotalAmount2">0.00</span></span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-700" style="color: var(--text-primary);">ชำระแล้ว:</span>
          <span class="font-bold text-blue-600">฿<span id="splitPaidAmount">0.00</span></span>
        </div>
        <div class="flex justify-between border-t pt-2">
          <span class="font-bold text-gray-700">คงเหลือ:</span>
          <span id="splitRemainingAmount" class="font-bold text-lg text-red-600">฿0.00</span>
        </div>
        <div id="splitChangeSection" class="flex justify-between pt-2 border-t" style="display:none;">
          <span class="font-bold text-gray-700">เงินทอน:</span>
          <span id="splitChangeAmount" class="font-bold text-lg text-green-600">฿0.00</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="border-t border-gray-200 p-4 bg-gray-50 flex space-x-3">
      <button onclick="closePaymentSplit()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 rounded-lg font-bold transition">
        <i class="fas fa-times mr-2"></i>ยกเลิก
      </button>
      <button onclick="confirmPaymentSplit()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-3 rounded-lg font-bold transition">
        <i class="fas fa-check-circle mr-2"></i>ยืนยันชำระเงิน
      </button>
    </div>
  </div>
</div>

<!-- Receipt Print Modal -->
<div id="receiptPrintModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 overflow-auto" style="display:none;">
  <div class="bg-white rounded-lg max-w-4xl w-full mx-4 my-8">
    <!-- Header -->
    <div class="bg-gray-800 text-white p-4 flex justify-between items-center rounded-t-lg">
      <div class="flex items-center space-x-4">
        <h2 class="text-xl font-bold"><i class="fas fa-receipt mr-2"></i>ใบเสร็จรับเงิน</h2>
        <select id="paperSize" onchange="updateReceiptSize()" class="bg-gray-700 text-white px-3 py-1 rounded">
          <option value="a4">กระดาษ A4 (210x297mm)</option>
          <option value="thermal-80">กระดาษความร้อน 80mm</option>
          <option value="thermal-58">กระดาษความร้อน 58mm</option>
        </select>
      </div>
      <div class="flex items-center space-x-2">
        <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          <i class="fas fa-print mr-2"></i>พิมพ์
        </button>
        <button onclick="closeReceiptPrint()" class="text-white hover:text-gray-300">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
    </div>

    <!-- Receipt Preview -->
    <div class="p-6 bg-gray-100">
      <div id="receiptContent" class="bg-white mx-auto shadow-lg" style="width: 210mm; min-height: 297mm;">
        <!-- Receipt will be rendered here -->
      </div>
    </div>
  </div>
</div>


<div id="moreMenuModal" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end" style="display:none;" onclick="closeMoreMenu()">
  
  <div 
    id="moreMenuContent"
    class="w-full bg-white rounded-t-2xl shadow-lg p-4 transition-transform duration-300 ease-out translate-y-full" 
    onclick="event.stopPropagation()">
    
    <div class="w-20 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>

    <div class="grid grid-cols-3 gap-4 text-center">

      <button onclick="showPageAndCloseMenu('materials')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-warehouse text-3xl text-blue-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">วัตถุดิบ</span>
      </button>

      <button onclick="showPageAndCloseMenu('products')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-box text-3xl text-teal-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">สินค้า</span>
    </button>

      <button onclick="showPageAndCloseMenu('costs')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-money-bill text-3xl text-red-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">ค่าใช้จ่าย</span>
      </button>

      <button onclick="showPageAndCloseMenu('sales-history')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-history text-3xl text-purple-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">ประวัติการขาย</span>
      </button>

      <button onclick="showPageAndCloseMenu('reports')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-file-alt text-3xl text-green-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">รายงาน</span>
      </button>

      <button onclick="showPageAndCloseMenu('settings')" class="flex flex-col items-center p-3 rounded-lg hover:bg-gray-100 transition">
        <i class="fas fa-cog text-3xl text-gray-600 mb-2"></i>
        <span class="text-xs font-medium text-gray-700">ตั้งค่า</span>
      </button>

      <button onclick="closeMoreMenu()" class="flex flex-col items-center p-3 rounded-lg hover:bg-red-100 transition">
        <i class="fas fa-times text-3xl text-red-500 mb-2"></i>
        <span class="text-xs font-medium text-red-700">ปิด</span>
      </button>

    </div>
  </div>
</div>


<div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="p-4 border-b" style="background: rgba(99, 102, 241, 0.1); border-color: var(--border-color);">
      <div class="flex justify-between items-center">
        <h2 id="productModalTitle" class="text-xl font-bold">
          <i class="fas fa-box mr-2"></i>เพิ่มสินค้า
        </h2>
        <button onclick="closeProductModal()" class="text-white hover:text-red-400 text-2xl transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <form id="productForm" onsubmit="saveProduct(event)" class="p-6 overflow-y-auto space-y-4">
      
      <input type="hidden" id="modalProductId">

      <div>
        <label class="block font-bold mb-2" for="modalProductName">ชื่อสินค้า</label>
        <input 
          type="text" 
          id="modalProductName" 
          class="w-full px-4 py-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" 
          required>
      </div>
      
      <div>
        <label class="block font-bold mb-2" for="modalCategory">หมวดหมู่ (เลือก หรือ พิมพ์ใหม่)</label>
        <input 
          type="text" 
          id="modalCategory" 
          list="categoryDatalist"
          class="w-full px-4 py-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" 
          placeholder="เช่น Hot Coffee, Bakery">
        
        <datalist id="categoryDatalist">
          </datalist>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-bold mb-2" for="modalPrice">ราคา (บาท)</label>
          <input
            type="number"
            step="0.01"
            min="0"
            id="modalPrice"
            class="w-full px-4 py-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
            required>
        </div>
        <div>
          <label class="block font-bold mb-2" for="modalCost">ต้นทุน (บาท)</label>
          <input
            type="number"
            step="0.01"
            min="0"
            id="modalCost"
            class="w-full px-4 py-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="0.00"
            readonly>
          <p class="text-xs mt-1 opacity-70">คำนวณอัตโนมัติจากวัตถุดิบ</p>
        </div>
      </div>

      <!-- วัตถุดิบที่ใช้ -->
      <div class="border-t pt-4" style="border-color: var(--border-color);">
        <label class="block font-bold mb-3">
          <i class="fas fa-list-ul mr-2"></i>วัตถุดิบที่ใช้
        </label>
        <div id="productMaterials" class="space-y-2">
          <div id="materialsList" class="space-y-2 mb-3">
            <!-- Material rows will be added here -->
          </div>
          <button
            type="button"
            onclick="addMaterialToProduct()"
            class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition font-bold">
            <i class="fas fa-plus mr-2"></i>เพิ่มวัตถุดิบ
          </button>
        </div>
      </div>

      <div class="flex justify-end space-x-3 pt-4">
        <button 
          type="button" 
          onclick="closeProductModal()" 
          class="px-6 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg font-bold transition">
          ยกเลิก
        </button>
        <button 
          type="submit" 
          class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-bold transition">
          <i class="fas fa-save mr-2"></i>บันทึก
        </button>
      </div>
    </form>
    
  </div>
</div>

<div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="p-4 border-b" style="background: rgba(99, 102, 241, 0.1); border-color: var(--border-color);">
      <div class="flex justify-between items-center">
        <h2 id="recipeModalTitle" class="text-xl font-bold">
          <i class="fas fa-book mr-2"></i>เพิ่ม/แก้ไขสูตร
        </h2>
        <button onclick="closeRecipeModal()" class="text-white hover:text-red-400 text-2xl transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="p-6 overflow-y-auto space-y-4 flex-1">
      
      <div>
        <label class="block font-bold mb-2" for="modalRecipeProductSelect">สินค้า (เจ้าของสูตร)</label>
        <select 
          id="modalRecipeProductSelect" 
          onchange="handleProductSelectChange(this.value)"
          class="w-full p-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
          <option value="" class="text-black">กำลังโหลด...</option>
        </select>
      </div>
      
      <div>
        <label class="block font-bold mb-2">วัตถุดิบในสูตรนี้</label>
        <div id="modalRecipeListContainer" class="space-y-2 max-h-40 overflow-y-auto bg-black/20 p-3 rounded-lg">
          <p class="text-center text-white/70 p-4">กรุณาเลือกสินค้า...</p>
        </div>
      </div>
      
      <div class="bg-white/10 p-4 rounded-lg space-y-3">
        <p class="font-bold">เพิ่มวัตถุดิบใหม่</p>
        <div>
          <label class="block text-sm mb-1">เลือกวัตถุดิบ</label>
          <select id="modalRecipeMaterialSelect" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 focus:border-white focus:ring-0 outline-none transition text-white" disabled>
            <option value="" class="text-black">...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">จำนวน (ตามหน่วย)</label>
          <input type="number" step="0.01" min="0" id="modalRecipeQtyInput" class="w-full p-3 rounded-lg border-2 outline-none transition" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" placeholder="เช่น 18 (g)" disabled>
        </div>
        <button id="modalRecipeAddButton" onclick="addRecipeItem()" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition opacity-50 cursor-not-allowed" disabled>
          <i class="fas fa-plus mr-2"></i>เพิ่มลงสูตร
        </button>
      </div>

    </div> <div class="flex justify-end p-4 border-t" style="background: rgba(99, 102, 241, 0.1); border-color: var(--border-color);">
      <button 
        type="button" 
        onclick="closeRecipeModal()" 
        class="px-6 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg font-bold transition text-white">
        ปิด
      </button>
    </div>

  </div>
</div>


<div id="categoryManageModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="bg-white/10 p-4 border-b border-white/20 flex justify-between items-center">
      <h2 class="text-xl font-bold"><i class="fas fa-tags mr-2"></i>จัดการหมวดหมู่</h2>
      <button onclick="closeManageCategoriesModal()" class="text-white hover:text-red-400 text-2xl transition"><i class="fas fa-times"></i></button>
    </div>

    <div class="p-6 overflow-y-auto space-y-6 flex-1">
      
      <div class="bg-white/10 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3">แก้ไขชื่อหมวดหมู่</h3>
        <form id="categoryRenameForm" onsubmit="handleRenameCategory(event)" class="space-y-3">
          <div>
            <label class="block text-sm mb-1" for="categoryRenameSelect">เลือกหมวดหมู่ที่จะแก้ไข</label>
            <select id="categoryRenameSelect" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white">
              <option value="" class="text-black">กำลังโหลด...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1" for="categoryNewNameInput">ชื่อใหม่</label>
            <input type="text" id="categoryNewNameInput" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" placeholder="เช่น เครื่องดื่มร้อน" required>
          </div>
          <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition">
            <i class="fas fa-edit mr-2"></i>เปลี่ยนชื่อ
          </button>
        </form>
      </div>

      <div class="bg-red-900/30 border border-red-400 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3 text-red-300">ลบหมวดหมู่</h3>
        <p class="text-sm text-white/80 mb-3">การลบหมวดหมู่ จะทำให้สินค้าที่ใช้หมวดหมู่นี้ถูกตั้งค่าเป็น "ไม่มีหมวดหมู่" (จะไม่ลบตัวสินค้า)</p>
        <form id="categoryDeleteForm" onsubmit="handleDeleteCategory(event)" class="space-y-3">
          <div>
            <label class="block text-sm mb-1" for="categoryDeleteSelect">เลือกหมวดหมู่ที่จะลบ</label>
            <select id="categoryDeleteSelect" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
              <option value="" class="text-black">กำลังโหลด...</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-red-500 hover:bg-red-600 p-3 rounded-lg font-bold transition">
            <i class="fas fa-trash mr-2"></i>ยืนยันการลบ
          </button>
        </form>
      </div>

    </div> 
    </div>
</div>


<div id="purchaseModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="p-4 border-b" style="background: rgba(99, 102, 241, 0.1); border-color: var(--border-color);">
      <h2 class="text-xl font-bold"><i class="fas fa-truck-loading mr-2"></i>รับของเข้าสต็อก (สั่งซื้อ)</h2>
    </div>

    <form id="purchaseForm" onsubmit="savePurchase(event)" class="p-6 overflow-y-auto space-y-4">
      <div>
        <label class="block font-bold mb-2" for="purchaseMaterialSelect">วัตถุดิบ</label>
        <select id="purchaseMaterialSelect" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" required>
          <option value="" class="text-black">กำลังโหลด...</option>
        </select>
      </div>
      <div>
        <label class="block font-bold mb-2" for="purchaseQty">จำนวนที่รับเข้า</label>
        <input type="number" step="0.01" min="0.01" id="purchaseQty" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" required>
      </div>
      
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" onclick="closePurchaseModal()" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg font-bold transition">ยกเลิก</button>
        <button type="submit" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-bold transition">บันทึกรับเข้า</button>
      </div>
    </form>
  </div>
</div>


<div id="comboManageModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="bg-white/10 p-4 border-b border-white/20 flex justify-between items-center">
      <h2 class="text-xl font-bold"><i class="fas fa-layer-group mr-2"></i>จัดการ Combo Sets</h2>
      <button onclick="closeManageCombosModal()" class="text-white hover:text-red-400 text-2xl transition"><i class="fas fa-times"></i></button>
    </div>

    <div class="flex-1 flex overflow-hidden">
      
      <div class="w-1/3 overflow-y-auto bg-black/10 p-4 border-r border-white/20">
        <button onclick="showAddComboForm()" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold transition mb-4">
          <i class="fas fa-plus mr-2"></i>สร้าง Combo ใหม่
        </button>
        <div id="comboListContainer" class="space-y-2">
          </div>
      </div>
      
      <div id="comboDetailsContainer" class="w-2/3 overflow-y-auto p-6 space-y-4">
        <p class="text-center text-white/70 p-8">กรุณาเลือก Combo หรือ "สร้าง Combo ใหม่"</p>
        </div>
    </div>
    
  </div>
</div>

<div id="optionsManageModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="bg-white/10 p-4 border-b border-white/20 flex justify-between items-center">
      <h2 class="text-xl font-bold"><i class="fas fa-sliders-h mr-2"></i>จัดการตัวเลือก (Options)</h2>
      <button onclick="closeManageOptionsModal()" class="text-white hover:text-red-400 text-2xl transition"><i class="fas fa-times"></i></button>
    </div>

    <div class="flex-1 flex overflow-hidden">
      
      <div class="w-1/3 overflow-y-auto bg-black/10 p-4 border-r border-white/20">
        <button onclick="showAddOptionGroupForm()" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold transition mb-4">
          <i class="fas fa-plus mr-2"></i>สร้างกลุ่มใหม่
        </button>
        <div id="optionGroupListContainer" class="space-y-2">
          </div>
      </div>
      
      <div id="optionDetailsContainer" class="w-2/3 overflow-y-auto p-6 space-y-4">
        <p class="text-center text-white/70 p-8">กรุณาเลือกกลุ่ม (เช่น "ขนาด", "ความหวาน")</p>
        </div>
    </div>
    
  </div>
</div>


<div id="wasteModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm modal-backdrop flex items-center justify-center z-50 p-4" style="display:none;">
  <div class="rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col" style="background: var(--card-bg); color: var(--text-primary);">
    
    <div class="p-4 border-b" style="background: rgba(99, 102, 241, 0.1); border-color: var(--border-color);">
      <h2 class="text-xl font-bold"><i class="fas fa-dumpster-fire mr-2"></i>บันทึกของเสีย</h2>
    </div>

    <form id="wasteForm" onsubmit="saveWaste(event)" class="p-6 overflow-y-auto space-y-4">
      <div>
        <label class="block font-bold mb-2" for="wasteMaterialSelect">วัตถุดิบ</label>
        <select id="wasteMaterialSelect" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" required>
          <option value="" class="text-black">กำลังโหลด...</option>
        </select>
      </div>
      <div>
        <label class="block font-bold mb-2" for="wasteQty">จำนวนที่เสีย</label>
        <input type="number" step="0.01" min="0.01" id="wasteQty" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" required>
      </div>
      <div>
        <label class="block font-bold mb-2" for="wasteReason">เหตุผล (เช่น หมดอายุ, ตกหล่น)</label>
        <input type="text" id="wasteReason" class="w-full p-3 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" placeholder="เช่น หมดอายุ" required>
      </div>
      
      <div class="flex justify-end space-x-3 pt-4">
        <button type="button" onclick="closeWasteModal()" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 rounded-lg font-bold transition">ยกเลิก</button>
        <button type="submit" class="px-6 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-bold transition">บันทึกของเสีย</button>
      </div>
    </form>
  </div>
</div>

<!-- Main Container -->
<div id="mainApp" style="display:none;" class="pb-20 md:pb-0">

<!-- Dashboard Page -->
<div id="page-dashboard" class="page active container mx-auto p-4 max-w-7xl">
  <h1 class="text-3xl font-bold text-white mb-6"><i class="fas fa-chart-line mr-2"></i>Dashboard</h1>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="card-modern p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">รายรับวันนี้</p>
          <p class="text-3xl font-bold text-green-600" id="dashRevenue">0</p>
        </div>
        <i class="fas fa-dollar-sign text-4xl text-green-200"></i>
      </div>
    </div>
    <div class="card-modern p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">ต้นทุนรวม</p>
          <p class="text-3xl font-bold text-red-600" id="dashCost">0</p>
        </div>
        <i class="fas fa-money-bill text-4xl text-red-200"></i>
      </div>
    </div>
    <div class="card-modern p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">กำไรสุทธิ</p>
          <p class="text-3xl font-bold text-blue-600" id="dashProfit">0</p>
        </div>
        <i class="fas fa-chart-line text-4xl text-blue-200"></i>
      </div>
    </div>
    <div class="card-modern p-6 card-hover">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">สินค้าที่ขายได้</p>
          <p class="text-3xl font-bold text-purple-600" id="dashItems">0</p>
        </div>
        <i class="fas fa-shopping-cart text-4xl text-purple-200"></i>
      </div>
    </div>
  </div>
  <div class="card-modern p-6">
    <h3 class="text-xl font-bold mb-4">สินค้าขายดี 5 อันดับ</h3>
    <div id="topProducts"></div>
  </div>
</div>

<!-- Sales/POS Page -->
<!-- Sales (POS) Page - Modern Design -->
<div id="page-sales" class="page container mx-auto p-4 max-w-7xl">
  <!-- Header Section -->
  <div class="mb-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-white mb-2">
          <i class="fas fa-cash-register mr-2"></i>Point of Sale
        </h1>
        <p class="text-white opacity-80">ขายหน้าร้าน - รวดเร็วและง่ายดาย</p>
      </div>
      <div class="mt-4 md:mt-0 flex items-center space-x-3">
        <!-- Order Channel Selector -->
        <div class="bg-white px-4 py-2 rounded-lg shadow-lg">
          <div class="text-xs text-gray-500 mb-1">ช่องทางการสั่งซื้อ</div>
          <select
            id="orderChannelSelect"
            onchange="onChannelChange()"
            class="text-sm font-medium text-gray-800 border-none focus:ring-0 cursor-pointer">
            <option value="">กำลังโหลด...</option>
          </select>
        </div>

        <!-- Order Number Display/Input -->
        <div class="bg-white px-4 py-2 rounded-lg shadow-lg">
          <div class="text-xs text-gray-500">Order Number</div>
          <div id="orderNumberDisplay" class="text-lg font-bold text-purple-600">-</div>
          <input
            type="text"
            id="orderNumberInput"
            placeholder="กรอกหมายเลข Order"
            class="text-lg font-bold text-purple-600 border-b-2 border-purple-300 focus:outline-none focus:border-purple-500 w-40"
            style="display:none;">
        </div>

        <button onclick="clearCart()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg transition">
          <i class="fas fa-trash mr-2"></i>Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Main Grid: Products + Cart -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left Side: Product Grid (2/3 width) -->
    <div class="lg:col-span-2 space-y-4">

      <!-- Search & Category Filter -->
      <div class="bg-white rounded-lg shadow-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
            <input
              type="text"
              id="searchProduct"
              placeholder="ค้นหาสินค้า... (ชื่อ, รหัส)"
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
              onkeyup="debouncedSearch()">
          </div>

<div class="relative">
            <i class="fas fa-filter absolute left-3 top-3.5 text-gray-400"></i>
            <select
              id="categoryFilter"
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
              onchange="filterByCategory()">
              
              <option value="">ทุกหมวดหมู่</option>
              </select>
          </div>

        </div>
      </div>

      <!-- Product Grid -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">
            <i class="fas fa-th mr-2 text-purple-600"></i>สินค้าทั้งหมด
          </h3>
          <div class="text-sm text-gray-500">
            <span id="productCount">0</span> รายการ
          </div>
        </div>

        <!-- Product Cards Grid -->
        <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
          <!-- Products will be loaded here dynamically -->
          <div class="col-span-full text-center py-12 text-gray-400">
            <i class="fas fa-box-open text-5xl mb-3"></i>
            <p>กำลังโหลดสินค้า...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side: Cart/Order Summary (1/3 width) -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-lg sticky top-4 overflow-hidden">

        <!-- Cart Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4">
          <h3 class="text-xl font-bold">
            <i class="fas fa-shopping-cart mr-2"></i>รายการสั่งซื้อ
          </h3>
          <p class="text-sm opacity-90 mt-1">
            <span id="cartItemCount">0</span> รายการ
          </p>
        </div>

        <!-- Cart Items -->
        <div id="cartItems" class="p-4 max-h-96 overflow-y-auto min-h-[200px] bg-gray-50">
          <div class="text-center py-12 text-gray-400">
            <i class="fas fa-shopping-basket text-5xl mb-3 opacity-50"></i>
            <p class="text-sm">ยังไม่มีรายการ</p>
            <p class="text-xs mt-1">เลือกสินค้าเพื่อเริ่มสั่งซื้อ</p>
          </div>
        </div>

        <!-- Discount Control Section -->
        <div class="border-t border-gray-200 p-4 bg-gradient-to-r from-orange-50 to-yellow-50">
          <div class="flex items-center justify-between mb-3">
            <label class="font-bold text-gray-700 text-sm">
              <i class="fas fa-tags mr-2 text-orange-600"></i>ส่วนลด
            </label>
            <button
              onclick="clearDiscount()"
              id="clearDiscountBtn"
              class="text-xs text-red-600 hover:text-red-800 font-medium"
              style="display:none;">
              <i class="fas fa-times-circle mr-1"></i>ล้างส่วนลด
            </button>
          </div>

          <!-- Discount Preset Buttons -->
          <div id="discountPresets" class="grid grid-cols-3 gap-2 mb-3">
            <!-- Loaded dynamically -->
          </div>

          <!-- Custom Discount Input -->
          <div class="flex space-x-2">
            <div class="flex-1">
              <input
                type="number"
                id="discountValue"
                placeholder="จำนวน"
                min="0"
                step="0.01"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
            </div>
            <select
              id="discountType"
              class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
              <option value="percent">%</option>
              <option value="amount">฿</option>
            </select>
            <button
              onclick="applyCustomDiscount()"
              class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>

        <!-- Subtotal, Discount, Tax Section -->
        <div class="border-t border-gray-200 p-4 bg-white space-y-2">
          <div class="flex justify-between text-sm text-gray-600">
            <span>ยอดรวม:</span>
            <span id="cartSubtotal">฿0.00</span>
          </div>
          <div class="flex justify-between text-sm font-medium">
            <span class="text-orange-600">ส่วนลด:</span>
            <span id="cartDiscount" class="text-orange-600">- ฿0.00</span>
          </div>
        </div>

        <!-- Grand Total -->
        <div class="border-t-2 border-purple-200 bg-purple-50 p-4">
          <div class="flex justify-between items-center">
            <span class="text-lg font-bold text-gray-700">ยอดชำระทั้งหมด:</span>
            <span id="cartTotal" class="text-2xl font-bold text-purple-600">฿0.00</span>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="border-t border-gray-200 p-4 bg-white">
          <label class="block font-bold text-gray-700 mb-3 text-sm">
            <i class="fas fa-credit-card mr-2"></i>วิธีการชำระเงิน:
          </label>
          <div class="space-y-2">
            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-purple-50 transition">
              <input type="checkbox" value="cash" class="mr-3 payment-method w-4 h-4 text-purple-600" onchange="handlePaymentMethodChange()">
              <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
              <span class="text-sm">เงินสด</span>
            </label>
            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-purple-50 transition">
              <input type="checkbox" value="transfer" class="mr-3 payment-method w-4 h-4 text-purple-600" onchange="handlePaymentMethodChange()">
              <i class="fas fa-exchange-alt text-blue-600 mr-2"></i>
              <span class="text-sm">โอนเงิน</span>
            </label>
            <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-purple-50 transition">
              <input type="checkbox" value="qr" class="mr-3 payment-method w-4 h-4 text-purple-600" onchange="toggleQR(); handlePaymentMethodChange();">
              <i class="fas fa-qrcode text-purple-600 mr-2"></i>
              <span class="text-sm">QR Code</span>
            </label>
          </div>
          <div id="qrSection" style="display:none;" class="mt-4 text-center">
            <img id="qrImage" class="w-full max-w-xs mx-auto rounded-lg shadow-md">
          </div>

          <!-- Slip Upload Section -->
          <div id="slipUploadSection" style="display:none;" class="mt-4 p-4 border-t border-gray-200">
            <label class="block font-bold text-gray-700 mb-3 text-sm">
              <i class="fas fa-receipt mr-2"></i>อัพโหลดสลิปการโอนเงิน:
            </label>
            <div class="flex gap-2 mb-3">
              <label class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg cursor-pointer text-center transition font-medium">
                <i class="fas fa-paperclip mr-2"></i>แนบไฟล์
                <input type="file" id="slipFileInput" accept="image/*" style="display:none;" onchange="previewSlip(this)">
              </label>
              <label class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg cursor-pointer text-center transition font-medium">
                <i class="fas fa-camera mr-2"></i>ถ่ายสลิป
                <input type="file" id="slipCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="previewSlip(this)">
              </label>
            </div>
            <div id="slipPreview" class="mt-2 text-center">
              <!-- Preview image will appear here -->
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="p-4 bg-gray-50 border-t border-gray-200 space-y-2">
          <button
            onclick="checkout()"
            class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white py-4 rounded-lg font-bold text-lg shadow-lg transition transform hover:scale-105">
            <i class="fas fa-check-circle mr-2"></i>ชำระเงิน
          </button>
          <button
            onclick="openPaymentSplit()"
            class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-3 rounded-lg font-bold shadow-md transition">
            <i class="fas fa-money-check-alt mr-2"></i>แบ่งชำระเงิน
          </button>
          <button
            onclick="holdOrder()"
            class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white py-3 rounded-lg font-bold shadow-md transition">
            <i class="fas fa-pause-circle mr-2"></i>พักออเดอร์
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sales History Page -->
<div id="page-sales-history" class="page" style="display:none;">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">
      <i class="fas fa-history mr-3"></i>ประวัติการขาย
    </h1>

    <!-- Graphs Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- กราฟยอดขายรายเดือนในปีปัจจุบัน -->
      <div class="rounded-lg shadow-lg p-6" style="background: var(--card-bg);">
        <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
          <i class="fas fa-chart-bar mr-2"></i>ยอดขายรายเดือน (ปี <span id="currentYear"></span>)
        </h2>
        <canvas id="monthlySalesChart"></canvas>
      </div>

      <!-- กราฟยอดขายรายวันในเดือนปัจจุบัน -->
      <div class="rounded-lg shadow-lg p-6" style="background: var(--card-bg);">
        <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
          <i class="fas fa-chart-line mr-2"></i>ยอดขายรายวัน (<span id="currentMonth"></span>)
        </h2>
        <canvas id="dailySalesChart"></canvas>
      </div>
    </div>

    <!-- Date Range Filter -->
    <div class="rounded-lg shadow-lg p-6 mb-6" style="background: var(--card-bg);">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
        <i class="fas fa-filter mr-2"></i>ตัวกรองข้อมูล
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block font-medium mb-2" style="color: var(--text-primary);">วันที่เริ่มต้น</label>
          <input type="date" id="startDate" class="w-full px-4 py-2 border rounded-lg"
                 style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                 onchange="filterSalesHistory()">
        </div>
        <div>
          <label class="block font-medium mb-2" style="color: var(--text-primary);">วันที่สิ้นสุด</label>
          <input type="date" id="endDate" class="w-full px-4 py-2 border rounded-lg"
                 style="background: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);"
                 onchange="filterSalesHistory()">
        </div>
        <div class="flex items-end">
          <button onclick="resetDateFilter()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold">
            <i class="fas fa-redo mr-2"></i>รีเซ็ต
          </button>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="rounded-lg shadow-lg p-6 text-center" style="background: var(--card-bg);">
        <div class="text-gray-500 mb-2">ยอดขายรวม</div>
        <div class="text-3xl font-bold text-green-600" id="totalSales">฿0.00</div>
      </div>
      <div class="rounded-lg shadow-lg p-6 text-center" style="background: var(--card-bg);">
        <div class="text-gray-500 mb-2">จำนวนออเดอร์</div>
        <div class="text-3xl font-bold text-blue-600" id="totalOrders">0</div>
      </div>
      <div class="rounded-lg shadow-lg p-6 text-center" style="background: var(--card-bg);">
        <div class="text-gray-500 mb-2">ค่าเฉลี่ยต่อออเดอร์</div>
        <div class="text-3xl font-bold text-purple-600" id="avgOrderValue">฿0.00</div>
      </div>
      <div class="rounded-lg shadow-lg p-6 text-center" style="background: var(--card-bg);">
        <div class="text-gray-500 mb-2">เมนูขายดี</div>
        <div class="text-lg font-bold text-orange-600" id="topProduct">-</div>
      </div>
    </div>

    <!-- Sales Table -->
    <div class="rounded-lg shadow-lg p-6 mb-6" style="background: var(--card-bg);">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
        <i class="fas fa-table mr-2"></i>รายการขายทั้งหมด
      </h2>
      <div class="overflow-x-auto">
        <table class="w-full min-w-[800px]" id="salesHistoryTable">
          <thead>
            <tr style="background: var(--bg-secondary);">
              <th class="px-4 py-3 text-left cursor-pointer" onclick="sortSalesTable('date')">
                <i class="fas fa-sort mr-1"></i>วันที่/เวลา
              </th>
              <th class="px-4 py-3 text-left cursor-pointer" onclick="sortSalesTable('orderId')">
                <i class="fas fa-sort mr-1"></i>เลขที่ออเดอร์
              </th>
              <th class="px-4 py-3 text-left">รายการสินค้า</th>
              <th class="px-4 py-3 text-right cursor-pointer" onclick="sortSalesTable('total')">
                <i class="fas fa-sort mr-1"></i>ยอดขาย
              </th>
              <th class="px-4 py-3 text-center">การชำระเงิน</th>
              <th class="px-4 py-3 text-center">สลิป</th>
              <th class="px-4 py-3 text-center">การดำเนินการ</th>
            </tr>
          </thead>
          <tbody id="salesHistoryTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Products Section -->
    <div class="rounded-lg shadow-lg p-6" style="background: var(--card-bg);">
      <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
        <i class="fas fa-trophy mr-2"></i>เมนูขายดี (Top 10)
      </h2>
      <div id="topProductsList"></div>
    </div>
  </div>
</div>

<!-- Products Page -->
<div id="page-products" class="page container mx-auto p-4 max-w-7xl">
  
<div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <h1 class="text-3xl font-bold text-white"><i class="fas fa-box mr-2"></i>สินค้า</h1>
    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3">

      <button onclick="showManageCategoriesModal()" class="text-white px-5 py-3 rounded-lg font-bold transition text-left" style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
        <i class="fas fa-tags mr-2"></i>จัดการหมวดหมู่
      </button>
      <button onclick="showManageOptionsModal()" class="text-white px-5 py-3 rounded-lg font-bold transition text-left" style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
        <i class="fas fa-sliders-h mr-2"></i>จัดการตัวเลือก (Options)
      </button>
      <button onclick="showManageCombosModal()" class="text-white px-5 py-3 rounded-lg font-bold transition text-left" style="background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
        <i class="fas fa-layer-group mr-2"></i>จัดการคอมโบ (Combos)
      </button>

      <button onclick="recalculateCosts()" class="bg-orange-500 text-white px-5 py-3 rounded-lg font-bold hover:bg-orange-600 transition text-left">
        <i class="fas fa-calculator mr-2"></i>คำนวณต้นทุนใหม่
      </button>
      <button onclick="showAddProductModal()" class="bg-green-500 text-white px-5 py-3 rounded-lg font-bold hover:bg-green-600 transition text-left">
        <i class="fas fa-plus mr-2"></i>เพิ่มสินค้า (เดี่ยว)
      </button>
    </div>
  </div>

  <div class="rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">

    <div class="overflow-auto max-h-[70vh] rounded-lg" style="border: 1px solid var(--border-color);">
      <table class="w-full min-w-[700px]" id="productsTable">
        <thead class="sticky top-0" style="background: var(--card-bg); color: var(--text-primary);">
          <tr class="text-left">
            <th class="p-3 font-bold">ชื่อสินค้า</th>
            <th class="p-3 font-bold">หมวดหมู่</th>
            <th class="p-3 font-bold">ราคา</th>
            <th class="p-3 font-bold">ต้นทุน</th>
            <th class="p-3 font-bold">กำไร</th>
            <th class="p-3 font-bold text-center">จัดการ</th>
          </tr>
        </thead>
        <tbody id="productsTableBody" class="text-white">
          <tr>
            <td colspan="6" class="p-8 text-center text-white/70">
              <i class="fas fa-spinner fa-spin text-3xl"></i>
              <p class="mt-2">กำลังโหลดรายการสินค้า...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
  </div>
</div>

<!-- Recipes Page (Hidden - Modal/Functions Still Available) -->
<div id="page-recipes" class="page container mx-auto p-4 max-w-7xl" style="display:none;">
  
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-white"><i class="fas fa-book mr-2"></i>สูตรอาหาร</h1>
    <button onclick="showAddRecipeModal()" class="bg-green-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-600 transition">
      <i class="fas fa-plus mr-2"></i>เพิ่ม/แก้ไขสูตร
    </button>
  </div>

  <div class="rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">

    <div class="overflow-auto max-h-[70vh] rounded-lg" style="border: 1px solid var(--border-color);">
      <table class="w-full min-w-[600px]" id="recipesTable">
        <thead class="sticky top-0" style="background: var(--card-bg); color: var(--text-primary);">
          <tr class="text-left">
            <th class="p-3 font-bold">สินค้า (ที่มีสูตร)</th>
            <th class="p-3 font-bold">จำนวนวัตถุดิบ</th>
            <th class="p-3 font-bold">ต้นทุน (จากสูตร)</th>
            <th class="p-3 font-bold text-center">จัดการสูตร</th>
          </tr>
        </thead>
        <tbody id="recipesTableBody" style="color: var(--text-primary);">
          </tbody>
      </table>
    </div>
    
  </div>
</div>

<!-- Materials Page -->
<div id="page-materials" class="page container mx-auto p-4 max-w-7xl">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-white"><i class="fas fa-warehouse mr-2"></i>วัตถุดิบ</h1>
    <button onclick="showAddMaterialModal()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition font-bold">
      <i class="fas fa-plus mr-2"></i>เพิ่มวัตถุดิบ
    </button>
  </div>

  <!-- Responsive Table Wrapper -->
  <div class="rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">
    <div class="overflow-x-auto rounded-lg" style="border: 1px solid var(--border-color);">
      <table class="w-full min-w-[700px]">
        <thead style="background: var(--card-bg); color: var(--text-primary);">
          <tr class="text-left">
            <th class="p-3 font-bold">รหัสวัตถุดิบ</th>
            <th class="p-3 font-bold">ชื่อวัตถุดิบ</th>
            <th class="p-3 font-bold">หน่วย</th>
            <th class="p-3 font-bold">ราคาต่อหน่วย</th>
            <th class="p-3 font-bold">ผู้จัดจำหน่าย</th>
            <th class="p-3 font-bold text-center">จัดการ</th>
          </tr>
        </thead>
        <tbody id="materialsTableBody" style="color: var(--text-primary);">
          <!-- Table rows will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Costs Page -->
<div id="page-costs" class="page container mx-auto p-4 max-w-7xl">
  <h1 class="text-3xl font-bold text-white mb-6"><i class="fas fa-money-bill mr-2"></i>จัดการค่าใช้จ่าย</h1>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">ค่าใช้จ่ายรายวัน</h3>
        <button onclick="showAddDailyCostModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus"></i></button>
      </div>
      <div id="dailyCostsList"></div>
    </div>
    <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">ค่าใช้จ่ายรายเดือน</h3>
        <button onclick="showAddMonthlyCostModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg"><i class="fas fa-plus"></i></button>
      </div>
      <div id="monthlyCostsList"></div>
    </div>
  </div>
</div>

<!-- Reports Page -->
<div id="page-reports" class="page container mx-auto p-4 max-w-7xl">
  <h1 class="text-3xl font-bold text-white mb-6"><i class="fas fa-file-alt mr-2"></i>รายงาน</h1>
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block font-bold mb-2">วันที่เริ่มต้น</label>
        <input type="date" id="reportStartDate" class="w-full px-4 py-2 border rounded-lg">
      </div>
      <div>
        <label class="block font-bold mb-2">วันที่สิ้นสุด</label>
        <input type="date" id="reportEndDate" class="w-full px-4 py-2 border rounded-lg">
      </div>
      <div class="flex items-end">
        <button onclick="loadReports()" class="w-full bg-purple-600 text-white px-6 py-2 rounded-lg">สร้างรายงาน</button>
      </div>
    </div>
  </div>
  <div id="reportsContent" class="bg-white rounded-lg shadow-lg p-6"></div>
</div>


<div id="page-inventory" class="page container mx-auto p-4 max-w-7xl">
  
  <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
    <h1 class="text-3xl font-bold text-white"><i class="fas fa-boxes mr-2"></i>จัดการสต็อก</h1>
    <div class="flex space-x-3">
      <button onclick="showWasteModal()" class="flex-1 md:flex-none text-white px-5 py-3 rounded-lg font-bold transition bg-red-500/70 border border-red-400 hover:bg-red-500/90">
        <i class="fas fa-dumpster-fire mr-2"></i>บันทึกของเสีย
      </button>
      <button onclick="showPurchaseModal()" class="flex-1 md:flex-none text-white px-5 py-3 rounded-lg font-bold transition bg-green-500/70 border border-green-400 hover:bg-green-500/90">
        <i class="fas fa-truck-loading mr-2"></i>รับของเข้า
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <div class="lg:col-span-2 rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">
      <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">10 อันดับของใกล้หมด</h3>
      <div class="h-64">
        <canvas id="lowStockChart"></canvas>
      </div>
    </div>

    <div class="rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
      <h3 class="text-lg font-bold mb-4">สรุปมูลค่าสต็อก</h3>
      <div class="h-64 flex flex-col justify-center items-center">
        <p class="text-sm opacity-80">มูลค่าสต็อกทั้งหมด</p>
        <p id="totalStockValue" class="text-5xl font-bold my-2">฿0</p>
        <p id="totalOutOfStock" class="text-lg font-bold text-red-400">0 รายการ (ของหมด)</p>
      </div>
    </div>
    
  </div>

  <div class="rounded-lg shadow-lg p-4" style="background: var(--card-bg); border: 1px solid var(--border-color);">
    <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">รายการสต็อกคงคลัง</h3>
    <div class="overflow-auto max-h-[60vh] rounded-lg" style="border: 1px solid var(--border-color);">
      <table class="w-full min-w-[700px]" id="inventoryTable">
        <thead class="sticky top-0" style="background: var(--card-bg); color: var(--text-primary);">
          <tr class="text-left">
            <th class="p-3 font-bold">วัตถุดิบ</th>
            <th class="p-3 font-bold">คงเหลือ</th>
            <th class="p-3 font-bold">ขั้นต่ำ</th>
            <th class="p-3 font-bold">สถานะ</th>
          </tr>
        </thead>
        <tbody id="inventoryTableBody" style="color: var(--text-primary);">
          </tbody>
      </table>
    </div>
  </div>

  <div class="rounded-lg shadow-lg p-4 mt-6" style="background: var(--card-bg); border: 1px solid var(--border-color);">
    <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">ประวัติการเคลื่อนไหว (50 รายการล่าสุด)</h3>
    <div class="overflow-auto max-h-[60vh] rounded-lg" style="border: 1px solid var(--border-color);">
      <table class="w-full min-w-[700px]" id="stockLedgerTable">
        <thead class="sticky top-0" style="background: var(--card-bg); color: var(--text-primary);">
          <tr class="text-left">
            <th class="p-3 font-bold">เวลา</th>
            <th class="p-3 font-bold">วัตถุดิบ</th>
            <th class="p-3 font-bold">จำนวน</th>
            <th class="p-3 font-bold">เหตุผล</th>
            <th class="p-3 font-bold">Order #</th>
          </tr>
        </thead>
        <tbody id="stockLedgerTableBody" class="text-white">
          <tr>
            <td colspan="5" class="p-8 text-center text-white/70">
              <i class="fas fa-spinner fa-spin text-3xl"></i>
              <p class="mt-2">กำลังโหลดประวัติ...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>






</div>

<!-- Settings Page -->
<div id="page-settings" class="page container mx-auto p-4 max-w-7xl">
  <h1 class="text-3xl font-bold text-white mb-6"><i class="fas fa-cog mr-2"></i>ตั้งค่า</h1>

  <!-- First Row: Shop Info & Account -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="card-modern p-6">
      <h3 class="text-xl font-bold mb-4">ข้อมูลร้าน</h3>
      <form onsubmit="saveSettings(event)">
        <div class="mb-4">
          <label class="block font-bold mb-2">ชื่อร้าน</label>
          <input type="text" id="settingShopName" class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-2">หมายเลข PromptPay</label>
          <input type="text" id="settingPromptPay" class="w-full px-4 py-2 border rounded-lg" placeholder="0812345678">
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-2">รูปแบบหมายเลขออเดอร์</label>
          <select id="settingOrderMode" class="w-full px-4 py-2 border rounded-lg">
            <option value="auto">อัตโนมัติ</option>
            <option value="manual">กำหนดเอง</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-2">รูปแบบหมายเลขออเดอร์</label>
          <input type="text" id="settingOrderFormat" class="w-full px-4 py-2 border rounded-lg" placeholder="ORD-{YYYYMMDD}-{###}">
        </div>
        <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg">บันทึกการตั้งค่า</button>
      </form>
    </div>

    <div class="card-modern p-6">
      <h3 class="text-xl font-bold mb-4">บัญชี</h3>
      <button onclick="showLicenseModal()" class="w-full bg-blue-500 text-white py-3 rounded-lg mb-4">
        <i class="fas fa-certificate mr-2"></i>สถานะสิทธิ์การใช้งาน
      </button>
      <button onclick="showChangePasswordModal()" class="w-full bg-orange-500 text-white py-3 rounded-lg mb-4">
        <i class="fas fa-key mr-2"></i>เปลี่ยนรหัสผ่าน
      </button>
      <button onclick="logout()" class="w-full bg-red-500 text-white py-3 rounded-lg">
        <i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ
      </button>
    </div>
  </div>



  <!-- Third Row: Held Orders -->
  <div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">
        <i class="fas fa-pause-circle mr-2 text-orange-600"></i>ออเดอร์ที่พักไว้
      </h3>
      <button onclick="refreshHeldOrders()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm transition">
        <i class="fas fa-sync-alt mr-2"></i>Refresh
      </button>
    </div>
    <div id="heldOrdersList" class="space-y-3">
      <!-- Held orders will be loaded here -->
      <div class="text-center py-8 text-gray-400">
        <i class="fas fa-inbox text-4xl mb-2"></i>
        <p class="text-sm">ไม่มีออเดอร์ที่พักไว้</p>
      </div>
    </div>
  </div>
</div>

</div>

<script>
var appState = {
  user: null,
  cart: [],
  products: [],
  materials: [],
  recipes: [],
  currentSlipFile: null, // สำหรับเก็บไฟล์สลิปที่อัพโหลด
  settings: {},
  cache: {},
  optionGroups: [],
  allOptions: [],
  combos: [],
  orderChannels: [],
  currentChannel: null,
  currentOrderNumber: null,
  discountPresets: []
};
var searchTimeout = null;

// ============================================
// UTILITIES - Debounce Function
// ============================================
function debounce(func, wait) {
  return function() {
    var args = arguments;
    var context = this;
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() {
      func.apply(context, args);
    }, wait);
  };
}

var debouncedSearch = debounce(filterProducts, 300);

// ============================================
// DARK MODE MANAGEMENT
// ============================================

function toggleDarkMode() {
  const body = document.body;
  const isDark = body.classList.toggle('dark-mode');

  // Update icon and text
  const icon = document.getElementById('darkModeIcon');
  const text = document.getElementById('darkModeText');

  if (icon && text) {
    if (isDark) {
      icon.className = 'fas fa-sun mr-2';
      text.textContent = 'โหมดสว่าง';
    } else {
      icon.className = 'fas fa-moon mr-2';
      text.textContent = 'โหมดมืด';
    }
  }

  // Save to localStorage
  localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');

  // Save to Settings sheet (if logged in)
  if (appState.user && appState.user.sheetId) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          console.log('Dark mode preference saved');
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error saving dark mode:', error);
      })
      .updateSettings(appState.user.sheetId, { 'DarkMode': isDark ? 'enabled' : 'disabled' });
  }

  // Show toast
  Swal.fire({
    icon: 'success',
    title: isDark ? 'เปิดโหมดมืดแล้ว' : 'เปิดโหมดสว่างแล้ว',
    toast: true,
    position: 'top-end',
    timer: 2000,
    showConfirmButton: false
  });
}

function loadDarkMode() {
  // Priority: localStorage > Settings sheet > default
  const localDarkMode = localStorage.getItem('darkMode');

  let isDark = false;

  if (localDarkMode === 'enabled') {
    isDark = true;
  } else if (appState.settings && appState.settings.DarkMode === 'enabled') {
    isDark = true;
    localStorage.setItem('darkMode', 'enabled');
  }

  if (isDark) {
    document.body.classList.add('dark-mode');
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    if (icon) icon.className = 'fas fa-sun mr-2';
    if (text) text.textContent = 'โหมดสว่าง';
  }

  console.log('Dark mode loaded:', isDark ? 'enabled' : 'disabled');
}

// Initialize
window.onload = function() {
  loadDarkMode(); // Load dark mode first
  checkSession();

  // Close theme menu when clicking outside
  document.addEventListener('click', function(event) {
    var themeMenu = document.getElementById('themeMenu');

    }
  });
};

function checkSession() {
  var session = localStorage.getItem('coffeeShopSession');
  if (session) {
    appState.user = JSON.parse(session);
    showApp();
  } else {
    document.getElementById('loginModal').style.display = 'flex';
  }
}

function handleLogin(e) {
  e.preventDefault();
  var email = document.getElementById('loginEmail').value;
  var password = document.getElementById('loginPassword').value;

  Swal.fire({ title: 'กำลังเข้าสู่ระบบ...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.user = result.data;
        localStorage.setItem('coffeeShopSession', JSON.stringify(result.data));
        Swal.close();
        if (result.data.showWarning) {
          Swal.fire({ icon: 'warning', title: 'แจ้งเตือนสิทธิ์การใช้งาน', text: `สิทธิ์การใช้งานของคุณจะหมดอายุในอีก ${result.data.daysLeft} วัน!`, toast: true, position: 'top-end', timer: 5000, showConfirmButton: false });
        }
        showApp();
      } else {
        Swal.fire('ผิดพลาด', result.message, 'error');
      }
    })
    .withFailureHandler(function(error) {
      Swal.fire('ผิดพลาด', error.message, 'error');
    })
    .login(email, password);
}

function showApp() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('topNav').style.display = '';
  document.getElementById('bottomNav').style.display = '';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('shopNameTop').textContent = appState.user.shopName;
  document.getElementById('shopEmailTop').textContent = appState.user.email;
  loadAllData();
  showPage('dashboard');
}

function logout() {
  Swal.fire({
    title: 'ออกจากระบบ?',
    text: 'คุณแน่ใจหรือไม่ที่จะออกจากระบบ?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'ใช่, ออกจากระบบ',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      localStorage.removeItem('coffeeShopSession');
      appState.cache = {}; // Clear cache
      location.reload();
    }
  });
}

// ============================================
// VERSION CHANGELOG
// ============================================

function showVersionChangelog() {
  var modal = document.getElementById('changelogModal');
  modal.style.display = 'flex';
  loadVersionChangelog();
}

function closeChangelogModal() {
  document.getElementById('changelogModal').style.display = 'none';
}

function loadVersionChangelog() {
  var content = document.getElementById('changelogContent');
  content.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-2">กำลังโหลด...</p></div>';

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        document.getElementById('currentVersionText').textContent = 'v' + result.currentVersion;
        document.getElementById('versionBadge').textContent = 'v' + result.currentVersion;
        renderChangelog(result.changelog);
      } else {
        content.innerHTML = '<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle text-3xl"></i><p class="mt-2">ไม่สามารถโหลดประวัติการอัปเดตได้</p></div>';
      }
    })
    .withFailureHandler(function(error) {
      content.innerHTML = '<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle text-3xl"></i><p class="mt-2">ผิดพลาด: ' + error.message + '</p></div>';
    })
    .getVersionChangelog();
}

function renderChangelog(changelog) {
  var content = document.getElementById('changelogContent');

  if (!changelog || changelog.length === 0) {
    content.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-info-circle text-3xl"></i><p class="mt-2">ไม่มีประวัติการอัปเดต</p></div>';
    return;
  }

  var html = '';

  changelog.forEach(function(version, index) {
    var isLatest = index === 0;
    var latestBadge = isLatest ? '<span class="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold">ล่าสุด</span>' : '';
    var containerClass = isLatest ? 'border-2 border-purple-500 rounded-lg p-4 bg-purple-50' : 'border-b pb-6';

    html += '<div class="mb-6 ' + containerClass + '">';
    html += '<!-- Version Header -->';
    html += '<div class="flex items-center justify-between mb-3">';
    html += '<div class="flex items-center space-x-3">';
    html += '<span class="text-2xl font-bold text-purple-600">v' + version.version + '</span>';
    html += latestBadge;
    html += '</div>';
    html += '<span class="text-sm text-gray-500"><i class="far fa-calendar mr-1"></i>' + version.date + '</span>';
    html += '</div>';
    html += '<!-- Title -->';
    html += '<h3 class="text-lg font-semibold text-gray-800 mb-3">' + version.title + '</h3>';

    // Features
    if (version.features && version.features.length > 0) {
      html += '<div class="mb-3">';
      html += '<h4 class="text-sm font-semibold text-green-700 mb-2"><i class="fas fa-star mr-1"></i>ฟีเจอร์ใหม่</h4>';
      html += '<ul class="space-y-1">';
      version.features.forEach(function(f) {
        html += '<li class="text-sm text-gray-700 pl-4"><i class="fas fa-check text-green-500 mr-2"></i>' + f + '</li>';
      });
      html += '</ul>';
      html += '</div>';
    }

    // Improvements
    if (version.improvements && version.improvements.length > 0) {
      html += '<div class="mb-3">';
      html += '<h4 class="text-sm font-semibold text-blue-700 mb-2"><i class="fas fa-bolt mr-1"></i>การปรับปรุง</h4>';
      html += '<ul class="space-y-1">';
      version.improvements.forEach(function(i) {
        html += '<li class="text-sm text-gray-700 pl-4"><i class="fas fa-arrow-up text-blue-500 mr-2"></i>' + i + '</li>';
      });
      html += '</ul>';
      html += '</div>';
    }

    // Bug Fixes
    if (version.bugFixes && version.bugFixes.length > 0) {
      html += '<div class="mb-3">';
      html += '<h4 class="text-sm font-semibold text-red-700 mb-2"><i class="fas fa-bug mr-1"></i>แก้ไขบั๊ก</h4>';
      html += '<ul class="space-y-1">';
      version.bugFixes.forEach(function(b) {
        html += '<li class="text-sm text-gray-700 pl-4"><i class="fas fa-wrench text-red-500 mr-2"></i>' + b + '</li>';
      });
      html += '</ul>';
      html += '</div>';
    }

    html += '</div>';
  });

  content.innerHTML = html;
}

// ============================================
// RECEIPT PRINTING
// ============================================

function closeCheckoutSuccess() {
  document.getElementById('checkoutSuccessModal').style.display = 'none';
}

function printReceipt() {
  // Close success modal
  closeCheckoutSuccess();

  // Generate receipt
  generateReceipt();

  // Show print modal
  document.getElementById('receiptPrintModal').style.display = 'flex';
}

function closeReceiptPrint() {
  document.getElementById('receiptPrintModal').style.display = 'none';
}

function updateReceiptSize() {
  var paperSize = document.getElementById('paperSize').value;
  var receiptContent = document.getElementById('receiptContent');

  // Remove all size classes
  receiptContent.classList.remove('receipt-a4', 'receipt-thermal-80', 'receipt-thermal-58');

  // Add selected size class
  if (paperSize === 'a4') {
    receiptContent.classList.add('receipt-a4');
    receiptContent.style.width = '210mm';
  } else if (paperSize === 'thermal-80') {
    receiptContent.classList.add('receipt-thermal-80');
    receiptContent.style.width = '80mm';
  } else if (paperSize === 'thermal-58') {
    receiptContent.classList.add('receipt-thermal-58');
    receiptContent.style.width = '58mm';
  }

  // Re-generate receipt with new size
  generateReceipt();
}

function generateReceipt() {
  if (!appState.lastReceipt) {
    return;
  }

  var receipt = appState.lastReceipt;
  var paperSize = document.getElementById('paperSize').value;
  var isThermal = paperSize.includes('thermal');

  // Format date
  var date = new Date(receipt.date);
  var dateStr = date.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  var timeStr = date.toLocaleTimeString('th-TH', {
    hour: '2-digit',
    minute: '2-digit'
  });

  // Generate HTML
  var fontSize = isThermal ? 'font-size: 12px;' : '';
  var borderWidth = isThermal ? '1px' : '2px';
  var paddingBottom1 = isThermal ? '10px' : '20px';
  var marginBottom1 = isThermal ? '10px' : '20px';
  var headerFontSize = isThermal ? '18px' : '24px';
  var smallFontSize = isThermal ? '10px' : '12px';
  var tableFontSize = isThermal ? '10px' : '12px';
  var colWidth1 = isThermal ? '50px' : '80px';
  var colWidth2 = isThermal ? '60px' : '100px';
  var padding2 = isThermal ? '10px' : '15px';
  var marginTop1 = isThermal ? '10px' : '20px';
  var totalFontSize1 = isThermal ? '12px' : '14px';
  var totalFontSize2 = isThermal ? '16px' : '20px';
  var marginTop2 = isThermal ? '10px' : '15px';
  var marginTop3 = isThermal ? '15px' : '30px';
  var paddingTop = isThermal ? '10px' : '20px';

  var html = '';
  html += '<div class="receipt-content" style="font-family: \'Courier New\', monospace; ' + fontSize + '">';
  html += '<!-- Header -->';
  html += '<div style="text-align: center; border-bottom: ' + borderWidth + ' dashed #000; padding-bottom: ' + paddingBottom1 + '; margin-bottom: ' + marginBottom1 + ';">';
  html += '<div style="font-size: ' + headerFontSize + '; font-weight: bold; margin-bottom: 5px;">';
  html += appState.user.shopName || 'Coffee Shop';
  html += '</div>';
  html += '<div style="font-size: ' + smallFontSize + ';">';
  html += (appState.settings['Address'] || 'ที่อยู่ร้าน') + '<br>';
  html += (appState.settings['Phone'] ? 'โทร: ' + appState.settings['Phone'] : '') + '<br>';
  html += (appState.settings['Email'] || '');
  html += '</div>';
  html += '</div>';

  html += '<!-- Receipt Info -->';
  html += '<div style="margin-bottom: ' + marginBottom1 + ';">';
  html += '<table style="width: 100%; font-size: ' + tableFontSize + ';">';
  html += '<tr>';
  html += '<td>เลขที่:</td>';
  html += '<td style="text-align: right; font-weight: bold;">#' + receipt.orderNumber + '</td>';
  html += '</tr>';
  html += '<tr>';
  html += '<td>วันที่:</td>';
  html += '<td style="text-align: right;">' + dateStr + '</td>';
  html += '</tr>';
  html += '<tr>';
  html += '<td>เวลา:</td>';
  html += '<td style="text-align: right;">' + timeStr + '</td>';
  html += '</tr>';
  html += '<tr>';
  html += '<td>พนักงาน:</td>';
  html += '<td style="text-align: right;">' + appState.user.shopName + '</td>';
  html += '</tr>';
  html += '</table>';
  html += '</div>';

  html += '<!-- Items -->';
  html += '<div style="border-top: ' + borderWidth + ' dashed #000; border-bottom: ' + borderWidth + ' dashed #000; padding: ' + padding2 + ' 0;">';
  html += '<table style="width: 100%; font-size: ' + tableFontSize + ';">';
  html += '<thead>';
  html += '<tr>';
  html += '<th style="text-align: left;">รายการ</th>';
  html += '<th style="text-align: center; width: ' + colWidth1 + ';">จำนวน</th>';
  html += '<th style="text-align: right; width: ' + colWidth2 + ';">ราคา</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';

  // Add items
  receipt.items.forEach(function(item) {
    var itemTotal = item.unitPrice * item.quantity;
    html += '<tr>';
    html += '<td style="padding: 3px 0;">' + item.productName + '</td>';
    html += '<td style="text-align: center;">' + item.quantity + '</td>';
    html += '<td style="text-align: right;">฿' + itemTotal.toFixed(2) + '</td>';
    html += '</tr>';
  });

  html += '</tbody>';
  html += '</table>';
  html += '</div>';

  html += '<!-- Total -->';
  html += '<div style="margin-top: ' + marginTop1 + ';">';
  html += '<table style="width: 100%; font-size: ' + totalFontSize1 + ';">';
  html += '<tr>';
  html += '<td style="font-weight: bold; font-size: ' + totalFontSize2 + ';">รวมทั้งสิ้น</td>';
  html += '<td style="text-align: right; font-weight: bold; font-size: ' + totalFontSize2 + ';">฿' + receipt.total.toFixed(2) + '</td>';
  html += '</tr>';
  html += '</table>';
  html += '</div>';

  html += '<!-- Payment Method -->';
  html += '<div style="margin-top: ' + marginTop2 + '; font-size: ' + smallFontSize + '; text-align: center;">';
  html += 'ชำระด้วย: ' + (receipt.paymentMethods || 'เงินสด');
  html += '</div>';

  html += '<!-- Footer -->';
  html += '<div style="margin-top: ' + marginTop3 + '; text-align: center; font-size: ' + smallFontSize + '; border-top: ' + borderWidth + ' dashed #000; padding-top: ' + paddingTop + ';">';
  html += '<div>*** ขอบคุณที่ใช้บริการ ***</div>';
  if (appState.settings['Receipt Footer']) {
    html += '<div style="margin-top: 5px;">' + appState.settings['Receipt Footer'] + '</div>';
  }
  if (appState.settings['PromptPay Number']) {
    html += '<div style="margin-top: 10px;">PromptPay: ' + appState.settings['PromptPay Number'] + '</div>';
  }
  html += '</div>';
  html += '</div>';

  document.getElementById('receiptContent').innerHTML = html;
}



function showPage(pageName) {
  document.querySelectorAll('.page').forEach(function(p) {
    p.classList.remove('active');
  });
  document.getElementById('page-' + pageName).classList.add('active');

  if (pageName === 'dashboard') loadDashboard();
  if (pageName === 'sales') loadSalesPage();
  if (pageName === 'sales-history') loadSalesHistoryPage();
  if (pageName === 'products') loadProducts();
  if (pageName === 'recipes') loadRecipes();
  if (pageName === 'materials') loadMaterials();
  if (pageName === 'costs') loadCosts();
  if (pageName === 'settings') loadSettings();
  if (pageName === 'inventory') loadInventoryPage();
}





function loadAllData() {
  console.log("--- 1. [index.html] loadAllData() เริ่มทำงาน (กำลังเรียก Backend 7 รายการ) ---");

  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 2. [getProducts] สำเร็จ ---", r.data.length, "รายการ");
        appState.products = r.data;
      } else {
        console.error("--- 2. [getProducts] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 2. [getProducts] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getProducts(appState.user.sheetId);

  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 3. [getMaterials] สำเร็จ ---", r.data.length, "รายการ");
        appState.materials = r.data;
      } else {
        console.error("--- 3. [getMaterials] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 3. [getMaterials] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getMaterials(appState.user.sheetId);

  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 4. [getRecipes] สำเร็จ ---", r.data.length, "รายการ");
        appState.recipes = r.data;
      } else {
        console.error("--- 4. [getRecipes] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 4. [getRecipes] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getRecipes(appState.user.sheetId);

  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 5. [getSettings] สำเร็จ (นี่คือค่า PromptPay ที่ได้ครั้งแรก) --->", r.data['PromptPay Number']);
        appState.settings = r.data;
      } else {
        console.error("--- 5. [getSettings] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 5. [getSettings] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getSettings(appState.user.sheetId);

  // Load Option Groups and Options
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 6. [getOptionGroups] สำเร็จ ---", r.data.length, "รายการ");
        appState.optionGroups = r.data;
        // After loading option groups, load all options
        loadAllOptions();
      } else {
        console.error("--- 6. [getOptionGroups] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 6. [getOptionGroups] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getOptionGroups(appState.user.sheetId);

  // Load Combos
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 7. [getCombos] สำเร็จ ---", r.data.length, "รายการ");
        appState.combos = r.data;
      } else {
        console.error("--- 7. [getCombos] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 7. [getCombos] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getCombos(appState.user.sheetId);

  // Load Order Channels
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 8. [getOrderChannels] สำเร็จ ---", r.data.length, "รายการ");
        appState.orderChannels = r.data;
        loadOrderChannels();
      } else {
        console.error("--- 8. [getOrderChannels] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 8. [getOrderChannels] ล้มเหลW (JavaScript พัง) ---", error);
    })
    .getOrderChannels(appState.user.sheetId);

  // Load Discount Presets
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        console.log("--- 9. [getDiscountPresets] สำเร็จ ---", r.data.length, "รายการ");
        appState.discountPresets = r.data;
        loadDiscountPresets();
      } else {
        console.error("--- 9. [getDiscountPresets] ล้มเหลว (Backend แจ้งมา) ---", r.message);
      }
    })
    .withFailureHandler(function(error) {
      console.error("--- 9. [getDiscountPresets] ล้มเหลว (JavaScript พัง) ---", error);
    })
    .getDiscountPresets(appState.user.sheetId);
}




/**
 * [แก้ไข] Load all options for all groups (เรียกครั้งเดียว)
 */
function loadAllOptions() {
  if (!appState.optionGroups || appState.optionGroups.length === 0) {
    console.log('No option groups found, skipping loadAllOptions.');
    return; // ไม่มีกลุ่ม ก็ไม่ต้องโหลด
  }

  // เราจะเรียก getOptions แค่ครั้งเดียว (โดยไม่ส่ง groupId)
  // Backend (Code.js) ถูกเขียนให้ส่ง "ทุก Options" กลับมาถ้าไม่ระบุ groupId
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.data) {
        appState.allOptions = result.data;
        console.log('All options loaded (Single Call):', appState.allOptions.length);
      } else {
        console.error('Failed to load all options:', result.message);
      }
    })
    .withFailureHandler(function(error) {
       console.error('Error in loadAllOptions single call:', error);
    })
    .getOptions(appState.user.sheetId, null); // ส่ง null (หรือไม่ส่งเลย)
}

// ============================================
// ORDER CHANNELS SYSTEM
// ============================================

// Load order channels into dropdown
function loadOrderChannels() {
  var select = document.getElementById('orderChannelSelect');
  if (!select) return;

  select.innerHTML = '';

  if (!appState.orderChannels || appState.orderChannels.length === 0) {
    select.innerHTML = '<option value="">ไม่มีช่องทาง</option>';
    return;
  }

  // Only show active channels
  var activeChannels = appState.orderChannels.filter(function(ch) {
    return ch.Status === 'active';
  });

  activeChannels.forEach(function(channel) {
    var option = document.createElement('option');
    option.value = channel['Channel ID'];
    option.textContent = channel['Channel Name'];
    option.dataset.mode = channel['Order Number Mode'];
    option.dataset.prefix = channel['Order Prefix'];
    select.appendChild(option);
  });

  // Select first channel (default "หน้าร้าน")
  if (activeChannels.length > 0) {
    select.value = activeChannels[0]['Channel ID'];
    appState.currentChannel = activeChannels[0];
    onChannelChange();
  }
}




// Handle channel change
function onChannelChange() {
  var select = document.getElementById('orderChannelSelect');
  var channelId = select.value;

  if (!channelId) {
    appState.currentChannel = null;
    appState.currentOrderNumber = null;
    document.getElementById('orderNumberDisplay').textContent = '-';
    document.getElementById('orderNumberDisplay').style.display = 'block';
    document.getElementById('orderNumberInput').style.display = 'none';
    return;
  }

  // Find selected channel
  var channel = appState.orderChannels.find(function(ch) {
    return ch['Channel ID'] === channelId;
  });

  if (!channel) return;

  appState.currentChannel = channel;
  var mode = channel['Order Number Mode'];
  
  // [แก้ไข] - เราจะไม่ดึงเลขทันที
  // เราจะรีเซ็ตเลขในเครื่อง และแสดงผลให้ผู้ใช้รู้เท่านั้น

  if (mode === 'auto') {
    // Auto mode: Show "Automatic"
    document.getElementById('orderNumberDisplay').style.display = 'block';
    document.getElementById('orderNumberInput').style.display = 'none';
    document.getElementById('orderNumberDisplay').textContent = '(อัตโนมัติ)';
    appState.currentOrderNumber = null; // [สำคัญ] ล้างเลขที่จองไว้
  } else {
    // Manual mode: Show input field
    document.getElementById('orderNumberDisplay').style.display = 'none';
    document.getElementById('orderNumberInput').style.display = 'block';
    document.getElementById('orderNumberInput').value = '';
    appState.currentOrderNumber = null; // [สำคัญ] ล้างเลขที่จองไว้

    // Listen for manual input
    document.getElementById('orderNumberInput').addEventListener('input', function(e) {
      appState.currentOrderNumber = e.target.value.trim();
    });
  }
}

// ============================================
// DISCOUNT SYSTEM
// ============================================

// Add discount to appState cart
if (!appState.discount) {
  appState.discount = {
    value: 0,
    type: 'percent', // 'percent' or 'amount'
    amount: 0
  };
}

// Load discount presets into buttons
function loadDiscountPresets() {
  var container = document.getElementById('discountPresets');
  if (!container) return;

  container.innerHTML = '';

  if (!appState.discountPresets || appState.discountPresets.length === 0) {
    return;
  }

  appState.discountPresets.forEach(function(preset) {
    var btn = document.createElement('button');
    btn.className = 'bg-white hover:bg-orange-100 border-2 border-orange-300 text-orange-700 px-2 py-1.5 rounded-lg text-xs font-bold transition';

    var displayText = preset['Discount Type'] === 'percent'
      ? preset['Discount Value'] + '%'
      : '฿' + preset['Discount Value'];

    btn.textContent = displayText;
    btn.onclick = function() {
      applyPresetDiscount(preset['Discount Value'], preset['Discount Type']);
    };

    container.appendChild(btn);
  });
}

// Apply preset discount
function applyPresetDiscount(value, type) {
  if (appState.cart.length === 0) {
    Swal.fire('แจ้งเตือน', 'กรุณาเพิ่มสินค้าก่อนใช้ส่วนลด', 'warning');
    return;
  }

  appState.discount.value = parseFloat(value);
  appState.discount.type = type;

  // Calculate discount amount
  calculateDiscount();
  renderCart();

  // Show clear button
  document.getElementById('clearDiscountBtn').style.display = 'inline-block';
}

// Apply custom discount
function applyCustomDiscount() {
  if (appState.cart.length === 0) {
    Swal.fire('แจ้งเตือน', 'กรุณาเพิ่มสินค้าก่อนใช้ส่วนลด', 'warning');
    return;
  }

  var value = parseFloat(document.getElementById('discountValue').value);
  var type = document.getElementById('discountType').value;

  if (isNaN(value) || value <= 0) {
    Swal.fire('ข้อผิดพลาด', 'กรุณากรอกจำนวนส่วนลดที่ถูกต้อง', 'error');
    return;
  }

  appState.discount.value = value;
  appState.discount.type = type;

  // Calculate discount amount
  calculateDiscount();
  renderCart();

  // Clear input
  document.getElementById('discountValue').value = '';

  // Show clear button
  document.getElementById('clearDiscountBtn').style.display = 'inline-block';

  Swal.fire({
    icon: 'success',
    title: 'ใช้ส่วนลดแล้ว',
    text: type === 'percent' ? 'ลด ' + value + '%' : 'ลด ฿' + value.toFixed(2),
    timer: 1500,
    showConfirmButton: false
  });
}

// Calculate discount amount
function calculateDiscount() {
  var subtotal = appState.cart.reduce(function(sum, item) {
    return sum + (item.unitPrice * item.quantity);
  }, 0);

  if (appState.discount.type === 'percent') {
    appState.discount.amount = (subtotal * appState.discount.value) / 100;
  } else {
    appState.discount.amount = appState.discount.value;
  }

  // Don't let discount exceed subtotal
  if (appState.discount.amount > subtotal) {
    appState.discount.amount = subtotal;
  }
}

// Clear discount
function clearDiscount() {
  appState.discount = {
    value: 0,
    type: 'percent',
    amount: 0
  };

  renderCart();
  document.getElementById('clearDiscountBtn').style.display = 'none';
}

// ============================================
// PAYMENT SPLIT SYSTEM
// ============================================

var paymentSplitData = {
  total: 0,
  payments: []
};




function openPaymentSplit() {
  if (appState.cart.length === 0) {
    Swal.fire('ผิดพลาด', 'ตะกร้าสินค้าว่างเปล่า!', 'error');
    return;
  }
  
  // Check if channel is selected
  if (!appState.currentChannel) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกช่องทางการสั่งซื้อ!', 'error');
    return;
  }

  // --- [แก้ไข] ตรรกะดึงหมายเลขออเดอร์ ---

  // 1. ถ้าเป็น "กำหนดเอง" (Manual) และยังไม่กรอก
  if (appState.currentChannel['Order Number Mode'] === 'manual' && (!appState.currentOrderNumber || appState.currentOrderNumber.trim() === '')) {
    Swal.fire('ผิดพลาด', 'กรุณากรอกหมายเลข Order!', 'error');
    return;
  }

  // 2. ถ้าเป็น "อัตโนมัติ" (Auto) และยังไม่มีเลข (appState.currentOrderNumber เป็น null)
  if (appState.currentChannel['Order Number Mode'] === 'auto' && !appState.currentOrderNumber) {
    
    Swal.fire({ title: 'กำลังสร้างหมายเลข Order...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          appState.currentOrderNumber = result.orderNumber;
          document.getElementById('orderNumberDisplay').textContent = result.orderNumber; // อัปเดต UI
          
          // เมื่อได้เลขแล้ว ให้เปิด Modal ต่อ
          Swal.close();
          showPaymentSplitModal(); // <-- เรียกฟังก์ชันที่เปิด Modal จริง
        } else {
          Swal.fire('ข้อผิดพลาด', result.message || 'ไม่สามารถสร้างหมายเลข Order', 'error');
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างหมายเลข Order: ' + error, 'error');
      })
      .generateOrderNumberForChannel(appState.user.sheetId, appState.currentChannel['Channel ID']);
      
  } else {
    // 3. ถ้ามีเลขอยู่แล้ว (ไม่ว่าจะเป็น Manual หรือ Auto ที่เคยดึงแล้ว)
    showPaymentSplitModal(); // <-- เรียกฟังก์ชันที่เปิด Modal จริง
  }
}

// สร้างฟังก์ชันใหม่สำหรับเปิด Modal (แยกส่วนออกมา)
function showPaymentSplitModal() {
  // Calculate total with discount
  var subtotal = appState.cart.reduce(function(sum, item) {
    return sum + (item.unitPrice * item.quantity);
  }, 0);

  var discount = 0;
  if (appState.discount && appState.discount.amount) {
    discount = appState.discount.amount;
  }

  var total = subtotal - discount;

  // Set payment split data
  paymentSplitData.total = total;
  paymentSplitData.payments = [];

  // Update modal
  document.getElementById('splitTotalAmount').textContent = total.toFixed(2);
  document.getElementById('splitTotalAmount2').textContent = total.toFixed(2);
  document.getElementById('splitPaidAmount').textContent = '0.00';
  document.getElementById('splitRemainingAmount').textContent = total.toFixed(2);
  document.getElementById('splitChangeSection').style.display = 'none';

  // Reset all checkboxes and inputs
  document.getElementById('splitCash').checked = false;
  document.getElementById('splitTransfer').checked = false;
  document.getElementById('splitQR').checked = false;
  document.getElementById('splitCredit').checked = false;

  document.getElementById('splitCashAmount').value = '';
  document.getElementById('splitTransferAmount').value = '';
  document.getElementById('splitQRAmount').value = '';
  document.getElementById('splitCreditAmount').value = '';

  document.getElementById('splitCashAmount').disabled = true;
  document.getElementById('splitTransferAmount').disabled = true;
  document.getElementById('splitQRAmount').disabled = true;
  document.getElementById('splitCreditAmount').disabled = true;

  // Show modal
  document.getElementById('paymentSplitModal').style.display = 'flex';
}




function toggleSplitMethod(method) {
  
  // --- [แก้ไข] ---
  // สร้างตัวแปรสำหรับชื่อ ID ที่ถูกต้อง
  // เราต้องจัดการกับ 'qr' ที่เป็นตัวพิมพ์ใหญ่ 'QR' เป็นกรณีพิเศษ
  var methodId = method.charAt(0).toUpperCase() + method.slice(1);
  if (method === 'qr') {
    methodId = 'QR'; // บังคับให้เป็น 'QR' แทน 'Qr'
  }

  var checkbox = document.getElementById('split' + methodId);
  var input = document.getElementById('split' + methodId + 'Amount');
  // --- [สิ้นสุดการแก้ไข] ---

  if (checkbox.checked) { // <-- บรรทัดนี้ (987) จะไม่ error แล้ว
    input.disabled = false;
    input.focus();
    
    // หากต้องการให้มันป้อนยอดที่เหลือให้เลยอัตโนมัติ (แนะนำ)
    if (method === 'qr') {
       var remainingText = document.getElementById('splitRemainingAmount').textContent.replace('฿', '');
       var remainingAmount = parseFloat(remainingText) || 0;
       if (remainingAmount > 0) {
           input.value = remainingAmount.toFixed(2);
           calculateSplitRemaining(); // คำนวณยอดใหม่
       }
    }
    
  } else {
    input.disabled = true;
    input.value = '';
    calculateSplitRemaining();
  }
}

// Calculate remaining amount
function calculateSplitRemaining() {
  var totalPaid = 0;

  // Sum all payment amounts
  if (document.getElementById('splitCash').checked) {
    totalPaid += parseFloat(document.getElementById('splitCashAmount').value) || 0;
  }
  if (document.getElementById('splitTransfer').checked) {
    totalPaid += parseFloat(document.getElementById('splitTransferAmount').value) || 0;
  }
  if (document.getElementById('splitQR').checked) {
    totalPaid += parseFloat(document.getElementById('splitQRAmount').value) || 0;
  }
  if (document.getElementById('splitCredit').checked) {
    totalPaid += parseFloat(document.getElementById('splitCreditAmount').value) || 0;
  }

  var remaining = paymentSplitData.total - totalPaid;

  // Update display
  document.getElementById('splitPaidAmount').textContent = totalPaid.toFixed(2);

  if (remaining < 0) {
    // Overpaid - show change
    document.getElementById('splitRemainingAmount').textContent = '฿0.00';
    document.getElementById('splitRemainingAmount').className = 'font-bold text-lg text-green-600';
    document.getElementById('splitChangeSection').style.display = 'flex';
    document.getElementById('splitChangeAmount').textContent = '฿' + Math.abs(remaining).toFixed(2);
  } else {
    document.getElementById('splitRemainingAmount').textContent = '฿' + remaining.toFixed(2);
    document.getElementById('splitRemainingAmount').className = remaining > 0 ? 'font-bold text-lg text-red-600' : 'font-bold text-lg text-green-600';
    document.getElementById('splitChangeSection').style.display = 'none';
  }
}

// Close Payment Split Modal
function closePaymentSplit() {
  document.getElementById('paymentSplitModal').style.display = 'none';
}

// Confirm Payment Split
function confirmPaymentSplit() {
  // Collect payment data
  var payments = [];

  if (document.getElementById('splitCash').checked) {
    var amount = parseFloat(document.getElementById('splitCashAmount').value) || 0;
    if (amount > 0) {
      payments.push({ method: 'cash', amount: amount });
    }
  }

  if (document.getElementById('splitTransfer').checked) {
    var amount = parseFloat(document.getElementById('splitTransferAmount').value) || 0;
    if (amount > 0) {
      payments.push({ method: 'transfer', amount: amount });
    }
  }

  if (document.getElementById('splitQR').checked) {
    var amount = parseFloat(document.getElementById('splitQRAmount').value) || 0;
    if (amount > 0) {
      payments.push({ method: 'qr', amount: amount });
    }
  }

  if (document.getElementById('splitCredit').checked) {
    var amount = parseFloat(document.getElementById('splitCreditAmount').value) || 0;
    if (amount > 0) {
      payments.push({ method: 'credit', amount: amount });
    }
  }

  // Validate payments
  if (payments.length === 0) {
    Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกวิธีการชำระเงินอย่างน้อย 1 วิธี และกรอกจำนวนเงิน', 'error');
    return;
  }

  var totalPaid = payments.reduce(function(sum, p) { return sum + p.amount; }, 0);

  if (totalPaid < paymentSplitData.total) {
    Swal.fire('ข้อผิดพลาด', 'ยอดชำระไม่ครบ (ขาดอีก ฿' + (paymentSplitData.total - totalPaid).toFixed(2) + ')', 'error');
    return;
  }

  // Store payment split data
  paymentSplitData.payments = payments;

  // Close modal
  closePaymentSplit();

  // Process checkout with split payment
  processCheckoutWithSplit(appState.currentOrderNumber, payments);
}



// (ไฟล์ index.html ประมาณบรรทัด 1076)

// Process checkout with payment split
function processCheckoutWithSplit(orderNumber, payments) {
  Swal.fire({ title: 'กำลังดำเนินการ...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  var channelName = appState.currentChannel ? appState.currentChannel['Channel Name'] : 'POS';

  // Get payment method names for sales record
  var paymentMethods = payments.map(function(p) { return p.method; });

  var promises = appState.cart.map(function(item) {
    return new Promise(function(resolve) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(resolve)
        .addSale(appState.user.sheetId, {
          orderNumber: orderNumber,
          productId: item.productId,
          productName: item.productName,
          quantity: item.quantity,
          unitPrice: item.unitPrice,
          total: item.unitPrice * item.quantity,
          paymentMethods: paymentMethods,
          channel: channelName,
          note: ''
        });
    });
  });

  Promise.all(promises).then(function() {
    // Save payment split to backend
    var total = paymentSplitData.total;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Store receipt data
          appState.lastReceipt = {
            orderNumber: orderNumber,
            items: appState.cart.slice(),
            total: total,
            paymentMethods: paymentMethods,
            paymentSplit: payments,
            change: result.change || 0,
            date: new Date()
          };

          // Show success modal
          document.getElementById('successOrderNumber').textContent = orderNumber;
          document.getElementById('successTotal').textContent = total.toFixed(2);
          document.getElementById('checkoutSuccessModal').style.display = 'flex';

          // 🔽🔽🔽 [แก้ไข] ล้างตะกร้าอัตโนมัติ (ไม่ถาม) 🔽🔽🔽
          appState.cart = [];
          appState.discount = { value: 0, type: 'percent', amount: 0 };
          renderCart();
          document.getElementById('clearDiscountBtn').style.display = 'none';
          // 🔼🔼🔼 [สิ้นสุดการแก้ไข] 🔼🔼🔼

          // ล้างข้อมูลสลิปและ payment methods
          clearAfterCheckout();

          // Regenerate order number for auto channels
          if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'auto') {
            onChannelChange();
          } else if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'manual') {
            document.getElementById('orderNumberInput').value = '';
            appState.currentOrderNumber = null;
          }

          Swal.close();
        } else {
          Swal.fire('ข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกการแบ่งชำระเงิน', 'error');
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการบันทึกการแบ่งชำระเงิน: ' + error, 'error');
      })
      .savePaymentSplit(appState.user.sheetId, orderNumber, total, payments);
  });
}


function processCheckout(orderNumber, paymentMethods) {
  Swal.fire({ title: 'กำลังดำเนินการ...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  var channelName = appState.currentChannel ? appState.currentChannel['Channel Name'] : 'POS';

  var promises = appState.cart.map(function(item) {
    return new Promise(function(resolve) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(resolve)
        .addSale(appState.user.sheetId, {
          orderNumber: orderNumber,
          productId: item.productId,
          productName: item.productName,
          quantity: item.quantity,
          unitPrice: item.unitPrice,
          total: item.unitPrice * item.quantity,
          paymentMethods: paymentMethods,
          channel: channelName,
          note: ''
        });
    });
  });

  Promise.all(promises).then(function() {
    // Calculate total
    var total = appState.cart.reduce(function(sum, item) { return sum + (item.unitPrice * item.quantity); }, 0);

    // Store receipt data
    appState.lastReceipt = {
      orderNumber: orderNumber,
      items: appState.cart.slice(),
      total: total,
      paymentMethods: paymentMethods,
      date: new Date()
    };

    // Show success modal
    document.getElementById('successOrderNumber').textContent = orderNumber;
    document.getElementById('successTotal').textContent = total.toFixed(2);
    document.getElementById('checkoutSuccessModal').style.display = 'flex';

    // 🔽🔽🔽 [แก้ไข] ล้างตะกร้าอัตโนมัติ (ไม่ถาม) 🔽🔽🔽
    appState.cart = [];
    appState.discount = { value: 0, type: 'percent', amount: 0 };
    renderCart();
    document.getElementById('clearDiscountBtn').style.display = 'none';
    // 🔼🔼🔼 [สิ้นสุดการแก้ไข] 🔼🔼🔼

    // ล้างข้อมูลสลิปและ payment methods
    clearAfterCheckout();

    // Regenerate order number for auto channels
    if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'auto') {
      onChannelChange(); // This will generate a new order number
    } else if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'manual') {
      // Clear manual input
      document.getElementById('orderNumberInput').value = '';
      appState.currentOrderNumber = null;
    }
  });
}



function loadDashboard() {
  var today = new Date().toISOString().split('T')[0];
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        var d = result.data;
        document.getElementById('dashRevenue').textContent = '฿' + d.revenue.toFixed(2);
        document.getElementById('dashCost').textContent = '฿' + d.totalCost.toFixed(2);
        document.getElementById('dashProfit').textContent = '฿' + d.profit.toFixed(2);
        document.getElementById('dashItems').textContent = d.totalQuantity;

        var html = '';
        d.topProducts.forEach(function(p, i) {
          html += '<div class="flex justify-between py-2 border-b"><span>' + (i+1) + '. ' + p.name + '</span><span class="font-bold">' + p.quantity + ' ชิ้น</span></div>';
        });
        document.getElementById('topProducts').innerHTML = html || '<p class="text-gray-500" style="color: var(--text-secondary);">ยังไม่มียอดขาย</p>';
      }
    })
    .getDashboardData(appState.user.sheetId, today);
}

function loadSalesPage() {
  renderProductGrid();
  populateCategoryFilter();
}

function renderProductGrid(filteredProducts) {
  var grid = document.getElementById('productGrid');
  var productCountEl = document.getElementById('productCount');

  // Use filtered products if provided, otherwise use all active products
  var activeProducts = filteredProducts || appState.products.filter(function(p) {
    return p.Status === 'active';
  });

  productCountEl.textContent = activeProducts.length;

  if (activeProducts.length === 0) {
    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400"><i class="fas fa-search text-5xl mb-3"></i><p>ไม่พบสินค้า</p></div>';
    return;
  }

  var html = '';
  activeProducts.forEach(function(p) {
    // Modern product card design
    html += '<div class="group bg-white border-2 border-gray-200 rounded-xl p-3 cursor-pointer hover:border-purple-400 hover:shadow-xl transition-all duration-200 transform hover:-translate-y-1" onclick="addToCart(&quot;' + p['Product ID'] + '&quot;)">';

    // Product image or icon
    html += '<div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg h-24 flex items-center justify-center mb-3 group-hover:from-purple-200 group-hover:to-pink-200 transition">';
    html += '<i class="fas fa-coffee text-4xl text-purple-500"></i>';
    html += '</div>';

    // Product info
    html += '<div class="text-center">';
    html += '<h4 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2">' + p['Product Name'] + '</h4>';
    html += '<p class="text-xs text-gray-500 mb-2">' + (p.Category || 'อื่นๆ') + '</p>';
    html += '<div class="flex items-center justify-center space-x-2">';
    html += '<p class="text-lg font-bold text-purple-600">฿' + parseFloat(p.Price).toFixed(2) + '</p>';
    html += '</div>';
    html += '</div>';

    // Add button
    html += '<div class="mt-3 pt-3 border-t border-gray-200">';
    html += '<button class="w-full bg-purple-600 hover:bg-purple-700 text-white text-xs py-2 rounded-lg transition">';
    html += '<i class="fas fa-plus mr-1"></i>เพิ่ม';
    html += '</button>';
    html += '</div>';

    html += '</div>';
  });
  grid.innerHTML = html;
}


// ============================================
// PRODUCT OPTIONS & COMBO MODAL FUNCTIONS
// ============================================

// State for options modal
var currentProductOptions = {
  productId: null,
  product: null,
  basePrice: 0,
  selectedOptions: {},
  quantity: 1,
  notes: ''
};

function addToCart(productId) {
  var product = appState.products.find(function(p) {
    return p['Product ID'] === productId;
  });
  if (!product) return;

  // Check if product has options or combos
  // For now, always open options modal (can be enhanced later)
  openProductOptionsModal(productId);
}

// Open Product Options Modal
function openProductOptionsModal(productId) {
  var product = appState.products.find(function(p) {
    return p['Product ID'] === productId;
  });
  if (!product) return;

  // Initialize state
  currentProductOptions = {
    productId: productId,
    product: product,
    basePrice: parseFloat(product.Price),
    selectedOptions: {},
    quantity: 1,
    notes: ''
  };

  // Set product name
  document.getElementById('optionsProductName').textContent = product['Product Name'];

  // Load options (if any from backend - for now show basic options)
  renderProductOptions();

  // Reset quantity and notes
  document.getElementById('optionsQuantity').value = 1;
  document.getElementById('productNotes').value = '';

  // Update price
  updateOptionsPrice();

  // Show modal
  document.getElementById('productOptionsModal').style.display = 'flex';
}

// Render product options dynamically - LOAD FROM BACKEND
function renderProductOptions() {
  var optionsContainer = document.getElementById('optionsSections');
  var productId = currentProductOptions.productId;

  // Show loading
  optionsContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-purple-600"></i><p class="mt-2 text-gray-600">กำลังโหลด Options...</p></div>';

  // Load option groups from backend
  google.script.run
    .withSuccessHandler(function(result) {
      if (!result.success) {
        // Fallback to default options if backend fails
        renderDefaultOptions();
        return;
      }

      var optionGroups = result.data;

      if (!optionGroups || optionGroups.length === 0) {
        // No options configured, use defaults
        renderDefaultOptions();
        return;
      }

      // Render options from backend
      renderOptionsFromBackend(optionGroups);
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load options:', error);
      renderDefaultOptions();
    })
    .getOptionGroups(appState.user.sheetId);
}

// Render options from backend data
function renderOptionsFromBackend(optionGroups) {
  var optionsContainer = document.getElementById('optionsSections');
  var html = '';

  optionGroups.forEach(function(group) {
    if (group.Status !== 'active') return;

    html += '<div class="border border-gray-200 rounded-lg p-4">';
    html += '<h3 class="font-bold text-gray-800 mb-3 flex items-center">';
    html += '<i class="fas fa-sliders-h mr-2 text-purple-600"></i>' + group['Group Name'];
    if (group.Required === 'Yes') {
      html += '<span class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded">*Required</span>';
    }
    html += '</h3>';
    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2">';

    // Get options for this group
    var groupOptions = appState.allOptions.filter(function(opt) {
      return opt['Group ID'] === group['Group ID'] && opt.Status === 'active';
    });

    groupOptions.forEach(function(opt) {
      var priceText = opt.Price > 0 ? ' (+฿' + opt.Price + ')' : '';
      html += '<label class="option-item relative cursor-pointer">';
      html += '<input type="radio" name="option_' + group['Group ID'] + '" value="' + opt['Option ID'] + '" data-price="' + opt.Price + '" data-label="' + opt['Option Name'] + '" class="hidden product-option" onchange="updateOptionsPrice()">';
      html += '<div class="border-2 border-gray-300 rounded-lg p-3 text-center hover:border-purple-400 transition option-box">';
      html += '<span class="text-sm font-medium">' + opt['Option Name'] + '</span>';
      if (priceText) {
        html += '<div class="text-xs text-green-600 mt-1">' + priceText + '</div>';
      }
      html += '</div>';
      html += '</label>';
    });

    html += '</div>';
    html += '</div>';
  });

  if (html === '') {
    renderDefaultOptions();
    return;
  }

  optionsContainer.innerHTML = html;

  // Select first option by default for each group
  optionGroups.forEach(function(group) {
    var firstRadio = document.querySelector('input[name="option_' + group['Group ID'] + '"]');
    if (firstRadio) firstRadio.checked = true;
  });

  updateOptionsPrice();
}

// Fallback: Render default hardcoded options
function renderDefaultOptions() {
  var optionsContainer = document.getElementById('optionsSections');

  var optionTypes = [
    {
      id: 'size',
      name: 'ขนาด',
      icon: 'fas fa-expand-arrows-alt',
      options: [
        { value: 'S', label: 'เล็ก (S)', price: 0 },
        { value: 'M', label: 'กลาง (M)', price: 5 },
        { value: 'L', label: 'ใหญ่ (L)', price: 10 }
      ]
    },
    {
      id: 'sweetness',
      name: 'ความหวาน',
      icon: 'fas fa-candy-cane',
      options: [
        { value: '0', label: 'ไม่หวาน', price: 0 },
        { value: '25', label: 'หวานน้อย (25%)', price: 0 },
        { value: '50', label: 'หวานปกติ (50%)', price: 0 },
        { value: '75', label: 'หวานมาก (75%)', price: 0 },
        { value: '100', label: 'หวานเต็มที่ (100%)', price: 0 }
      ]
    },
    {
      id: 'ice',
      name: 'น้ำแข็ง',
      icon: 'fas fa-snowflake',
      options: [
        { value: '0', label: 'ไม่ใส่น้ำแข็ง', price: 0 },
        { value: '25', label: 'น้อย', price: 0 },
        { value: '50', label: 'ปกติ', price: 0 },
        { value: '100', label: 'เยอะ', price: 0 }
      ]
    }
  ];

  var html = '';
  optionTypes.forEach(function(optionType) {
    html += '<div class="border border-gray-200 rounded-lg p-4">';
    html += '<h3 class="font-bold text-gray-800 mb-3 flex items-center">';
    html += '<i class="' + optionType.icon + ' mr-2 text-purple-600"></i>' + optionType.name;
    html += '</h3>';
    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2">';

    optionType.options.forEach(function(opt) {
      var priceText = opt.price > 0 ? ' (+฿' + opt.price + ')' : '';
      html += '<label class="option-item relative cursor-pointer">';
      html += '<input type="radio" name="option_' + optionType.id + '" value="' + opt.value + '" data-price="' + opt.price + '" data-label="' + opt.label + '" class="hidden product-option" onchange="updateOptionsPrice()">';
      html += '<div class="border-2 border-gray-300 rounded-lg p-3 text-center hover:border-purple-400 transition option-box">';
      html += '<span class="text-sm font-medium">' + opt.label + '</span>';
      if (priceText) {
        html += '<div class="text-xs text-green-600 mt-1">' + priceText + '</div>';
      }
      html += '</div>';
      html += '</label>';
    });

    html += '</div>';
    html += '</div>';
  });

  optionsContainer.innerHTML = html;

  // Select first option by default for each type
  optionTypes.forEach(function(optionType) {
    var firstRadio = document.querySelector('input[name="option_' + optionType.id + '"]');
    if (firstRadio) firstRadio.checked = true;
  });

  updateOptionsPrice();
}

// Update price based on selected options
function updateOptionsPrice() {
  var basePrice = currentProductOptions.basePrice;
  var optionsPrice = 0;

  // Calculate additional price from options
  var selectedOptions = document.querySelectorAll('.product-option:checked');
  selectedOptions.forEach(function(option) {
    optionsPrice += parseFloat(option.getAttribute('data-price') || 0);
  });

  // Get quantity
  var quantity = parseInt(document.getElementById('optionsQuantity').value) || 1;

  // Calculate total
  var totalPrice = (basePrice + optionsPrice) * quantity;

  // Update display
  document.getElementById('optionsCurrentPrice').textContent = '฿' + totalPrice.toFixed(2);

  // Update state
  currentProductOptions.quantity = quantity;

  // Highlight selected options
  document.querySelectorAll('.option-item').forEach(function(item) {
    var radio = item.querySelector('input[type="radio"]');
    var box = item.querySelector('.option-box');
    if (radio && radio.checked) {
      box.classList.add('border-purple-600', 'bg-purple-50');
      box.classList.remove('border-gray-300');
    } else {
      box.classList.remove('border-purple-600', 'bg-purple-50');
      box.classList.add('border-gray-300');
    }
  });
}

// Adjust quantity in options modal
function adjustOptionsQuantity(change) {
  var input = document.getElementById('optionsQuantity');
  var newValue = parseInt(input.value) + change;
  if (newValue < 1) newValue = 1;
  input.value = newValue;
  updateOptionsPrice();
}

// Confirm add to cart with options
function confirmAddToCart() {
  var product = currentProductOptions.product;
  var quantity = currentProductOptions.quantity;
  var notes = document.getElementById('productNotes').value.trim();

  // Collect selected options
  var selectedOptions = {};
  var optionsText = [];
  var optionsPrice = 0;

  document.querySelectorAll('.product-option:checked').forEach(function(option) {
    var name = option.getAttribute('name').replace('option_', '');
    var value = option.value;
    var price = parseFloat(option.getAttribute('data-price') || 0);
    var label = option.parentElement.querySelector('span').textContent;

    selectedOptions[name] = { value: value, label: label, price: price };
    optionsText.push(label);
    optionsPrice += price;
  });

  // Calculate final price
  var unitPrice = currentProductOptions.basePrice + optionsPrice;

  // Add to cart
  var cartItem = {
    productId: product['Product ID'],
    productName: product['Product Name'],
    unitPrice: unitPrice,
    quantity: quantity,
    options: selectedOptions,
    optionsText: optionsText.join(', '),
    notes: notes,
    timestamp: Date.now()
  };

  appState.cart.push(cartItem);
  renderCart();

  // Close modal
  closeProductOptionsModal();

  // Show success toast
  Swal.fire({
    icon: 'success',
    title: 'เพิ่มลงตะกร้าแล้ว!',
    text: product['Product Name'],
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000
  });
}

// Close product options modal
function closeProductOptionsModal() {
  document.getElementById('productOptionsModal').style.display = 'none';
  currentProductOptions = {
    productId: null,
    product: null,
    basePrice: 0,
    selectedOptions: {},
    quantity: 1,
    notes: ''
  };
}

// ============================================
// COMBO MODAL FUNCTIONS
// ============================================

var currentCombo = {
  productId: null,
  product: null,
  comboPrice: 0,
  selectedItems: {},
  notes: ''
};

// Open Combo Modal
function openComboModal(productId) {
  var product = appState.products.find(function(p) {
    return p['Product ID'] === productId;
  });
  if (!product) return;

  currentCombo = {
    productId: productId,
    product: product,
    comboPrice: parseFloat(product.Price),
    selectedItems: {},
    notes: ''
  };

  document.getElementById('comboProductName').textContent = product['Product Name'];
  document.getElementById('comboCurrentPrice').textContent = '฿' + currentCombo.comboPrice.toFixed(2);

  // Render combo items selection
  renderComboItems();

  document.getElementById('comboModal').style.display = 'flex';
}

// Render combo items (example structure)
function renderComboItems() {
  var container = document.getElementById('comboItemsSections');

  // Example combo structure
  var html = '';
  html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">';
  html += '<p class="text-sm text-blue-800">';
  html += '<i class="fas fa-info-circle mr-2"></i>คอมโบนี้ประกอบด้วยเครื่องดื่ม 1 แก้ว + เบเกอรี่ 1 ชิ้น';
  html += '</p>';
  html += '</div>';

  html += '<div class="text-center py-6 text-gray-500">';
  html += '<i class="fas fa-layer-group text-4xl mb-2"></i>';
  html += '<p>ฟีเจอร์คอมโบกำลังพัฒนา</p>';
  html += '</div>';

  container.innerHTML = html;
}

// Confirm add combo to cart
function confirmAddComboToCart() {
  var product = currentCombo.product;
  var notes = document.getElementById('comboNotes').value.trim();

  var cartItem = {
    productId: product['Product ID'],
    productName: product['Product Name'] + ' (Combo)',
    unitPrice: currentCombo.comboPrice,
    quantity: 1,
    isCombo: true,
    comboItems: currentCombo.selectedItems,
    notes: notes,
    timestamp: Date.now()
  };

  appState.cart.push(cartItem);
  renderCart();

  closeComboModal();

  Swal.fire({
    icon: 'success',
    title: 'เพิ่มคอมโบแล้ว!',
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 2000
  });
}

// Close combo modal
function closeComboModal() {
  document.getElementById('comboModal').style.display = 'none';
  currentCombo = {
    productId: null,
    product: null,
    comboPrice: 0,
    selectedItems: {},
    notes: ''
  };
}

// Legacy function - keep for backward compatibility
function addToCartDirectly(productId) {
  var product = appState.products.find(function(p) {
    return p['Product ID'] === productId;
  });
  if (!product) return;

  var existing = appState.cart.find(function(c) {
    return c.productId === productId && !c.options;
  });
  if (existing) {
    existing.quantity++;
  } else {
    appState.cart.push({
      productId: productId,
      productName: product['Product Name'],
      unitPrice: product.Price,
      quantity: 1
    });
  }
  renderCart();
}

function renderCart() {
  var container = document.getElementById('cartItems');
  var cartItemCountEl = document.getElementById('cartItemCount');
  var cartSubtotalEl = document.getElementById('cartSubtotal');
  var cartDiscountEl = document.getElementById('cartDiscount');
  var cartTotalEl = document.getElementById('cartTotal');

  // Calculate totals
  var subtotal = appState.cart.reduce(function(sum, item) {
    return sum + (item.unitPrice * item.quantity);
  }, 0);

  // Calculate discount
  var discount = 0;
  if (appState.discount && appState.discount.value > 0) {
    if (appState.discount.type === 'percent') {
      discount = (subtotal * appState.discount.value) / 100;
    } else {
      discount = appState.discount.value;
    }
    // Don't let discount exceed subtotal
    if (discount > subtotal) {
      discount = subtotal;
    }
    appState.discount.amount = discount;
  }

  var total = subtotal - discount;

  // Update cart item count
  var totalItems = appState.cart.reduce(function(sum, item) {
    return sum + item.quantity;
  }, 0);
  cartItemCountEl.textContent = totalItems;

  // Render cart items
  if (appState.cart.length === 0) {
    container.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-shopping-basket text-5xl mb-3 opacity-50"></i><p class="text-sm">ยังไม่มีรายการ</p><p class="text-xs mt-1">เลือกสินค้าเพื่อเริ่มสั่งซื้อ</p></div>';
  } else {
    var html = '';
    appState.cart.forEach(function(item, idx) {
      var itemTotal = item.unitPrice * item.quantity;

      html += '<div class="bg-white rounded-lg border border-gray-200 p-3 mb-3 hover:shadow-md transition">';

      // Product name and price
      html += '<div class="flex justify-between items-start mb-2">';
      html += '<div class="flex-1 pr-2">';
      html += '<p class="font-bold text-gray-800 text-sm">' + item.productName + '</p>';

      // Show options if any
      if (item.optionsText) {
        html += '<p class="text-xs text-purple-600 mt-1">';
        html += '<i class="fas fa-sliders-h mr-1"></i>' + item.optionsText;
        html += '</p>';
      }

      // Show notes if any
      if (item.notes) {
        html += '<p class="text-xs text-gray-600 mt-1 italic">';
        html += '<i class="fas fa-comment mr-1"></i>' + item.notes;
        html += '</p>';
      }

      html += '<p class="text-xs text-gray-500 mt-1">฿' + parseFloat(item.unitPrice).toFixed(2) + ' / ชิ้น</p>';
      html += '</div>';
      html += '<button onclick="removeFromCart(' + idx + ')" class="text-red-500 hover:text-red-700 transition">';
      html += '<i class="fas fa-times"></i>';
      html += '</button>';
      html += '</div>';

      // Quantity controls and item total
      html += '<div class="flex justify-between items-center pt-2 border-t border-gray-100">';
      html += '<div class="flex items-center space-x-2">';
      html += '<button onclick="updateCartQty(' + idx + ', -1)" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-lg transition flex items-center justify-center">';
      html += '<i class="fas fa-minus text-xs"></i>';
      html += '</button>';
      html += '<span class="w-10 text-center font-bold text-gray-800">' + item.quantity + '</span>';
      html += '<button onclick="updateCartQty(' + idx + ', 1)" class="w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-lg transition flex items-center justify-center">';
      html += '<i class="fas fa-plus text-xs"></i>';
      html += '</button>';
      html += '</div>';
      html += '<div class="font-bold text-purple-600">฿' + itemTotal.toFixed(2) + '</div>';
      html += '</div>';

      html += '</div>';
    });
    container.innerHTML = html;
  }

  // Update totals
  cartSubtotalEl.textContent = '฿' + subtotal.toFixed(2);
  cartDiscountEl.textContent = '- ฿' + discount.toFixed(2);
  cartTotalEl.textContent = '฿' + total.toFixed(2);
}

function updateCartQty(idx, change) {
  appState.cart[idx].quantity += change;
  if (appState.cart[idx].quantity <= 0) {
    appState.cart.splice(idx, 1);
  }
  renderCart();
}

function removeFromCart(idx) {
  appState.cart.splice(idx, 1);
  renderCart();
}

function clearCart() {
  if (appState.cart.length === 0) return;

  Swal.fire({
    title: 'ยืนยันการล้างตะกร้า?',
    text: 'รายการทั้งหมดจะถูกลบ',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'ใช่, ล้างเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      appState.cart = [];
      renderCart();
      Swal.fire('ล้างแล้ว!', 'ตะกร้าถูกล้างเรียบร้อย', 'success');
    }
  });
}

// Filter products by category
function filterByCategory() {
  var categoryFilter = document.getElementById('categoryFilter').value;
  var searchTerm = document.getElementById('searchProduct').value.toLowerCase();

  var filtered = appState.products.filter(function(p) {
    if (p.Status !== 'active') return false;

    var matchCategory = !categoryFilter || p.Category === categoryFilter;
    var matchSearch = !searchTerm ||
      p['Product Name'].toLowerCase().indexOf(searchTerm) !== -1 ||
      p['Product ID'].toLowerCase().indexOf(searchTerm) !== -1;

    return matchCategory && matchSearch;
  });

  renderProductGrid(filtered);
}


/**
 * [ใหม่] สร้างตัวเลือกหมวดหมู่ (Category Filter) ในหน้า POS
 * ให้ตรงกับข้อมูลสินค้าที่มีอยู่จริง
 */
function populateCategoryFilter() {
  var select = document.getElementById('categoryFilter');
  if (!select) return;

  // 1. เก็บตัวเลือก "ทุกหมวดหมู่" ไว้
  var firstOption = select.options[0];
  select.innerHTML = ''; // ล้างของเก่า
  select.appendChild(firstOption); // ใส่ "ทุกหมวดหมู่" กลับเข้าไป

  // 2. ดึงหมวดหมู่ทั้งหมดจาก appState
  var categories = appState.products.map(function(p) {
    return p.Category;
  });
  
  // 3. กรองเฉพาะชื่อที่ไม่ซ้ำ และไม่เป็นค่าว่าง
  var uniqueCategories = categories.filter(function(value, index, self) {
    return value && self.indexOf(value) === index;
  }).sort(); // เรียงตามตัวอักษร
  
  // 4. สร้าง <option>
  uniqueCategories.forEach(function(category) {
    var option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    select.appendChild(option);
  });
}

// Hold current order (save to localStorage)
function holdOrder() {
  if (appState.cart.length === 0) {
    Swal.fire('ผิดพลาด', 'ไม่มีรายการในตะกร้า!', 'error');
    return;
  }

  Swal.fire({
    title: 'พักออเดอร์',
    text: 'ต้องการพักออเดอร์นี้หรือไม่?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'ใช่, พักไว้',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      // Save to localStorage
      var heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
      heldOrders.push({
        id: Date.now(),
        timestamp: new Date().toISOString(),
        cart: JSON.stringify(appState.cart),
        total: appState.cart.reduce(function(sum, item) {
          return sum + (item.unitPrice * item.quantity);
        }, 0)
      });
      localStorage.setItem('heldOrders', JSON.stringify(heldOrders));

      // Clear current cart
      appState.cart = [];
      renderCart();

      Swal.fire('สำเร็จ!', 'พักออเดอร์เรียบร้อย<br><small>สามารถดูออเดอร์ที่พักไว้ได้ในเมนูตั้งค่า</small>', 'success');
    }
  });
}

// ============================================
// HELD ORDERS MANAGEMENT
// ============================================

// Refresh and display held orders
function refreshHeldOrders() {
  var container = document.getElementById('heldOrdersList');
  var heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');

  if (heldOrders.length === 0) {
    container.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-inbox text-4xl mb-2"></i><p class="text-sm">ไม่มีออเดอร์ที่พักไว้</p></div>';
    return;
  }

  var html = '';
  heldOrders.forEach(function(order, idx) {
    var date = new Date(order.timestamp);
    var dateStr = date.toLocaleString('th-TH', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    var cart = JSON.parse(order.cart);
    var itemCount = cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);

    html += '<div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">';
    html += '<div class="flex justify-between items-start mb-2">';
    html += '<div class="flex-1">';
    html += '<p class="font-bold text-gray-800">#' + order.id + '</p>';
    html += '<p class="text-xs text-gray-500 mt-1"><i class="fas fa-clock mr-1"></i>' + dateStr + '</p>';
    html += '<p class="text-sm text-gray-700 mt-2">' + itemCount + ' รายการ | ฿' + order.total.toFixed(2) + '</p>';
    html += '</div>';
    html += '<div class="flex space-x-2">';
    html += '<button onclick="resumeHeldOrder(' + idx + ')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition">';
    html += '<i class="fas fa-play mr-1"></i>กู้คืน';
    html += '</button>';
    html += '<button onclick="deleteHeldOrder(' + idx + ')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition">';
    html += '<i class="fas fa-trash"></i>';
    html += '</button>';
    html += '</div>';
    html += '</div>';

    // Show cart items preview
    html += '<div class="mt-3 pt-3 border-t border-orange-200">';
    html += '<p class="text-xs text-gray-600 mb-2">รายการสินค้า:</p>';
    html += '<div class="space-y-1">';
    cart.forEach(function(item) {
      html += '<p class="text-xs text-gray-700">• ' + item.productName + ' x' + item.quantity;
      if (item.optionsText) {
        html += ' <span class="text-purple-600">(' + item.optionsText + ')</span>';
      }
      html += '</p>';
    });
    html += '</div>';
    html += '</div>';

    html += '</div>';
  });

  container.innerHTML = html;
}

// Resume a held order
function resumeHeldOrder(idx) {
  var heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
  if (idx < 0 || idx >= heldOrders.length) return;

  var order = heldOrders[idx];
  var cart = JSON.parse(order.cart);

  // Ask to replace or merge
  if (appState.cart.length > 0) {
    Swal.fire({
      title: 'กู้คืนออเดอร์',
      text: 'คุณมีรายการในตะกร้าอยู่แล้ว ต้องการ:',
      icon: 'question',
      showCancelButton: true,
      showDenyButton: true,
      confirmButtonText: 'แทนที่',
      denyButtonText: 'รวมเข้าด้วยกัน',
      cancelButtonText: 'ยกเลิก',
      confirmButtonColor: '#f59e0b',
      denyButtonColor: '#10b981',
      cancelButtonColor: '#6b7280'
    }).then(function(result) {
      if (result.isConfirmed) {
        // Replace
        appState.cart = cart;
        removeHeldOrderFromStorage(idx);
        renderCart();
        showPage('sales');
        Swal.fire('สำเร็จ!', 'กู้คืนออเดอร์แล้ว (แทนที่)', 'success');
      } else if (result.isDenied) {
        // Merge
        cart.forEach(function(item) {
          appState.cart.push(item);
        });
        removeHeldOrderFromStorage(idx);
        renderCart();
        showPage('sales');
        Swal.fire('สำเร็จ!', 'กู้คืนออเดอร์แล้ว (รวม)', 'success');
      }
    });
  } else {
    // No current cart, just restore
    appState.cart = cart;
    removeHeldOrderFromStorage(idx);
    renderCart();
    showPage('sales');
    Swal.fire('สำเร็จ!', 'กู้คืนออเดอร์แล้ว', 'success');
  }
}

// Delete a held order
function deleteHeldOrder(idx) {
  Swal.fire({
    title: 'ลบออเดอร์?',
    text: 'ต้องการลบออเดอร์ที่พักไว้นี้หรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      removeHeldOrderFromStorage(idx);
      Swal.fire('ลบแล้ว!', 'ออเดอร์ถูกลบเรียบร้อย', 'success');
    }
  });
}

// Helper function to remove held order from localStorage
function removeHeldOrderFromStorage(idx) {
  var heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
  heldOrders.splice(idx, 1);
  localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
  refreshHeldOrders();
}

// ============================================
// SETTINGS PAGE FUNCTIONS
// ============================================

// Show manage options modal (placeholder)
function showManageOptionsModal() {
  Swal.fire({
    title: 'Product Options Management',
    html: '<p class="text-gray-600" style="color: var(--text-secondary);">ฟีเจอร์จัดการ Product Options จะพัฒนาในเวอร์ชันถัดไป</p><p class="text-sm text-gray-500 mt-2">ตอนนี้ Options ถูก hard-code ไว้ในระบบ</p>',
    icon: 'info',
    confirmButtonText: 'เข้าใจแล้ว'
  });
}

// Show manage combos modal (placeholder)
function showManageCombosModal() {
  Swal.fire({
    title: 'Combo Sets Management',
    html: '<p class="text-gray-600" style="color: var(--text-secondary);">ฟีเจอร์จัดการ Combo Sets จะพัฒนาในเวอร์ชันถัดไป</p><p class="text-sm text-gray-500 mt-2">ระบบ Combo อยู่ระหว่างการพัฒนา</p>',
    icon: 'info',
    confirmButtonText: 'เข้าใจแล้ว'
  });
}



function toggleQR() {

  console.log("--- [toggleQR] ถูกเรียก / ค่า appState.settings ตอนนี้คือ: ---", JSON.stringify(appState.settings));
  
  var checked = document.querySelector('input[value="qr"].payment-method').checked;
  var qrSection = document.getElementById('qrSection');

  if (checked) {
    // 🔽🔽🔽 [แก้ไข] แปลงเป็น String ก่อน 🔽🔽🔽
    var promptPayNumber = String(appState.settings['PromptPay Number'] || '');

    if (promptPayNumber.trim() === '') { // <-- [แก้ไข] .trim() จะทำงานได้ปกติ
      // ถ้าไม่มี PromptPay Number ให้แสดงข้อความแจ้งเตือน
      Swal.fire({
        icon: 'warning',
        title: 'ยังไม่ได้ตั้งค่า PromptPay',
        text: 'กรุณาตั้งค่าหมายเลข PromptPay ในหน้า Settings ก่อนใช้งาน QR Code',
        confirmButtonText: 'ตกลง'
      });
      // ยกเลิกการเลือก QR checkbox
      document.querySelector('input[value="qr"].payment-method').checked = false;
      qrSection.style.display = 'none';
      return;
    }

    // คำนวณยอดรวม
    var total = appState.cart.reduce(function(sum, item) {
      return sum + (item.unitPrice * item.quantity);
    }, 0);

// สร้าง QR Code URL ผ่าน promptpay.io

        // 🔽🔽🔽 [เพิ่มโค้ดดีบัก] 🔽🔽🔽
        console.log("--- ดีบัก QR Code ---");
        console.log("เบอร์ PromptPay:", promptPayNumber);
        console.log("ยอดเงิน:", total);
        // 🔼🔼🔼 [สิ้นสุดโค้ดดีบัก] 🔼🔼🔼

        var qrUrl = 'https://promptpay.io/' + promptPayNumber.replace(/-/g, '') + '/' + total.toFixed(2) + '.png';
        document.getElementById('qrImage').src = qrUrl; // Sets the image source
        qrSection.style.display = 'block'; // Shows the section
  } else {
    qrSection.style.display = 'none';
  }
}

// ============================================
// SLIP UPLOAD FUNCTIONS
// ============================================

/**
 * แสดงส่วน Upload Slip เมื่อเลือกโอนเงินหรือ QR Code
 */
function showSlipUpload() {
  document.getElementById('slipUploadSection').style.display = 'block';
}

/**
 * ซ่อนส่วน Upload Slip และล้างข้อมูล
 */
function hideSlipUpload() {
  document.getElementById('slipUploadSection').style.display = 'none';
  appState.currentSlipFile = null;
  document.getElementById('slipFileInput').value = '';
  document.getElementById('slipCameraInput').value = '';
  document.getElementById('slipPreview').innerHTML = '';
}

/**
 * แสดงภาพตัวอย่างสลิป
 */
function previewSlip(input) {
  if (input.files && input.files[0]) {
    appState.currentSlipFile = input.files[0];

    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('slipPreview').innerHTML =
        '<div class="relative inline-block">' +
        '<img src="' + e.target.result + '" class="max-w-full h-48 object-contain border rounded-lg shadow-md">' +
        '<button onclick="clearSlipPreview()" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition">' +
        '<i class="fas fa-times"></i>' +
        '</button>' +
        '</div>';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

/**
 * ล้างภาพตัวอย่างสลิป
 */
function clearSlipPreview() {
  appState.currentSlipFile = null;
  document.getElementById('slipFileInput').value = '';
  document.getElementById('slipCameraInput').value = '';
  document.getElementById('slipPreview').innerHTML = '';
}

/**
 * อัพโหลดสลิปไปยัง Google Drive
 * @param {File} file - ไฟล์ภาพสลิป
 * @param {string} orderId - หมายเลขออเดอร์
 * @returns {Promise} - Promise ที่ resolve เมื่ออัพโหลดสำเร็จ
 */
function uploadSlipToDrive(file, orderId) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var base64Data = e.target.result.split(',')[1];
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .uploadSlipImage(base64Data, file.name, orderId);
    };
    reader.readAsDataURL(file);
  });
}

/**
 * จัดการการเปลี่ยนแปลง payment method
 * แสดง slip upload ถ้าเลือก "โอนเงิน" หรือ "QR Code"
 */
function handlePaymentMethodChange() {
  var transferChecked = document.querySelector('input[value="transfer"].payment-method').checked;
  var qrChecked = document.querySelector('input[value="qr"].payment-method').checked;

  if (transferChecked || qrChecked) {
    showSlipUpload();
  } else {
    hideSlipUpload();
  }
}

/**
 * ล้างข้อมูลทั้งหมดหลังจาก checkout สำเร็จ
 */
function clearAfterCheckout() {
  // ล้างข้อมูลสลิป
  hideSlipUpload();

  // รีเซ็ต payment method checkboxes
  var paymentCheckboxes = document.querySelectorAll('.payment-method');
  paymentCheckboxes.forEach(function(checkbox) {
    checkbox.checked = false;
  });

  // ซ่อน QR Section
  document.getElementById('qrSection').style.display = 'none';
}



function checkout() {
  if (appState.cart.length === 0) {
    Swal.fire('ผิดพลาด', 'ตะกร้าสินค้าว่างเปล่า!', 'error');
    return;
  }

  var checkboxes = document.querySelectorAll('.payment-method:checked');
  var paymentMethods = [];
  for (var i = 0; i < checkboxes.length; i++) {
    paymentMethods.push(checkboxes[i].value);
  }
  if (paymentMethods.length === 0) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกวิธีการชำระเงินอย่างน้อย 1 วิธี!', 'error');
    return;
  }
  
  // Check if channel is selected
  if (!appState.currentChannel) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกช่องทางการสั่งซื้อ!', 'error');
    return;
  }
  
  // --- [แก้ไข] ตรรกะดึงหมายเลขออเดอร์ ---
  
  // 1. ถ้าเป็น "กำหนดเอง" (Manual) และยังไม่กรอก
  if (appState.currentChannel['Order Number Mode'] === 'manual' && (!appState.currentOrderNumber || appState.currentOrderNumber.trim() === '')) {
    Swal.fire('ผิดพลาด', 'กรุณากรอกหมายเลข Order!', 'error');
    return;
  }

  // 2. ถ้าเป็น "อัตโนมัติ" (Auto) และยังไม่มีเลข (appState.currentOrderNumber เป็น null)
  if (appState.currentChannel['Order Number Mode'] === 'auto' && !appState.currentOrderNumber) {
    
    Swal.fire({ title: 'กำลังสร้างหมายเลข Order...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          appState.currentOrderNumber = result.orderNumber;
          document.getElementById('orderNumberDisplay').textContent = result.orderNumber; // อัปเดต UI
          
          // เมื่อได้เลขแล้ว ให้ดำเนินการต่อ
          Swal.close();
          processCheckout(appState.currentOrderNumber, paymentMethods);
        } else {
          Swal.fire('ข้อผิดพลาด', result.message || 'ไม่สามารถสร้างหมายเลข Order', 'error');
        }
      })
      .withFailureHandler(function(error) {
        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างหมายเลข Order: ' + error, 'error');
      })
      .generateOrderNumberForChannel(appState.user.sheetId, appState.currentChannel['Channel ID']);
      
  } else {
    // 3. ถ้ามีเลขอยู่แล้ว (ไม่ว่าจะเป็น Manual หรือ Auto ที่เคยดึงแล้ว)
    processCheckout(appState.currentOrderNumber, paymentMethods);
  }
}

function processCheckout(orderNumber, paymentMethods) {
  Swal.fire({ title: 'กำลังดำเนินการ...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  var channelName = appState.currentChannel ? appState.currentChannel['Channel Name'] : 'POS';

  var promises = appState.cart.map(function(item) {
    return new Promise(function(resolve) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(resolve)
        .addSale(appState.user.sheetId, {
          orderNumber: orderNumber,
          productId: item.productId,
          productName: item.productName,
          quantity: item.quantity,
          unitPrice: item.unitPrice,
          total: item.unitPrice * item.quantity,
          paymentMethods: paymentMethods,
          channel: channelName,
          note: ''
        });
    });
  });

  Promise.all(promises).then(function() {
    // Calculate total
    var total = appState.cart.reduce(function(sum, item) { return sum + (item.unitPrice * item.quantity); }, 0);

    // Store receipt data
    appState.lastReceipt = {
      orderNumber: orderNumber,
      items: appState.cart.slice(),
      total: total,
      paymentMethods: paymentMethods,
      date: new Date()
    };

    // Show success modal
    document.getElementById('successOrderNumber').textContent = orderNumber;
    document.getElementById('successTotal').textContent = total.toFixed(2);
    document.getElementById('checkoutSuccessModal').style.display = 'flex';

    clearCart();

    // ล้างข้อมูลสลิปและ payment methods
    clearAfterCheckout();

    // Regenerate order number for auto channels
    if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'auto') {
      onChannelChange(); // This will generate a new order number
    } else if (appState.currentChannel && appState.currentChannel['Order Number Mode'] === 'manual') {
      // Clear manual input
      document.getElementById('orderNumberInput').value = '';
      appState.currentOrderNumber = null;
    }
  });
}

function filterProducts() {
  // Just call filterByCategory which handles both search and category
  filterByCategory();
}

function loadProducts() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.products = result.data;
        renderProductsTable();
      }
    })
    .getProducts(appState.user.sheetId);
}




// ============================================
// NEW PRODUCT MODAL FUNCTIONS (ดีไซน์ใหม่)
// ============================================

/**
 * เปิด Modal สำหรับ 'เพิ่มสินค้า'
 */
function showAddProductModal() {
  // 1. รีเซ็ตฟอร์ม
  document.getElementById('productForm').reset();

  // 2. ตั้งค่าหัวข้อ
  document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-plus mr-2"></i>เพิ่มสินค้าใหม่';

  // 3. ล้าง ID (เพื่อให้รู้ว่าเป็นการ "เพิ่ม")
  document.getElementById('modalProductId').value = '';

  // 4. โหลดตัวเลือกหมวดหมู่
  populateCategoryDatalist();

  // 5. ล้างข้อมูลวัตถุดิบ
  document.getElementById('materialsList').innerHTML = '';
  document.getElementById('modalCost').value = '0.00';

  // 6. แสดง Modal
  document.getElementById('productModal').style.display = 'flex';

  // 7. Focus ที่ช่องแรก
  document.getElementById('modalProductName').focus();
}

/**
 * เปิด Modal สำหรับ 'แก้ไขสินค้า' (ถูกเรียกจากปุ่มในตาราง)
 */
function editProduct(productId) {
  // 1. ค้นหาสินค้าจาก State
  var product = appState.products.find(function(p) { return p['Product ID'] === productId; });
  if (!product) {
    Swal.fire('ผิดพลาด', 'ไม่พบข้อมูลสินค้า', 'error');
    return;
  }

  // 2. ตั้งค่าหัวข้อ
  document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>แก้ไขสินค้า';

  // 3. เติมข้อมูลลงในฟอร์ม
  document.getElementById('modalProductId').value = product['Product ID'];
  document.getElementById('modalProductName').value = product['Product Name'];
  document.getElementById('modalCategory').value = product.Category || '';
  document.getElementById('modalPrice').value = product.Price;
  document.getElementById('modalCost').value = product.Cost || 0;

  // 4. โหลดตัวเลือกหมวดหมู่
  populateCategoryDatalist();

  // 5. โหลดวัตถุดิบที่เกี่ยวข้อง (ถ้ามี)
  loadProductMaterials(productId);

  // 6. แสดง Modal
  document.getElementById('productModal').style.display = 'flex';

  // 7. Focus ที่ช่องแรก
  document.getElementById('modalProductName').focus();
}

/**
 * ปิด Modal สินค้า
 */
function closeProductModal() {
  document.getElementById('productModal').style.display = 'none';
}

/**
 * ดึงหมวดหมู่ทั้งหมดมาสร้าง Datalist (ป้องกันการพิมพ์ผิด)
 */
function populateCategoryDatalist() {
  var datalist = document.getElementById('categoryDatalist');
  datalist.innerHTML = ''; // ล้างของเก่า

  // 1. ดึงหมวดหมู่ทั้งหมดจาก appState
  var categories = appState.products.map(function(p) {
    return p.Category;
  });
  
  // 2. กรองเฉพาะชื่อที่ไม่ซ้ำ และไม่เป็นค่าว่าง
  var uniqueCategories = categories.filter(function(value, index, self) {
    return value && self.indexOf(value) === index;
  });
  
  // 3. สร้าง <option>
  uniqueCategories.forEach(function(category) {
    var option = document.createElement('option');
    option.value = category;
    datalist.appendChild(option);
  });
}

/**
 * บันทึกข้อมูล (เพิ่ม หรือ แก้ไข)
 */
function saveProduct(event) {
  event.preventDefault(); // ป้องกันหน้าเว็บ Refresh
  
  Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  // 1. ดึงข้อมูลจากฟอร์ม
  var productId = document.getElementById('modalProductId').value;
  var productData = {
    'Product Name': document.getElementById('modalProductName').value,
    'Category': document.getElementById('modalCategory').value,
    'Price': parseFloat(document.getElementById('modalPrice').value),
    'Cost': parseFloat(document.getElementById('modalCost').value) || 0,
    // (ฟิลด์อื่นๆ เช่น 'Product ID' หรือ 'Status' จะถูกจัดการโดย Backend)
  };
  
  var isEditing = !!productId; // ถ้ามี ID คือการ "แก้ไข"

  // 2. เลือกว่าจะเรียกฟังก์ชัน "add" หรือ "update"
  var promise;
  if (isEditing) {
    promise = new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .updateProduct(appState.user.sheetId, productId, productData);
    });
  } else {
    // ส่งข้อมูลแบบที่ฟังก์ชัน addProduct คาดหวัง
    var addData = {
        name: productData['Product Name'],
        category: productData['Category'],
        price: productData['Price'],
        cost: productData['Cost']
    };
    promise = new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .addProduct(appState.user.sheetId, addData);
    });
  }

  // 3. รอผลลัพธ์
  promise.then(function(r) {
    if (r.success) {
      closeProductModal();
      Swal.fire('สำเร็จ!', 'บันทึกข้อมูลสินค้าเรียบร้อย', 'success');
      loadProducts(); // โหลดตารางใหม่
      loadAllData();  // อัปเดต appState.products (สำคัญมากสำหรับหน้าขาย)
    } else {
      Swal.fire('ผิดพลาด', r.message, 'error');
    }
  }).catch(function(err) {
    Swal.fire('ผิดพลาด (JS)', err.message, 'error');
  });
}

// ============================================
// PRODUCT MATERIALS MANAGEMENT
// ============================================

/**
 * เพิ่มแถววัตถุดิบใหม่ในโมดอลสินค้า
 */
function addMaterialToProduct() {
  var materialsList = document.getElementById('materialsList');

  // สร้างแถวใหม่
  var rowDiv = document.createElement('div');
  rowDiv.className = 'flex gap-2 items-center p-2 rounded-lg';
  rowDiv.style.background = 'var(--bg-secondary)';
  rowDiv.style.border = '1px solid var(--border-color)';

  var html = '';

  // Dropdown วัตถุดิบ
  html += '<select class="material-select flex-1 px-2 py-2 rounded border outline-none" style="background: var(--card-bg); border-color: var(--border-color); color: var(--text-primary);" onchange="calculateProductCost()" required>';
  html += '<option value="">เลือกวัตถุดิบ</option>';

  appState.materials.forEach(function(mat) {
    html += '<option value="' + mat['Material ID'] + '" data-unit="' + mat.Unit + '" data-price="' + (mat['Price per Unit'] || 0) + '">' + mat['Material Name'] + ' (' + mat.Unit + ')</option>';
  });

  html += '</select>';

  // ปริมาณ
  html += '<input type="number" step="0.01" min="0" placeholder="ปริมาณ" class="material-quantity w-24 px-2 py-2 rounded border outline-none" style="background: var(--card-bg); border-color: var(--border-color); color: var(--text-primary);" onchange="calculateProductCost()" required>';

  // หน่วย (แสดงอัตโนมัติ)
  html += '<span class="material-unit w-16 text-sm text-center opacity-70">-</span>';

  // ปุ่มลบ
  html += '<button type="button" onclick="removeMaterial(this)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">';
  html += '<i class="fas fa-trash"></i>';
  html += '</button>';

  rowDiv.innerHTML = html;
  materialsList.appendChild(rowDiv);

  // อัพเดทหน่วยเมื่อเลือกวัตถุดิบ
  var select = rowDiv.querySelector('.material-select');
  select.addEventListener('change', function() {
    var selectedOption = this.options[this.selectedIndex];
    var unit = selectedOption.getAttribute('data-unit') || '-';
    rowDiv.querySelector('.material-unit').textContent = unit;
  });
}

/**
 * ลบแถววัตถุดิบ
 */
function removeMaterial(button) {
  button.closest('div[class*="flex gap-2"]').remove();
  calculateProductCost();
}

/**
 * คำนวณต้นทุนสินค้าจากวัตถุดิบที่เลือก
 */
function calculateProductCost() {
  var totalCost = 0;

  // วนลูปทุกแถววัตถุดิบ
  var rows = document.querySelectorAll('#materialsList > div');

  rows.forEach(function(row) {
    var select = row.querySelector('.material-select');
    var quantityInput = row.querySelector('.material-quantity');

    if (select && quantityInput && select.value) {
      var selectedOption = select.options[select.selectedIndex];
      var pricePerUnit = parseFloat(selectedOption.getAttribute('data-price')) || 0;
      var quantity = parseFloat(quantityInput.value) || 0;

      totalCost += pricePerUnit * quantity;
    }
  });

  // อัพเดทช่องต้นทุน
  document.getElementById('modalCost').value = totalCost.toFixed(2);
}

/**
 * โหลดวัตถุดิบของสินค้าเมื่อเปิดโมดอลแก้ไข (ถ้ามี)
 */
function loadProductMaterials(productId) {
  var materialsList = document.getElementById('materialsList');
  materialsList.innerHTML = ''; // ล้างข้อมูลเก่า

  // TODO: ถ้ามีการเก็บข้อมูลวัตถุดิบในฐานข้อมูล ให้โหลดมาแสดงที่นี่
  // ตอนนี้ยังไม่มีการเก็บ ดังนั้นเว้นไว้ก่อน
}



/**
 * [ใหม่] เรียก Backend ให้คำนวณต้นทุนสินค้าใหม่ทั้งหมด
 */
function recalculateCosts() {
  Swal.fire({
    title: 'คำนวณต้นทุนใหม่?',
    text: 'ระบบจะดึงต้นทุนจาก "สูตรอาหาร" มาอัปเดตช่อง "ต้นทุน" ของสินค้าทั้งหมดที่มีสูตรผูกอยู่ คุณแน่ใจหรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#f59e0b',
    confirmButtonText: 'ใช่, คำนวณใหม่',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      
      Swal.fire({ 
        title: 'กำลังคำนวณ...', 
        text: 'กรุณารอสักครู่ ระบบกำลังอัปเดตต้นทุนสินค้าทั้งหมด...',
        allowOutsideClick: false, 
        didOpen: function() { Swal.showLoading(); } 
      });
      
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ!', `อัปเดตต้นทุนสินค้าจำนวน ${r.updatedCount} รายการเรียบร้อย`, 'success');
            // โหลดข้อมูลหน้าสินค้าใหม่ เพื่อแสดงผลต้นทุนที่อัปเดต
            loadProducts(); 
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .withFailureHandler(function(err) {
          Swal.fire('ผิดพลาด (JS)', err.message, 'error');
        })
        .recalculateAllProductCosts(appState.user.sheetId);
    }
  });
}




/**
 * [แก้ไข] เปิด Modal สำหรับ 'จัดการหมวดหมู่'
 */
function showManageCategoriesModal() {
  var renameSelect = document.getElementById('categoryRenameSelect');
  var deleteSelect = document.getElementById('categoryDeleteSelect');
  
  renameSelect.innerHTML = '<option value="" class="text-black" disabled selected>-- เลือกหมวดหมู่ --</option>';
  deleteSelect.innerHTML = '<option value="" class="text-black" disabled selected>-- เลือกหมวดหมู่ --</option>';

  // 1. ดึงหมวดหมู่ทั้งหมดจาก appState
  var categories = appState.products.map(function(p) {
    return p.Category;
  });
  
  // 2. กรองเฉพาะชื่อที่ไม่ซ้ำ และไม่เป็นค่าว่าง
  var uniqueCategories = categories.filter(function(value, index, self) {
    return value && self.indexOf(value) === index;
  }).sort(); // เรียงตามตัวอักษร
  
  // 3. สร้าง <option>
  if (uniqueCategories.length === 0) {
    renameSelect.innerHTML = '<option value="" class="text-black">ไม่พบหมวดหมู่</option>';
    deleteSelect.innerHTML = '<option value="" class="text-black">ไม่พบหมวดหมู่</option>';
  } else {
    uniqueCategories.forEach(function(category) {
      renameSelect.innerHTML += `<option value="${category}" class="text-black">${category}</option>`;
      deleteSelect.innerHTML += `<option value="${category}" class="text-black">${category}</option>`;
    });
  }

  // 4. รีเซ็ตฟอร์ม
  document.getElementById('categoryRenameForm').reset();
  document.getElementById('categoryDeleteForm').reset();

  // 5. แสดง Modal
  document.getElementById('categoryManageModal').style.display = 'flex';
}

/**
 * [ใหม่] ปิด Modal 'จัดการหมวดหมู่'
 */
function closeManageCategoriesModal() {
  document.getElementById('categoryManageModal').style.display = 'none';
}

/**
 * [ใหม่] จัดการการเปลี่ยนชื่อหมวดหมู่
 */
function handleRenameCategory(event) {
  event.preventDefault();
  var oldName = document.getElementById('categoryRenameSelect').value;
  var newName = document.getElementById('categoryNewNameInput').value;

  if (!oldName) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกหมวดหมู่ที่ต้องการแก้ไข', 'error');
    return;
  }
  
  if (!newName || newName.trim() === '') {
    Swal.fire('ผิดพลาด', 'กรุณากรอกชื่อใหม่', 'error');
    return;
  }

  Swal.fire({
    title: 'ยืนยันการเปลี่ยนชื่อ?',
    text: `คุณต้องการเปลี่ยนชื่อ "${oldName}" เป็น "${newName}" ใช่หรือไม่? (สินค้าทั้งหมดที่ใช้ชื่อนี้จะอัปเดตตาม)`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ใช่, เปลี่ยนชื่อ',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      Swal.fire({ title: 'กำลังอัปเดต...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ!', `เปลี่ยนชื่อหมวดหมู่ ${r.updatedCount} รายการเรียบร้อย`, 'success');
            closeManageCategoriesModal();
            loadAllData(); // โหลดข้อมูลทั้งหมดใหม่ (สำคัญ)
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .updateCategoryName(appState.user.sheetId, oldName, newName.trim());
    }
  });
}

/**
 * [ใหม่] จัดการการลบหมวดหมู่
 */
function handleDeleteCategory(event) {
  event.preventDefault();
  var categoryName = document.getElementById('categoryDeleteSelect').value;

  if (!categoryName) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกหมวดหมู่ที่ต้องการลบ', 'error');
    return;
  }

  Swal.fire({
    title: `ยืนยันการลบ "${categoryName}"?`,
    text: `สินค้าทั้งหมดที่เคยอยู่หมวดหมู่นี้ จะถูกย้ายไป "ไม่มีหมวดหมู่" คุณแน่ใจหรือไม่?`,
    icon: 'error',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ใช่, ลบเลย',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ!', `ลบหมวดหมู่ ${r.updatedCount} รายการเรียบร้อย`, 'success');
            closeManageCategoriesModal();
            loadAllData(); // โหลดข้อมูลทั้งหมดใหม่ (สำคัญ)
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .deleteCategory(appState.user.sheetId, categoryName);
    }
  });
}

// ============================================
// [แก้ไข] ฟังก์ชัน renderProductsTable (ตารางสินค้า)
// ============================================

// (ฟังก์ชันนี้คุณมีอยู่แล้ว) ให้คุณ "วางทับ" ของเดิม
// เพื่อแก้การอ้างอิงคอลัมน์และเพิ่ม Class ให้สวยงาม
function renderProductsTable() {
  var tbody = document.getElementById('productsTableBody');
  if (!tbody) return; // ถ้ายังโหลดหน้าไม่เสร็จ

  // กรองสินค้าที่ Active
  var activeProducts = appState.products.filter(function(p) {
    return p.Status === 'active';
  });
  
  if (activeProducts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-white/70">ไม่พบสินค้า</td></tr>';
    return;
  }

  tbody.innerHTML = activeProducts.map(function(p) {
    var cost = p.Cost || 0;
    var price = p.Price || 0;
    var profit = price - cost;
    var profitClass = profit >= 0 ? 'text-green-300' : 'text-red-300';
    
    // เราไม่แสดง ID แล้ว เพราะมันยาว
    return '<tr class="border-t border-white/10 hover:bg-white/10">' +
      '<td class="p-3 font-bold">' + p['Product Name'] + '</td>' +
      '<td class="p-3">' + (p.Category || '-') + '</td>' +
      '<td class="p-3">฿' + price.toFixed(2) + '</td>' +
      '<td class="p-3 text-white/70">฿' + cost.toFixed(2) + '</td>' +
      '<td class="p-3 ' + profitClass + '">฿' + profit.toFixed(2) + '</td>' +
      '<td class="p-3 text-center">' +
        // [แก้ไข] เปลี่ยนไปเรียก Modal ใหม่
        '<button onclick="editProduct(&quot;' + p['Product ID'] + '&quot;)" class="text-blue-300 hover:text-blue-200 mr-4 transition" title="แก้ไข">' +
          '<i class="fas fa-edit"></i>' +
        '</button>' +
        '<button onclick="deleteProduct(&quot;' + p['Product ID'] + '&quot;)" class="text-red-400 hover:text-red-300 transition" title="ลบ">' +
          '<i class="fas fa-trash"></i>' +
        '</button>' +
      '</td>' +
      '</tr>';
  }).join('');
}








function deleteProduct(productId) {
  Swal.fire({
    title: 'ลบสินค้า?',
    text: 'ระบบจะตั้งค่าสถานะสินค้าเป็นไม่ใช้งาน',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('ลบเรียบร้อย!', '', 'success');
            loadProducts();
          }
        })
        .deleteProduct(appState.user.sheetId, productId);
    }
  });
}

function loadMaterials() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.materials = result.data;
        renderMaterialsTable();
      }
    })
    .getMaterials(appState.user.sheetId);
}

function renderMaterialsTable() {
  var tbody = document.getElementById('materialsTableBody');
  tbody.innerHTML = appState.materials.map(function(m) {
    return '<tr class="border-b hover:bg-gray-50">' +
      '<td class="p-3">' + m['Material ID'] + '</td>' +
      '<td class="p-3 font-bold">' + m['Material Name'] + '</td>' +
      '<td class="p-3">' + m.Unit + '</td>' +
      '<td class="p-3">฿' + m['Price Per Unit'] + '</td>' +
      '<td class="p-3">' + (m.Supplier || '-') + '</td>' +
      '<td class="p-3">' +
        '<button onclick="editMaterial(&quot;' + m['Material ID'] + '&quot;)" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>' +
        '<button onclick="deleteMaterial(&quot;' + m['Material ID'] + '&quot;)" class="text-red-600"><i class="fas fa-trash"></i></button>' +
      '</td>' +
      '</tr>';
  }).join('');
}

function showAddMaterialModal() {
  Swal.fire({
    title: 'เพิ่มวัตถุดิบ',
    html: `
      <input id="mName" class="swal2-input" placeholder="ชื่อวัตถุดิบ">
      <input id="mUnit" class="swal2-input" placeholder="หน่วย (g, ml, pcs)">
      <input id="mPrice" type="number" step="0.01" class="swal2-input" placeholder="ราคาต่อหน่วย">
      <input id="mSupplier" class="swal2-input" placeholder="ผู้จัดจำหน่าย (ถ้ามี)">
    `,
    confirmButtonText: 'เพิ่ม',
    cancelButtonText: 'ยกเลิก',
    showCancelButton: true,
    preConfirm: function() {
      return {
        name: document.getElementById('mName').value,
        unit: document.getElementById('mUnit').value,
        pricePerUnit: parseFloat(document.getElementById('mPrice').value),
        supplier: document.getElementById('mSupplier').value
      };
    }
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ', 'เพิ่มวัตถุดิบเรียบร้อย!', 'success');
            loadMaterials();
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .addMaterial(appState.user.sheetId, result.value);
    }
  });
}

// ⭐ NEW: Edit Material Function
function editMaterial(materialId) {
  var material = appState.materials.find(function(m) { return m['Material ID'] === materialId; });
  if (!material) return;

  Swal.fire({
    title: 'แก้ไขวัตถุดิบ',
    html: `
      <input id="emName" class="swal2-input" placeholder="ชื่อวัตถุดิบ" value="${material['Material Name']}">
      <input id="emUnit" class="swal2-input" placeholder="หน่วย (g, ml, pcs)" value="${material.Unit}">
      <input id="emPrice" type="number" step="0.01" class="swal2-input" placeholder="ราคาต่อหน่วย" value="${material['Price Per Unit']}">
      <input id="emSupplier" class="swal2-input" placeholder="ผู้จัดจำหน่าย (ถ้ามี)" value="${material.Supplier || ''}">
    `,
    confirmButtonText: 'อัปเดต',
    cancelButtonText: 'ยกเลิก',
    showCancelButton: true,
    preConfirm: function() {
      return {
        'Material Name': document.getElementById('emName').value,
        'Unit': document.getElementById('emUnit').value,
        'Price Per Unit': parseFloat(document.getElementById('emPrice').value),
        'Supplier': document.getElementById('emSupplier').value
      };
    }
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ', 'อัปเดตวัตถุดิบเรียบร้อย!', 'success');
            loadMaterials();
            loadAllData(); // Refresh materials in memory
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .updateMaterial(appState.user.sheetId, materialId, result.value);
    }
  });
}

function deleteMaterial(materialId) {
  Swal.fire({
    title: 'ลบวัตถุดิบ?',
    text: 'คุณแน่ใจหรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('ลบเรียบร้อย!', '', 'success');
            loadMaterials();
          }
        })
        .deleteMaterial(appState.user.sheetId, materialId);
    }
  });
}




// ============================================
// RECIPE PAGE FUNCTIONS (ดีไซน์ใหม่)
// ============================================

/**
 * [แก้ไข] โหลดข้อมูลสูตร (ตัวเรียกหลัก)
 */
function loadRecipes() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.recipes = result.data;
        // เมื่อข้อมูลมาครบ ให้ Render ตาราง Dashboard
        renderRecipesDashboard();
      }
    })
    .getRecipes(appState.user.sheetId);
}

/**
 * [แก้ไข] Render ตารางหน้าสูตรอาหารใหม่ (แบบ Grouped)
 * (เปลี่ยนชื่อจาก renderRecipesTable เป็น renderRecipesDashboard)
 */
function renderRecipesDashboard() {
  var tbody = document.getElementById('recipesTableBody');
  if (!tbody) return;

  // 1. Group วัตถุดิบทั้งหมดตาม Product ID
  var recipesByProduct = {};
  var materialCosts = {};
  
  // สร้าง lookup table สำหรับราคาวัตถุดิบ
  appState.materials.forEach(function(m) {
    materialCosts[m['Material ID']] = m['Price Per Unit'] || 0;
  });

  appState.recipes.forEach(function(r) {
    var pid = r['Product ID'];
    if (!recipesByProduct[pid]) {
      recipesByProduct[pid] = {
        count: 0,
        totalCost: 0,
        items: []
      };
    }
    
    var costPerItem = (materialCosts[r['Material ID']] || 0) * (r.Quantity || 0);
    
    recipesByProduct[pid].count++;
    recipesByProduct[pid].totalCost += costPerItem;
    recipesByProduct[pid].items.push(r);
  });

  // 2. กรองเฉพาะ Product ที่มีสูตร
  var productsWithRecipes = appState.products.filter(function(p) {
    return recipesByProduct[p['Product ID']];
  });

  if (productsWithRecipes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-white/70">ยังไม่มีสินค้าที่ผูกสูตรไว้ (กดปุ่ม "เพิ่ม/แก้ไขสูตร" เพื่อเริ่มต้น)</td></tr>';
    return;
  }

  // 3. Render ตาราง
  tbody.innerHTML = productsWithRecipes.map(function(p) {
    var pid = p['Product ID'];
    var recipeInfo = recipesByProduct[pid];
    
    return '<tr class="border-t border-white/10 hover:bg-white/10">' +
      '<td class="p-3 font-bold">' + p['Product Name'] + '</td>' +
      '<td class="p-3">' + recipeInfo.count + ' รายการ</td>' +
      '<td class="p-3 text-red-300">฿' + recipeInfo.totalCost.toFixed(2) + '</td>' +
      '<td class="p-3 text-center">' +
        '<button onclick="showEditRecipeModal(&quot;' + pid + '&quot;)" class="text-blue-300 hover:text-blue-200" title="จัดการสูตร">' +
          '<i class="fas fa-edit"></i> จัดการ' +
        '</button>' +
      '</td>' +
      '</tr>';
  }).join('');
}


/**
 * [แก้ไข] เปิด Modal สำหรับ 'เพิ่มสูตร'
 * (แทนที่ Swal.fire ตัวเก่า)
 */
function showAddRecipeModal() {
  // 1. ตั้งค่าหัวข้อ
  document.getElementById('recipeModalTitle').innerHTML = '<i class="fas fa-plus mr-2"></i>เพิ่ม/แก้ไขสูตร';
  
  // 2. เติม Product Dropdown
  var productSelect = document.getElementById('modalRecipeProductSelect');
  var productOptions = '<option value="" class="text-black" disabled selected>-- เลือกสินค้าเพื่อเริ่ม --</option>';
  appState.products.filter(p => p.Status === 'active').forEach(function(p) {
    productOptions += '<option value="' + p['Product ID'] + '" class="text-black">' + p['Product Name'] + '</option>';
  });
  productSelect.innerHTML = productOptions;
  productSelect.disabled = false; // เปิดให้เลือก
  
  // 3. รีเซ็ตส่วนที่เหลือ
  document.getElementById('modalRecipeListContainer').innerHTML = '<p class="text-center text-white/70 p-4">กรุณาเลือกสินค้า...</p>';
  document.getElementById('modalRecipeMaterialSelect').innerHTML = '<option value="" class="text-black">...</option>';
  document.getElementById('modalRecipeMaterialSelect').disabled = true;
  document.getElementById('modalRecipeQtyInput').value = '';
  document.getElementById('modalRecipeQtyInput').disabled = true;
  document.getElementById('modalRecipeAddButton').disabled = true;
  document.getElementById('modalRecipeAddButton').classList.add('opacity-50', 'cursor-not-allowed');

  // 4. แสดง Modal
  document.getElementById('recipeModal').style.display = 'flex';
}

/**
 * [ใหม่] เปิด Modal สำหรับ 'แก้ไขสูตร' (เมื่อคลิกจากตาราง)
 */
function showEditRecipeModal(productId) {
  // 1. เปิด Modal (เหมือน "เพิ่ม")
  showAddRecipeModal();
  
  // 2. ตั้งค่าหัวข้อ
  document.getElementById('recipeModalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>แก้ไขสูตร';
  
  // 3. เลือก Product และล็อก
  var productSelect = document.getElementById('modalRecipeProductSelect');
  productSelect.value = productId;
  productSelect.disabled = true; // ล็อกไม่ให้เปลี่ยน Product
  
  // 4. โหลดข้อมูลสูตรทันที
  handleProductSelectChange(productId);
}

/**
 * [ใหม่] ปิด Modal สูตร
 */
function closeRecipeModal() {
  document.getElementById('recipeModal').style.display = 'none';
  // โหลดตารางหลักใหม่ เผื่อมีการเปลี่ยนแปลง
  renderRecipesDashboard();
}

/**
 * [ใหม่] เมื่อผู้ใช้เลือก Product ใน Modal (CRUD - Read)
 */
function handleProductSelectChange(productId) {
  if (!productId) return;
  
  var listContainer = document.getElementById('modalRecipeListContainer');
  var materialSelect = document.getElementById('modalRecipeMaterialSelect');
  
  listContainer.innerHTML = '<p class="text-center text-white/70 p-4"><i class="fas fa-spinner fa-spin"></i> กำลังโหลด...</p>';
  materialSelect.innerHTML = '<option value="" class="text-black">กำลังโหลด...</option>';

  // 1. โหลดรายการวัตถุดิบ (Materials) มาใส่ Dropdown
  var materialOptions = '';
  appState.materials.forEach(function(m) {
    materialOptions += '<option value="' + m['Material ID'] + '" data-unit="' + m.Unit + '" class="text-black">' + m['Material Name'] + ' (' + m.Unit + ')</option>';
  });
  materialSelect.innerHTML = '<option value="" class="text-black" disabled selected>-- เลือกวัตถุดิบ --</option>' + materialOptions;

  // 2. กรองสูตร (Recipes) เฉพาะของ Product นี้
  var productRecipes = appState.recipes.filter(function(r) {
    return r['Product ID'] === productId;
  });

  if (productRecipes.length === 0) {
    listContainer.innerHTML = '<p class="text-center text-white/70 p-4">ยังไม่มีสูตรสำหรับสินค้านี้</p>';
  } else {
    // 3. Render รายการวัตถุดิบ
    listContainer.innerHTML = productRecipes.map(function(r) {
      return '<div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">' +
        '<div>' +
          '<p class="font-bold">' + r['Material Name'] + '</p>' +
          '<p class="text-sm text-white/70">' + r.Quantity + ' ' + r.Unit + '</p>' +
        '</div>' +
        '<button onclick="deleteRecipeItem(&quot;' + r['Recipe ID'] + '&quot;)" class="text-red-400 hover:text-red-200 transition px-3 py-2" title="ลบ">' +
          '<i class="fas fa-trash"></i>' +
        '</button>' +
      '</div>';
    }).join('');
  }
  
  // 4. เปิดใช้งานฟอร์มเพิ่ม
  document.getElementById('modalRecipeMaterialSelect').disabled = false;
  document.getElementById('modalRecipeQtyInput').disabled = false;
  document.getElementById('modalRecipeAddButton').disabled = false;
  document.getElementById('modalRecipeAddButton').classList.remove('opacity-50', 'cursor-not-allowed');
}

/**
 * [ใหม่] เพิ่มวัตถุดิบลงในสูตร (CRUD - Create)
 */
function addRecipeItem() {
  var productId = document.getElementById('modalRecipeProductSelect').value;
  var materialSelect = document.getElementById('modalRecipeMaterialSelect');
  var materialId = materialSelect.value;
  var quantity = parseFloat(document.getElementById('modalRecipeQtyInput').value);
  
  if (!productId || !materialId || !quantity || quantity <= 0) {
    Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกสินค้า, วัตถุดิบ และใส่จำนวนที่ถูกต้อง', 'warning');
    return;
  }
  
  var selectedOption = materialSelect.options[materialSelect.selectedIndex];
  var materialName = selectedOption.text.split(' (')[0];
  var unit = selectedOption.getAttribute('data-unit');
  var product = appState.products.find(function(p) { return p['Product ID'] === productId; });
  
  var recipeData = {
    productId: productId,
    productName: product['Product Name'],
    materialId: materialId,
    materialName: materialName,
    quantity: quantity,
    unit: unit
  };
  
  Swal.fire({ title: 'กำลังเพิ่ม...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        Swal.close();
        // เพิ่มข้อมูลใหม่ลงใน State
        recipeData['Recipe ID'] = r.recipeId;
        appState.recipes.push(recipeData);
        
        // โหลดรายการใหม่
        handleProductSelectChange(productId);
        
        // รีเซ็ตฟอร์มย่อย
        document.getElementById('modalRecipeQtyInput').value = '';
        materialSelect.selectedIndex = 0;
      } else {
        Swal.fire('ผิดพลาด', r.message, 'error');
      }
    })
    .withFailureHandler(function(err) {
      Swal.fire('ผิดพลาด (JS)', err.message, 'error');
    })
    .addRecipe(appState.user.sheetId, recipeData);
}

/**
 * [ใหม่] ลบวัตถุดิบออกจากสูตร (CRUD - Delete)
 */
function deleteRecipeItem(recipeId) {
  Swal.fire({
    title: 'ลบวัตถุดิบนี้?',
    text: 'ต้องการลบวัตถุดิบนี้ออกจากสูตรหรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ใช่, ลบเลย',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (!result.isConfirmed) return;
    
    var productId = document.getElementById('modalRecipeProductSelect').value;
    
    Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });
    
    google.script.run
      .withSuccessHandler(function(r) {
        if (r.success) {
          Swal.close();
          // ลบออกจาก State
          appState.recipes = appState.recipes.filter(function(rec) {
            return rec['Recipe ID'] !== recipeId;
          });
          // โหลดรายการใหม่
          handleProductSelectChange(productId);
        } else {
          Swal.fire('ผิดพลาด', r.message, 'error');
        }
      })
      .withFailureHandler(function(err) {
        Swal.fire('ผิดพลาด (JS)', err.message, 'error');
      })
      .deleteRecipe(appState.user.sheetId, recipeId);
  });
}

/**
 * [แก้ไข] ฟังก์ชัน deleteRecipe (ตัวเดิม)
 * เราต้อง "คงไว้" เพราะ deleteRecipeItem เรียกใช้ตัวนี้
 * (ไม่ต้องแก้ไขอะไร)
 */
function deleteRecipe(recipeId) {
  Swal.fire({
    title: 'ลบสูตร?',
    text: 'คุณแน่ใจหรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('ลบเรียบร้อย!', '', 'success');
            loadRecipes(); // โหลดหน้า Dashboard ใหม่
          }
        })
        .deleteRecipe(appState.user.sheetId, recipeId);
    }
  });
}




function loadCosts() {
  var today = new Date().toISOString().split('T')[0];
  var month = today.substring(0, 7);
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        renderDailyCosts(result.data);
      }
    })
    .getDailyCosts(appState.user.sheetId, today);
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        renderMonthlyCosts(result.data);
      }
    })
    .getMonthlyCosts(appState.user.sheetId, month);
}

function renderDailyCosts(costs) {
  var container = document.getElementById('dailyCostsList');
  container.innerHTML = costs.map(function(c) {
    return '<div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2">' +
      '<div>' +
        '<p class="font-bold">' + c.Description + '</p>' +
        '<p class="text-sm text-gray-600">' + c.Category + '</p>' +
      '</div>' +
      '<div class="text-right">' +
        '<p class="font-bold text-red-600">฿' + c.Amount + '</p>' +
        '<button onclick="deleteCost(&quot;DailyCosts&quot;, &quot;' + c.ID + '&quot;)" class="text-red-600 text-sm"><i class="fas fa-trash"></i></button>' +
      '</div>' +
      '</div>';
  }).join('') || '<p class="text-gray-500" style="color: var(--text-secondary);">ยังไม่มีค่าใช้จ่าย</p>';
}

function renderMonthlyCosts(costs) {
  var container = document.getElementById('monthlyCostsList');
  container.innerHTML = costs.map(function(c) {
    return '<div class="flex justify-between items-center p-3 bg-gray-50 rounded mb-2">' +
      '<div>' +
        '<p class="font-bold">' + c.Description + '</p>' +
        '<p class="text-sm text-gray-600">' + c.Category + '</p>' +
      '</div>' +
      '<div class="text-right">' +
        '<p class="font-bold text-red-600">฿' + c.Amount + '</p>' +
        '<button onclick="deleteCost(&quot;MonthlyCosts&quot;, &quot;' + c.ID + '&quot;)" class="text-red-600 text-sm"><i class="fas fa-trash"></i></button>' +
      '</div>' +
      '</div>';
  }).join('') || '<p class="text-gray-500" style="color: var(--text-secondary);">ยังไม่มีค่าใช้จ่าย</p>';
}

function showAddDailyCostModal() {
  var today = new Date().toISOString().split('T')[0];
  Swal.fire({
    title: 'เพิ่มค่าใช้จ่ายรายวัน',
    html: `
      <input id="dcDate" type="date" class="swal2-input" value="${today}">
      <input id="dcDesc" class="swal2-input" placeholder="รายละเอียด">
      <input id="dcAmount" type="number" step="0.01" class="swal2-input" placeholder="จำนวนเงิน">
      <input id="dcCategory" class="swal2-input" placeholder="หมวดหมู่">
    `,
    confirmButtonText: 'เพิ่ม',
    cancelButtonText: 'ยกเลิก',
    showCancelButton: true,
    preConfirm: function() {
      return {
        date: document.getElementById('dcDate').value,
        description: document.getElementById('dcDesc').value,
        amount: parseFloat(document.getElementById('dcAmount').value),
        category: document.getElementById('dcCategory').value
      };
    }
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ', 'เพิ่มค่าใช้จ่ายเรียบร้อย!', 'success');
            loadCosts();
          }
        })
        .addDailyCost(appState.user.sheetId, result.value);
    }
  });
}

function showAddMonthlyCostModal() {
  var month = new Date().toISOString().substring(0, 7);
  Swal.fire({
    title: 'เพิ่มค่าใช้จ่ายรายเดือน',
    html: `
      <input id="mcMonth" type="month" class="swal2-input" value="${month}">
      <input id="mcDesc" class="swal2-input" placeholder="รายละเอียด">
      <input id="mcAmount" type="number" step="0.01" class="swal2-input" placeholder="จำนวนเงิน">
      <input id="mcCategory" class="swal2-input" placeholder="หมวดหมู่">
    `,
    confirmButtonText: 'เพิ่ม',
    cancelButtonText: 'ยกเลิก',
    showCancelButton: true,
    preConfirm: function() {
      return {
        month: document.getElementById('mcMonth').value,
        description: document.getElementById('mcDesc').value,
        amount: parseFloat(document.getElementById('mcAmount').value),
        category: document.getElementById('mcCategory').value
      };
    }
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ', 'เพิ่มค่าใช้จ่ายเรียบร้อย!', 'success');
            loadCosts();
          }
        })
        .addMonthlyCost(appState.user.sheetId, result.value);
    }
  });
}

function deleteCost(sheetName, costId) {
  Swal.fire({
    title: 'ลบค่าใช้จ่าย?',
    text: 'คุณแน่ใจหรือไม่?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('ลบเรียบร้อย!', '', 'success');
            loadCosts();
          }
        })
        .deleteCost(appState.user.sheetId, sheetName, costId);
    }
  });
}

function loadReports() {
  var startDate = document.getElementById('reportStartDate').value;
  var endDate = document.getElementById('reportEndDate').value;

  if (!startDate || !endDate) {
    Swal.fire('ผิดพลาด', 'กรุณาเลือกช่วงวันที่!', 'error');
    return;
  }

  Swal.fire({ title: 'กำลังสร้างรายงาน...', allowOutsideClick: false, didOpen: function() { Swal.showLoading(); } });

  google.script.run
    .withSuccessHandler(function(result) {
      Swal.close();
      if (result.success) {
        renderReport(result.data);
      } else {
        Swal.fire('ผิดพลาด', result.message, 'error');
      }
    })
    .getSalesByDateRange(appState.user.sheetId, startDate, endDate);
}

function renderReport(sales) {
  var totalRevenue = sales.reduce(function(sum, s) { return sum + (s.Total || 0); }, 0);
  var totalQty = sales.reduce(function(sum, s) { return sum + (s.Quantity || 0); }, 0);

  var productSales = {};
  sales.forEach(function(s) {
    var name = s['Product Name'];
    if (!productSales[name]) {
      productSales[name] = { qty: 0, revenue: 0 };
    }
    productSales[name].qty += s.Quantity;
    productSales[name].revenue += s.Total;
  });

  var sorted = Object.entries(productSales)
    .map(function(entry) {
      var name = entry[0];
      var data = entry[1];
      return { name: name, qty: data.qty, revenue: data.revenue };
    })
    .sort(function(a, b) { return b.revenue - a.revenue; });
  
  var html = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-green-100 p-4 rounded-lg">
        <p class="text-sm text-gray-600">รายรับรวม</p>
        <p class="text-2xl font-bold text-green-600">฿${totalRevenue.toFixed(2)}</p>
      </div>
      <div class="bg-blue-100 p-4 rounded-lg">
        <p class="text-sm text-gray-600">สินค้าที่ขายได้ทั้งหมด</p>
        <p class="text-2xl font-bold text-blue-600">${totalQty}</p>
      </div>
      <div class="bg-purple-100 p-4 rounded-lg">
        <p class="text-sm text-gray-600">จำนวนรายการ</p>
        <p class="text-2xl font-bold text-purple-600">${sales.length}</p>
      </div>
    </div>
    <h3 class="text-xl font-bold mb-4">ยอดขายตามสินค้า</h3>
    <table class="w-full">
      <thead>
        <tr class="bg-purple-600 text-white">
          <th class="p-3">สินค้า</th>
          <th class="p-3">จำนวน</th>
          <th class="p-3">รายรับ</th>
        </tr>
      </thead>
      <tbody>
        ${sorted.map(function(p) {
          return '<tr class="border-b">' +
            '<td class="p-3">' + p.name + '</td>' +
            '<td class="p-3">' + p.qty + '</td>' +
            '<td class="p-3">฿' + p.revenue.toFixed(2) + '</td>' +
            '</tr>';
        }).join('')}
      </tbody>
    </table>
  `;
  
  document.getElementById('reportsContent').innerHTML = html;
}

function loadSettings() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        appState.settings = result.data;
        document.getElementById('settingShopName').value = result.data['Shop Name'] || '';
        document.getElementById('settingPromptPay').value = result.data['PromptPay Number'] || '';
        document.getElementById('settingOrderMode').value = result.data['Order Number Mode'] || 'auto';
        document.getElementById('settingOrderFormat').value = result.data['Order Number Format'] || 'ORD-{YYYYMMDD}-{###}';

        // Load theme from settings
        loadTheme();

        // Refresh held orders when entering settings page
        refreshHeldOrders();
      }
    })
    .getSettings(appState.user.sheetId);
}

function saveSettings(e) {
  e.preventDefault();

  var settings = {
    'Shop Name': document.getElementById('settingShopName').value,
    'PromptPay Number': document.getElementById('settingPromptPay').value,
    'Order Number Mode': document.getElementById('settingOrderMode').value,
    'Order Number Format': document.getElementById('settingOrderFormat').value
  };

  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        Swal.fire('สำเร็จ', 'บันทึกการตั้งค่าเรียบร้อย!', 'success');
        loadSettings();
      } else {
        Swal.fire('ผิดพลาด', result.message, 'error');
      }
    })
    .updateSettings(appState.user.sheetId, settings);
}

function showLicenseModal() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        var d = result.data;
        Swal.fire({
          title: 'สถานะสิทธิ์การใช้งาน',
          html: `
            <div class="text-left">
              <p class="mb-2"><strong>ร้าน:</strong> ${d.shopName}</p>
              <p class="mb-2"><strong>แพ็กเกจ:</strong> <span class="px-2 py-1 bg-purple-200 rounded">${d.package}</span></p>
              <p class="mb-2"><strong>วันที่เริ่มต้น:</strong> ${d.startDate}</p>
              <p class="mb-2"><strong>วันที่สิ้นสุด:</strong> ${d.endDate}</p>
              <p class="mb-2"><strong>จำนวนวันที่เหลือ:</strong> <span class="${d.daysLeft < 30 ? 'text-red-600' : 'text-green-600'} font-bold">${d.daysLeft} วัน</span></p>
              <p class="mb-2"><strong>ราคา:</strong> ฿${d.price}</p>
            </div>
          `,
          icon: d.isExpired ? 'error' : 'info'
        });
      }
    })
    .checkLicense(appState.user.sheetId);
}

function showChangePasswordModal() {
  Swal.fire({
    title: 'เปลี่ยนรหัสผ่าน',
    html: `
      <input id="oldPassword" type="password" class="swal2-input" placeholder="รหัสผ่านเดิม">
      <input id="newPassword" type="password" class="swal2-input" placeholder="รหัสผ่านใหม่">
      <input id="confirmPassword" type="password" class="swal2-input" placeholder="ยืนยันรหัสผ่านใหม่">
    `,
    confirmButtonText: 'เปลี่ยนรหัสผ่าน',
    cancelButtonText: 'ยกเลิก',
    showCancelButton: true,
    preConfirm: function() {
      var newPwd = document.getElementById('newPassword').value;
      var confirmPwd = document.getElementById('confirmPassword').value;

      if (newPwd !== confirmPwd) {
        Swal.showValidationMessage('รหัสผ่านไม่ตรงกัน!');
        return false;
      }

      return {
        oldPassword: document.getElementById('oldPassword').value,
        newPassword: newPwd
      };
    }
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire('สำเร็จ', 'เปลี่ยนรหัสผ่านเรียบร้อย! กรุณาเข้าสู่ระบบใหม่', 'success').then(function() {
              logout();
            });
          } else {
            Swal.fire('ผิดพลาด', r.message, 'error');
          }
        })
        .changePassword(appState.user.email, result.value.oldPassword, result.value.newPassword);
    }
  });
}

// Set default dates
window.addEventListener('DOMContentLoaded', function() {
  var today = new Date().toISOString().split('T')[0];
  if (document.getElementById('reportStartDate')) {
    document.getElementById('reportStartDate').value = today;
  }
  if (document.getElementById('reportEndDate')) {
    document.getElementById('reportEndDate').value = today;
  }
});

// ============================================
// ORDER CHANNELS SYSTEM (Embedded from OrderChannels.js)
// ช่องทางการสั่งซื้อ - สามารถสร้างช่องทางเอง
// ============================================

// Note: Backend functions are in Code.js on Google Apps Script
// Frontend helper functions below

function getOrderChannelsFromBackend() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .getOrderChannels(appState.user.sheetId);
  });
}

function addOrderChannelToBackend(data) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .addOrderChannel(appState.user.sheetId, data);
  });
}

function updateOrderChannelInBackend(channelId, data) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .updateOrderChannel(appState.user.sheetId, channelId, data);
  });
}

function deleteOrderChannelFromBackend(channelId) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .deleteOrderChannel(appState.user.sheetId, channelId);
  });
}

function generateOrderNumberForChannelFromBackend(channelId) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .generateOrderNumberForChannel(appState.user.sheetId, channelId);
  });
}

// ============================================
// DISCOUNT SYSTEM (Embedded from Discount.js)
// ระบบส่วนลด - รองรับ % และจำนวนเงิน
// ============================================

/**
 * คำนวณส่วนลดฝั่ง Frontend
 */
function calculateDiscountLocal(amount, discountValue, discountType) {
  let discountAmount = 0;

  if (discountType === 'percent') {
    discountAmount = (amount * discountValue) / 100;
  } else if (discountType === 'amount') {
    discountAmount = discountValue;
  }

  if (discountAmount > amount) {
    discountAmount = amount;
  }

  return {
    discountAmount: discountAmount,
    finalAmount: amount - discountAmount
  };
}

function getDiscountPresetsFromBackend() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .getDiscountPresets(appState.user.sheetId);
  });
}

function addDiscountPresetToBackend(data) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .addDiscountPreset(appState.user.sheetId, data);
  });
}

// ============================================
// PAYMENT SPLIT SYSTEM (Embedded from PaymentSplit.js)
// ระบบแบ่งชำระเงินหลายวิธี
// ============================================

/**
 * ตรวจสอบการแบ่งชำระเงินฝั่ง Frontend
 */
function validatePaymentSplitLocal(totalAmount, payments) {
  if (!payments || payments.length === 0) {
    return {
      success: false,
      message: 'กรุณาเลือกวิธีการชำระเงิน'
    };
  }

  let totalPaid = 0;
  for (let payment of payments) {
    const amount = parseFloat(payment.amount) || 0;
    if (amount <= 0) {
      return {
        success: false,
        message: 'จำนวนเงินต้องมากกว่า 0'
      };
    }
    totalPaid += amount;
  }

  if (totalPaid < totalAmount) {
    return {
      success: false,
      message: 'ยอดชำระไม่ครบ (ขาดอีก ' + (totalAmount - totalPaid).toFixed(2) + ' บาท)',
      remaining: totalAmount - totalPaid
    };
  }

  const change = totalPaid - totalAmount;

  return {
    success: true,
    totalPaid: totalPaid,
    change: change,
    payments: payments
  };
}

function savePaymentSplitToBackend(orderNumber, totalAmount, payments) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .savePaymentSplit(appState.user.sheetId, orderNumber, totalAmount, payments);
  });
}

function getPaymentSplitsFromBackend(orderNumber) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .getPaymentSplits(appState.user.sheetId, orderNumber);
  });
}

function getPaymentSummaryFromBackend(startDate, endDate) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .getPaymentSummary(appState.user.sheetId, startDate, endDate);
  });
}


// ============================================
// MORE MENU (BOTTOM SHEET) FUNCTIONS
// ============================================

/**
 * เปิดเมนู "เพิ่มเติม" (สำหรับจอมือถือ)
 */
function openMoreMenu() {
  var modal = document.getElementById('moreMenuModal');
  var content = document.getElementById('moreMenuContent');
  
  modal.style.display = 'flex'; // แสดงฉากหลัง
  
  // ใช้ setTimeout เล็กน้อยเพื่อให้ 'display' ทำงานก่อนเริ่ม animation
  setTimeout(function() {
    content.classList.remove('translate-y-full');
    content.classList.add('translate-y-0');
  }, 10);
}

/**
 * ปิดเมนู "เพิ่มเติม"
 */
function closeMoreMenu() {
  var modal = document.getElementById('moreMenuModal');
  var content = document.getElementById('moreMenuContent');
  
  content.classList.add('translate-y-full'); // สั่งให้เลื่อนลง
  content.classList.remove('translate-y-0');
  
  // รอให้ animation (300ms) ทำงานเสร็จก่อนซ่อน
  setTimeout(function() {
    modal.style.display = 'none';
  }, 300); 
}

/**
 * ฟังก์ชันตัวช่วย: เปิดหน้าใหม่ แล้วปิดเมนู
 */
function showPageAndCloseMenu(pageName) {
  showPage(pageName);
  closeMoreMenu();
}



// ============================================
// [ใหม่] INVENTORY PAGE JAVASCRIPT
// ============================================
var lowStockChartInstance = null; // ตัวแปรสำหรับเก็บกราฟ


/**
 * โหลดข้อมูลหน้าสต็อก (เรียกโดย showPage)
 */
function loadInventoryPage() {
  // 1. แสดง Loading
  var tableBody = document.getElementById('inventoryTableBody');
  tableBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-white/70"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-2">กำลังโหลด...</p></td></tr>';
  
  // 🔽🔽🔽 [เพิ่มใหม่] 🔽🔽🔽
  var ledgerBody = document.getElementById('stockLedgerTableBody');
  ledgerBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-white/70"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-2">กำลังโหลด...</p></td></tr>';
  // 🔼🔼🔼 [สิ้นสุด] 🔼🔼🔼


  // 2. โหลดข้อมูลกราฟ
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        renderInventoryDashboard(r.data);
      }
    })
    .getInventoryDashboardData(appState.user.sheetId);
    
  // 3. โหลดข้อมูลตาราง
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        renderInventoryTable(r.data);
      }
    })
    .getInventoryData(appState.user.sheetId);
  loadStockLedger();
}

/**
 * Render กราฟและตัวเลขสรุป
 */
function renderInventoryDashboard(data) {
  // 1. สรุปมูลค่า
  document.getElementById('totalStockValue').textContent = '฿' + data.stockValue.toFixed(0);
  document.getElementById('totalOutOfStock').textContent = data.outOfStockCount + ' รายการ (ของหมด)';
  
  // 2. กราฟของใกล้หมด
  var ctx = document.getElementById('lowStockChart').getContext('2d');
  
  if (lowStockChartInstance) {
    lowStockChartInstance.destroy(); // ลบกราฟเก่า
  }
  
  if (data.lowStockItems.length === 0) {
    // แสดงข้อความถ้าของไม่ขาด
    ctx.font = "16px Prompt";
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.textAlign = "center";
    ctx.fillText("เยี่ยมมาก! ไม่มีของใกล้หมด", ctx.canvas.width / 2, ctx.canvas.height / 2);
    return;
  }
  
  lowStockChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.lowStockItems.map(item => item.name),
      datasets: [{
        label: '% สต็อกคงเหลือ',
        data: data.lowStockItems.map(item => (item.stock / item.minStock) * 100),
        backgroundColor: 'rgba(239, 68, 68, 0.6)', // สีแดง
        borderColor: 'rgba(239, 68, 68, 1)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y', // กราฟแนวนอน
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          beginAtZero: true,
          max: 100,
          ticks: { color: 'white' },
          grid: { color: 'rgba(255,255,255,0.2)' }
        },
        y: {
          ticks: { color: 'white' }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}



/**
 * [ใหม่] โหลดประวัติสต็อก 50 รายการล่าสุด
 */
function loadStockLedger() {
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        renderStockLedger(r.data);
      } else {
        document.getElementById('stockLedgerTableBody').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-red-400">ไม่สามารถโหลดประวัติได้: ' + r.message + '</td></tr>';
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('stockLedgerTableBody').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-red-400">Error: ' + err.message + '</td></tr>';
    })
    .getStockLedger(appState.user.sheetId);
}

/**
 * [ใหม่] Render ตารางประวัติสต็อก
 */
function renderStockLedger(ledger) {
  var tableBody = document.getElementById('stockLedgerTableBody');
  
  if (ledger.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-white/70">ยังไม่มีประวัติการเคลื่อนไหว</td></tr>';
    return;
  }
  
  tableBody.innerHTML = ledger.map(item => {
    var date = new Date(item.Date);
    var dateStr = date.toLocaleString('th-TH', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    var qty = parseFloat(item['Quantity Change']) || 0;
    var qtyClass = qty > 0 ? 'text-green-300' : 'text-red-300';
    var qtyStr = qty > 0 ? '+' + qty.toFixed(2) : qty.toFixed(2);
    
    return `<tr class="border-t border-white/10 hover:bg-white/10">
      <td class="p-3 text-white/70 text-sm">${dateStr}</td>
      <td class="p-3 font-bold">${item['Material Name']}</td>
      <td class="p-3 font-bold ${qtyClass}">${qtyStr}</td>
      <td class="p-3 text-white/80">${item.Reason}</td>
      <td class="p-3 text-white/80">${item['Order Number'] || '-'}</td>
    </tr>`;
  }).join('');
}

/**
 * Render ตารางสต็อกคงเหลือ
 */
function renderInventoryTable(inventory) {
  var tableBody = document.getElementById('inventoryTableBody');
  
  if (inventory.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-white/70">ไม่พบข้อมูลวัตถุดิบ (กรุณาไปที่หน้า "สินค้า" > "วัตถุดิบ" เพื่อเพิ่ม)</td></tr>';
    return;
  }
  
  // เรียงตาม % คงเหลือ (น้อยไปมาก)
  inventory.sort((a, b) => (a.stock / a.minStock) - (b.stock / b.minStock));
  
  tableBody.innerHTML = inventory.map(item => {
    let stock = item.stock;
    let minStock = item.minStock;
    let statusText = 'ปกติ';
    let statusClass = 'bg-green-500/30 text-green-300';
    
    if (stock <= 0) {
      statusText = 'ของหมด';
      statusClass = 'bg-red-500/30 text-red-300 font-bold';
    } else if (stock <= minStock) {
      statusText = 'ของใกล้หมด';
      statusClass = 'bg-yellow-500/30 text-yellow-300 font-bold';
    }
    
    return `<tr class="border-t border-white/10 hover:bg-white/10">
      <td class="p-3 font-bold">${item.name}</td>
      <td class="p-3">${stock.toFixed(2)} ${item.unit}</td>
      <td class="p-3 text-white/70">${minStock.toFixed(2)} ${item.unit}</td>
      <td class="p-3">
        <span class="px-3 py-1 rounded-full text-xs ${statusClass}">
          ${statusText}
        </span>
      </td>
    </tr>`;
  }).join('');
}

// --- Stock Modals JS ---

function showPurchaseModal() {
  var select = document.getElementById('purchaseMaterialSelect');
  select.innerHTML = '<option value="" class="text-black" disabled selected>-- เลือกวัตถุดิบ --</option>';
  appState.materials.forEach(m => {
    select.innerHTML += `<option value="${m['Material ID']}" class="text-black">${m['Material Name']} (${m.Unit})</option>`;
  });
  document.getElementById('purchaseForm').reset();
  document.getElementById('purchaseModal').style.display = 'flex';
}

function closePurchaseModal() {
  document.getElementById('purchaseModal').style.display = 'none';
}

function savePurchase(event) {
  event.preventDefault();
  Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  
  var materialId = document.getElementById('purchaseMaterialSelect').value;
  var quantity = document.getElementById('purchaseQty').value;
  
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) {
        Swal.fire('สำเร็จ!', 'รับของเข้าสต็อกเรียบร้อย', 'success');
        closePurchaseModal();
        loadInventoryPage(); // โหลดหน้าใหม่
      } else {
        Swal.fire('ผิดพลาด', r.message, 'error');
      }
    })
    .addStockPurchase(appState.user.sheetId, materialId, quantity);
}

function showWasteModal() {
  var select = document.getElementById('wasteMaterialSelect');
  select.innerHTML = '<option value="" class="text-black" disabled selected>-- เลือกวัตถุดิบ --</option>';
  appState.materials.forEach(m => {
    select.innerHTML += `<option value="${m['Material ID']}" class="text-black">${m['Material Name']} (${m.Unit})</option>`;
  });
  document.getElementById('wasteForm').reset();
  document.getElementById('wasteModal').style.display = 'flex';
}

function closeWasteModal() {
  document.getElementById('wasteModal').style.display = 'none';
}

function saveWaste(event) {
  event.preventDefault();
  Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  
  var materialId = document.getElementById('wasteMaterialSelect').value;
  var quantity = document.getElementById('wasteQty').value;
  var reason = document.getElementById('wasteReason').value;
  
  google.script.run
    .withSuccessHandler(r => {
      if (r.success) {
        Swal.fire('สำเร็จ!', 'บันทึกของเสียเรียบร้อย', 'success');
        closeWasteModal();
        loadInventoryPage(); // โหลดหน้าใหม่
      } else {
        Swal.fire('ผิดพลาด', r.message, 'error');
      }
    })
    .recordStockWaste(appState.user.sheetId, materialId, quantity, reason);
}



// ============================================
// [ใหม่] COMBO SETS MANAGEMENT (CRUD)
// ============================================
var currentComboId = null; // เก็บ ID ของ Combo ที่กำลังดู

function showManageCombosModal() {
  document.getElementById('comboManageModal').style.display = 'flex';
  document.getElementById('comboDetailsContainer').innerHTML = '<p class="text-center text-white/70 p-8">กรุณาเลือก Combo หรือ "สร้าง Combo ใหม่"</p>';
  loadComboList();
}

function closeManageCombosModal() {
  document.getElementById('comboManageModal').style.display = 'none';
  currentComboId = null;
  loadAllData(); // Refresh appState เผื่อมีการเปลี่ยนแปลง
}

// 1. โหลดรายการ Combo ทั้งหมด (Column 1)
function loadComboList() {
  var container = document.getElementById('comboListContainer');
  container.innerHTML = '<p class="text-white/70"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</p>';
  
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        appState.combos = r.data; // อัปเดต State
        if (r.data.length === 0) {
          container.innerHTML = '<p class="text-white/70 text-sm">ยังไม่มี Combo Set</p>';
          return;
        }
        container.innerHTML = r.data.map(function(combo) {
          var isActive = combo.comboId === currentComboId;
          return `
            <div onclick="loadComboDetails(&quot;${combo.comboId}&quot;)"
                 class="p-3 rounded-lg border-2 ${isActive ? 'bg-white/20 border-white' : 'bg-white/5 border-transparent'} hover:border-white/50 cursor-pointer transition">
              <div class="flex justify-between items-center">
                <span class="font-bold">${combo.comboName}</span>
                <button onclick="event.stopPropagation(); deleteCombo(&quot;${combo.comboId}&quot;)" class="text-red-400 hover:text-red-200 text-xs"><i class="fas fa-trash"></i></button>
              </div>
              <p class="text-sm text-white/80">฿${combo.comboPrice}</p>
            </div>
          `;
        }).join('');
      }
    })
    .getCombos(appState.user.sheetId);
}

// 2. แสดงฟอร์ม "สร้าง Combo ใหม่" (Column 2)
function showAddComboForm() {
  currentComboId = null; // ล้าง ID ที่เลือก
  loadComboList(); // Refresh list เพื่อเอาไฮไลท์ออก
  
  var container = document.getElementById('comboDetailsContainer');
  container.innerHTML = `
    <h3 class="text-lg font-bold text-white">สร้าง Combo Set ใหม่</h3>
    <form id="comboForm" onsubmit="saveNewCombo(event)" class="space-y-3">
      <div>
        <label class="block text-sm mb-1">ชื่อ Combo (เช่น เซ็ตสุดคุ้ม)</label>
        <input type="text" id="comboNameInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" required>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">ราคาปกติ (รวม)</label>
          <input type="number" id="comboRegularPriceInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm mb-1">ราคา Combo (พิเศษ)</label>
          <input type="number" id="comboPriceInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" required placeholder="0.00">
        </div>
      </div>
      <button type="submit" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold transition">
        <i class="fas fa-save mr-2"></i>บันทึกและเริ่มเพิ่มสินค้า
      </button>
    </form>
  `;
}

// 3. บันทึก Combo ใหม่ (CRUD - Create)
function saveNewCombo(event) {
  event.preventDefault();
  var data = {
    comboName: document.getElementById('comboNameInput').value,
    regularPrice: parseFloat(document.getElementById('comboRegularPriceInput').value) || 0,
    comboPrice: parseFloat(document.getElementById('comboPriceInput').value) || 0
  };
  
  Swal.fire({ title: 'กำลังสร้าง...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        Swal.close();
        currentComboId = r.comboId; // ตั้งเป็น Combo ที่กำลังใช้งาน
        loadComboList(); // Refresh Column 1
        loadComboDetails(r.comboId); // โหลด Column 2
      } else {
        Swal.fire('ผิดพลาด', r.message, 'error');
      }
    })
    .addCombo(appState.user.sheetId, data);
}

// 4. ลบ Combo (CRUD - Delete)
function deleteCombo(comboId) {
  Swal.fire({
    title: 'ลบ Combo นี้?',
    text: 'คุณแน่ใจหรือไม่ที่จะลบ Combo Set นี้ (สินค้าในชุดจะถูกลบด้วย)',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ใช่, ลบเลย',
    cancelButtonText: 'ยกเลิก',
    background: '#1f2937', // Dark theme for modal
    color: '#ffffff'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire({icon: 'success', title: 'ลบแล้ว', background: '#1f2937', color: '#ffffff'});
            currentComboId = null;
            showManageCombosModal(); // Refresh
          }
        })
        .deleteCombo(appState.user.sheetId, comboId);
    }
  });
}

// 5. โหลดรายละเอียด Combo และ "รายการสินค้า" (Column 2)
function loadComboDetails(comboId) {
  currentComboId = comboId;
  loadComboList(); // Refresh list เพื่อไฮไลท์
  
  var container = document.getElementById('comboDetailsContainer');
  container.innerHTML = '<p class="text-center text-white/70 p-8"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</p>';
  
  // ดึงข้อมูล Combo (รวม Items)
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        var combo = r.data;
        var itemsHtml = '';
        
        if (!combo.items || combo.items.length === 0) {
          itemsHtml = '<p class="text-center text-white/70 p-4">ยังไม่มีสินค้าใน Combo นี้</p>';
        } else {
          itemsHtml = combo.items.map(function(item) {
            var product = appState.products.find(p => p['Product ID'] === item.productId);
            var productName = product ? product['Product Name'] : 'ไม่พบสินค้า';
            return `
              <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                <div>
                  <p class="font-bold">${productName}</p>
                  <p class="text-sm text-white/70">จำนวน: ${item.quantity} | ${item.allowOptions === 'Yes' ? 'เลือก Option ได้' : 'ห้ามมี Option'}</p>
                </div>
                <button onclick="deleteComboItem(&quot;${combo.comboId}&quot;, &quot;${item.productId}&quot;)" class="text-red-400 hover:text-red-200"><i class="fas fa-trash"></i></button>
              </div>
            `;
          }).join('');
        }

        // สร้าง Dropdown สินค้า
        var productOptions = appState.products.filter(p => p.Status === 'active').map(p => {
          return `<option value="${p['Product ID']}" class="text-black">${p['Product Name']}</option>`;
        }).join('');

        // Render UI ทั้งหมด
        container.innerHTML = `
          <h3 class="text-lg font-bold text-white">จัดการ: ${combo.comboName}</h3>
          
          <p class="text-sm text-white/80">ราคา: ฿${combo.comboPrice} (ปกติ ฿${combo.regularPrice})</p>
          <hr class="border-white/20">

          <div class="bg-white/10 p-4 rounded-lg space-y-3">
            <h4 class="font-bold">เพิ่มสินค้าลงใน Combo</h4>
            <select id="comboItemProductSelect" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white">
              <option value="" class="text-black" disabled selected>-- เลือกสินค้า --</option>
              ${productOptions}
            </select>
            <div class="grid grid-cols-2 gap-3">
              <input type="number" id="comboItemQtyInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" value="1" min="1">
              <select id="comboItemAllowOptions" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white">
                <option value="No">ห้ามมี Option</option>
                <option value="Yes">อนุญาต Option</option>
              </select>
            </div>
            <button onclick="addComboItem(&quot;${combo.comboId}&quot;)" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition">
              <i class="fas fa-plus mr-2"></i>เพิ่มสินค้า
            </button>
          </div>
          
          <h4 class="font-bold">สินค้าในชุดนี้</h4>
          <div class="space-y-2">${itemsHtml}</div>
        `;
      }
    })
    .getComboById(appState.user.sheetId, comboId); // (ฟังก์ชันนี้มีใน Code.js แล้ว)
}

// 6. เพิ่มสินค้าใน Combo (CRUD - Create Item)
function addComboItem(comboId) {
  var productId = document.getElementById('comboItemProductSelect').value;
  var quantity = parseInt(document.getElementById('comboItemQtyInput').value) || 1;
  var allowOptions = document.getElementById('comboItemAllowOptions').value;
  
  if (!productId) {
    Swal.fire({icon: 'error', title: 'กรุณาเลือกสินค้า', background: '#1f2937', color: '#ffffff'});
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        loadComboDetails(comboId); // Refresh
      } else {
        Swal.fire({icon: 'error', title: r.message, background: '#1f2937', color: '#ffffff'});
      }
    })
    .addComboItem(appState.user.sheetId, comboId, productId, quantity, allowOptions);
}

// 7. ลบสินค้าใน Combo (CRUD - Delete Item)
function deleteComboItem(comboId, productId) {
  // (ไม่ต้องถามยืนยัน เพราะปุ่มเล็ก)
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        loadComboDetails(comboId); // Refresh
      }
    })
    .deleteComboItem(appState.user.sheetId, comboId, productId);
}


// ============================================
// [ใหม่] PRODUCT OPTIONS MANAGEMENT (CRUD)
// ============================================
var currentGroupId = null; // เก็บ ID ของ Group ที่กำลังดู

function showManageOptionsModal() {
  document.getElementById('optionsManageModal').style.display = 'flex';
  document.getElementById('optionDetailsContainer').innerHTML = '<p class="text-center text-white/70 p-8">กรุณาเลือกกลุ่ม (เช่น "ขนาด", "ความหวาน")</p>';
  loadOptionGroupList();
}

function closeManageOptionsModal() {
  document.getElementById('optionsManageModal').style.display = 'none';
  currentGroupId = null;
  loadAllData(); // Refresh appState เผื่อมีการเปลี่ยนแปลง
}

// 1. โหลดรายการ "กลุ่มตัวเลือก" (Column 1)
function loadOptionGroupList() {
  var container = document.getElementById('optionGroupListContainer');
  container.innerHTML = '<p class="text-white/70"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</p>';
  
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        appState.optionGroups = r.data; // อัปเดต State
        if (r.data.length === 0) {
          container.innerHTML = '<p class="text-white/70 text-sm">ยังไม่มีกลุ่มตัวเลือก</p>';
          return;
        }
        container.innerHTML = r.data.map(function(group) {
          var isActive = group.groupId === currentGroupId;
          return `
            <div onclick="loadOptionDetails(&quot;${group.groupId}&quot;)"
                 class="p-3 rounded-lg border-2 ${isActive ? 'bg-white/20 border-white' : 'bg-white/5 border-transparent'} hover:border-white/50 cursor-pointer transition">
              <div class="flex justify-between items-center">
                <span class="font-bold">${group.groupName}</span>
                <button onclick="event.stopPropagation(); deleteOptionGroup(&quot;${group.groupId}&quot;)" class="text-red-400 hover:text-red-200 text-xs"><i class="fas fa-trash"></i></button>
              </div>
              <p class="text-sm text-white/80">${group.selectionType} / ${group.required}</p>
            </div>
          `;
        }).join('');
      }
    })
    .getOptionGroups(appState.user.sheetId);
}

// 2. แสดงฟอร์ม "สร้างกลุ่มใหม่" (Column 2)
function showAddOptionGroupForm() {
  currentGroupId = null;
  loadOptionGroupList(); // Refresh list
  
  var container = document.getElementById('optionDetailsContainer');
  container.innerHTML = `
    <h3 class="text-lg font-bold text-white">สร้างกลุ่มตัวเลือกใหม่</h3>
    <form id="optionGroupForm" onsubmit="saveNewOptionGroup(event)" class="space-y-3">
      <div>
        <label class="block text-sm mb-1">ชื่อกลุ่ม (เช่น ขนาด, ความหวาน, ท็อปปิ้ง)</label>
        <input type="text" id="groupNameInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" required>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">ประเภทการเลือก</label>
          <select id="groupTypeInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white">
            <option value="single">เลือกได้ 1 อย่าง</option>
            <option value="multiple">เลือกได้หลายอย่าง</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">จำเป็นต้องเลือก?</label>
          <select id="groupRequiredInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white">
            <option value="No">ไม่จำเป็น</option>
            <option value="Yes">จำเป็น</option>
          </select>
        </div>
      </div>
      <button type="submit" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold transition">
        <i class="fas fa-save mr-2"></i>บันทึกกลุ่ม
      </button>
    </form>
  `;
}

// 3. บันทึก "กลุ่ม" ใหม่ (CRUD - Create Group)
function saveNewOptionGroup(event) {
  event.preventDefault();
  var data = {
    groupName: document.getElementById('groupNameInput').value,
    selectionType: document.getElementById('groupTypeInput').value,
    required: document.getElementById('groupRequiredInput').value
  };
  
  Swal.fire({ title: 'กำลังสร้าง...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        Swal.close();
        currentGroupId = r.groupId; // ตั้งเป็น Group ที่กำลังใช้งาน
        loadOptionGroupList(); // Refresh Column 1
        loadOptionDetails(r.groupId); // โหลด Column 2
      } else {
        Swal.fire('ผิดพลาด', r.message, 'error');
      }
    })
    .addOptionGroup(appState.user.sheetId, data);
}

// 4. ลบ "กลุ่ม" (CRUD - Delete Group)
function deleteOptionGroup(groupId) {
  Swal.fire({
    title: 'ลบกลุ่มนี้?',
    text: 'ตัวเลือกทั้งหมดในกลุ่มนี้จะถูกลบไปด้วย',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'ใช่, ลบเลย',
    cancelButtonText: 'ยกเลิก',
    background: '#1f2937', // Dark theme for modal
    color: '#ffffff'
  }).then(function(result) {
    if (result.isConfirmed) {
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            Swal.fire({icon: 'success', title: 'ลบแล้ว', background: '#1f2937', color: '#ffffff'});
            currentGroupId = null;
            showManageOptionsModal(); // Refresh
          }
        })
        .deleteOptionGroup(appState.user.sheetId, groupId);
    }
  });
}

// 5. โหลดรายละเอียด "ตัวเลือก" (Column 2)
function loadOptionDetails(groupId) {
  currentGroupId = groupId;
  loadOptionGroupList(); // Refresh list
  
  var container = document.getElementById('optionDetailsContainer');
  container.innerHTML = '<p class="text-center text-white/70 p-8"><i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...</p>';
  var group = appState.optionGroups.find(g => g.groupId === groupId);
  
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        var options = r.data;
        var itemsHtml = '';
        
        if (options.length === 0) {
          itemsHtml = '<p class="text-center text-white/70 p-4">ยังไม่มีตัวเลือกในกลุ่มนี้</p>';
        } else {
          itemsHtml = options.map(function(opt) {
            var priceText = opt.priceModifier > 0 ? ` (+฿${opt.priceModifier})` : '';
            return `
              <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                <div>
                  <p class="font-bold">${opt.optionName}${priceText}</p>
                  <p class="text-sm text-white/70">ลำดับ: ${opt.displayOrder} | ${opt.isDefault === 'Yes' ? 'ค่าเริ่มต้น' : ''}</p>
                </div>
                <button onclick="deleteOption(&quot;${opt.optionId}&quot;)" class="text-red-400 hover:text-red-200"><i class="fas fa-trash"></i></button>
              </div>
            `;
          }).join('');
        }

        // Render UI
        container.innerHTML = `
          <h3 class="text-lg font-bold text-white">จัดการกลุ่ม: ${group.groupName}</h3>
          
          <form id="optionForm" onsubmit="addOption(event)" class="bg-white/10 p-4 rounded-lg space-y-3">
            <h4 class="font-bold">เพิ่มตัวเลือกใหม่</h4>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">ชื่อตัวเลือก (เช่น เล็ก, หวานน้อย)</label>
                <input type="text" id="optionNameInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" required>
              </div>
              <div>
                <label class="block text-sm mb-1">ราคาที่เพิ่ม (+฿)</label>
                <input type="number" id="optionPriceInput" class="w-full p-3 rounded-lg bg-white/20 border-2 border-white/30 text-white" value="0" min="0">
              </div>
            </div>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition">
              <i class="fas fa-plus mr-2"></i>เพิ่มตัวเลือก
            </button>
          </form>
          
          <h4 class="font-bold">ตัวเลือกในกลุ่มนี้</h4>
          <div class="space-y-2">${itemsHtml}</div>
        `;
      }
    })
    .getOptions(appState.user.sheetId, groupId); // ดึงเฉพาะกลุ่มนี้
}

// 6. เพิ่ม "ตัวเลือก" (CRUD - Create Option)
function addOption(event) {
  event.preventDefault();
  if (!currentGroupId) return;
  
  var data = {
    optionGroupId: currentGroupId,
    optionName: document.getElementById('optionNameInput').value,
    priceModifier: parseFloat(document.getElementById('optionPriceInput').value) || 0,
    isDefault: 'No', // ตั้งเป็น No ไว้ก่อน
    displayOrder: 99
  };
  
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        loadOptionDetails(currentGroupId); // Refresh
      } else {
        Swal.fire({icon: 'error', title: r.message, background: '#1f2937', color: '#ffffff'});
      }
    })
    .addOption(appState.user.sheetId, data);
}

// 7. ลบ "ตัวเลือก" (CRUD - Delete Option)
function deleteOption(optionId) {
  google.script.run
    .withSuccessHandler(function(r) {
      if (r.success) {
        loadOptionDetails(currentGroupId); // Refresh
      }
    })
    .deleteOption(appState.user.sheetId, optionId);
}

// ==================== Sales History Functions ====================

// Variables
var salesHistoryData = [];
var monthlySalesChartInstance = null;
var dailySalesChartInstance = null;
var currentSortColumn = 'date';
var currentSortDirection = 'desc';

// Load Sales History Page
function loadSalesHistoryPage() {
  // Set current year and month
  var now = new Date();
  document.getElementById('currentYear').textContent = now.getFullYear();
  document.getElementById('currentMonth').textContent = getThaiMonth(now.getMonth());

  // Set default date range (today)
  var today = now.toISOString().split('T')[0];
  document.getElementById('startDate').value = today;
  document.getElementById('endDate').value = today;

  // Load data
  loadSalesHistoryData();
}

// Load Sales History Data from Backend
function loadSalesHistoryData() {
  showLoadingToast('กำลังโหลดข้อมูล...');
  google.script.run
    .withSuccessHandler(function(data) {
      hideLoadingToast();
      salesHistoryData = data || [];
      renderMonthlyChart();
      renderDailyChart();
      filterSalesHistory();
    })
    .withFailureHandler(function(error) {
      hideLoadingToast();
      showErrorToast('เกิดข้อผิดพลาด: ' + error.message);
    })
    .getSalesHistory();
}

// Render Monthly Sales Chart
function renderMonthlyChart() {
  var now = new Date();
  var year = now.getFullYear();
  var monthlyData = Array(12).fill(0);

  salesHistoryData.forEach(function(order) {
    var orderDate = new Date(order.timestamp);
    if (orderDate.getFullYear() === year) {
      var month = orderDate.getMonth();
      monthlyData[month] += order.total || 0;
    }
  });

  var ctx = document.getElementById('monthlySalesChart').getContext('2d');
  if (monthlySalesChartInstance) {
    monthlySalesChartInstance.destroy();
  }

  monthlySalesChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
      datasets: [{
        label: 'ยอดขาย (บาท)',
        data: monthlyData,
        backgroundColor: 'rgba(99, 102, 241, 0.5)',
        borderColor: 'rgba(99, 102, 241, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// Render Daily Sales Chart
function renderDailyChart() {
  var now = new Date();
  var year = now.getFullYear();
  var month = now.getMonth();
  var daysInMonth = new Date(year, month + 1, 0).getDate();
  var dailyData = Array(daysInMonth).fill(0);

  salesHistoryData.forEach(function(order) {
    var orderDate = new Date(order.timestamp);
    if (orderDate.getFullYear() === year && orderDate.getMonth() === month) {
      var day = orderDate.getDate() - 1;
      dailyData[day] += order.total || 0;
    }
  });

  var labels = [];
  for (var i = 1; i <= daysInMonth; i++) {
    labels.push(i + '');
  }

  var ctx = document.getElementById('dailySalesChart').getContext('2d');
  if (dailySalesChartInstance) {
    dailySalesChartInstance.destroy();
  }

  dailySalesChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ยอดขาย (บาท)',
        data: dailyData,
        backgroundColor: 'rgba(139, 92, 246, 0.2)',
        borderColor: 'rgba(139, 92, 246, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// Filter Sales History by Date Range
function filterSalesHistory() {
  var startDate = document.getElementById('startDate').value;
  var endDate = document.getElementById('endDate').value;

  if (!startDate || !endDate) return;

  var start = new Date(startDate);
  start.setHours(0, 0, 0, 0);
  var end = new Date(endDate);
  end.setHours(23, 59, 59, 999);

  var filtered = salesHistoryData.filter(function(order) {
    var orderDate = new Date(order.timestamp);
    return orderDate >= start && orderDate <= end;
  });

  updateSummary(filtered);
  renderSalesTable(filtered);
  renderTopProducts(filtered);
}

// Update Summary Cards
function updateSummary(data) {
  var totalSales = 0;
  var totalOrders = data.length;

  data.forEach(function(order) {
    totalSales += order.total || 0;
  });

  var avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

  document.getElementById('totalSales').textContent = '฿' + totalSales.toFixed(2);
  document.getElementById('totalOrders').textContent = totalOrders;
  document.getElementById('avgOrderValue').textContent = '฿' + avgOrderValue.toFixed(2);

  // Find top product
  var productCount = {};
  data.forEach(function(order) {
    if (order.items) {
      order.items.forEach(function(item) {
        var name = item.name || 'Unknown';
        productCount[name] = (productCount[name] || 0) + item.quantity;
      });
    }
  });

  var topProduct = '-';
  var maxCount = 0;
  for (var product in productCount) {
    if (productCount[product] > maxCount) {
      maxCount = productCount[product];
      topProduct = product;
    }
  }

  document.getElementById('topProduct').textContent = topProduct;
}

// Render Sales Table
function renderSalesTable(data) {
  var tbody = document.getElementById('salesHistoryTableBody');
  tbody.innerHTML = '';

  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">ไม่พบข้อมูล</td></tr>';
    return;
  }

  data.forEach(function(order) {
    var tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid var(--border-color)';
    tr.innerHTML = `
      <td class="px-4 py-3">${formatDateTime(order.timestamp)}</td>
      <td class="px-4 py-3 font-mono">${order.orderId || '-'}</td>
      <td class="px-4 py-3">${formatOrderItems(order.items)}</td>
      <td class="px-4 py-3 text-right font-bold text-green-600">฿${(order.total || 0).toFixed(2)}</td>
      <td class="px-4 py-3 text-center">${formatPaymentMethod(order.paymentMethod)}</td>
      <td class="px-4 py-3 text-center">
        ${order.slipUrl ? '<button onclick="viewSlip(&quot;' + order.slipUrl + '&quot;)" class="text-blue-600 hover:text-blue-800"><i class="fas fa-image"></i></button>' : '-'}
      </td>
      <td class="px-4 py-3 text-center">
        <button onclick="viewOrderDetails(&quot;${order.orderId}&quot;)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-eye mr-1"></i>ดูรายละเอียด
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Render Top Products List
function renderTopProducts(data) {
  var productSales = {};

  data.forEach(function(order) {
    if (order.items) {
      order.items.forEach(function(item) {
        var name = item.name || 'Unknown';
        if (!productSales[name]) {
          productSales[name] = { quantity: 0, revenue: 0 };
        }
        productSales[name].quantity += item.quantity || 0;
        productSales[name].revenue += (item.price || 0) * (item.quantity || 0);
      });
    }
  });

  var sorted = Object.keys(productSales).map(function(name) {
    return {
      name: name,
      quantity: productSales[name].quantity,
      revenue: productSales[name].revenue
    };
  }).sort(function(a, b) {
    return b.revenue - a.revenue;
  }).slice(0, 10);

  var html = '';
  sorted.forEach(function(item, index) {
    html += `
      <div class="flex items-center justify-between py-3 border-b" style="border-color: var(--border-color);">
        <div class="flex items-center">
          <span class="text-2xl font-bold mr-4" style="color: var(--text-secondary);">${index + 1}</span>
          <div>
            <div class="font-bold" style="color: var(--text-primary);">${item.name}</div>
            <div class="text-sm" style="color: var(--text-secondary);">ขายได้ ${item.quantity} รายการ</div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-bold text-green-600">฿${item.revenue.toFixed(2)}</div>
        </div>
      </div>
    `;
  });

  document.getElementById('topProductsList').innerHTML = html || '<p class="text-center text-gray-500 py-4">ไม่พบข้อมูล</p>';
}

// Sort Sales Table
function sortSalesTable(column) {
  if (currentSortColumn === column) {
    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortColumn = column;
    currentSortDirection = 'desc';
  }

  var startDate = document.getElementById('startDate').value;
  var endDate = document.getElementById('endDate').value;
  var start = new Date(startDate);
  start.setHours(0, 0, 0, 0);
  var end = new Date(endDate);
  end.setHours(23, 59, 59, 999);

  var filtered = salesHistoryData.filter(function(order) {
    var orderDate = new Date(order.timestamp);
    return orderDate >= start && orderDate <= end;
  });

  filtered.sort(function(a, b) {
    var aVal, bVal;
    if (column === 'date') {
      aVal = new Date(a.timestamp);
      bVal = new Date(b.timestamp);
    } else if (column === 'orderId') {
      aVal = a.orderId || '';
      bVal = b.orderId || '';
    } else if (column === 'total') {
      aVal = a.total || 0;
      bVal = b.total || 0;
    }

    if (currentSortDirection === 'asc') {
      return aVal > bVal ? 1 : -1;
    } else {
      return aVal < bVal ? 1 : -1;
    }
  });

  renderSalesTable(filtered);
}

// Reset Date Filter
function resetDateFilter() {
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').value = today;
  document.getElementById('endDate').value = today;
  filterSalesHistory();
}

// View Order Details (modal)
function viewOrderDetails(orderId) {
  var order = salesHistoryData.find(function(o) { return o.orderId === orderId; });
  if (!order) {
    showErrorToast('ไม่พบข้อมูลออเดอร์');
    return;
  }

  var itemsHtml = '';
  if (order.items && order.items.length > 0) {
    order.items.forEach(function(item) {
      itemsHtml += `<div class="flex justify-between py-2">
        <span>${item.name} x${item.quantity}</span>
        <span>฿${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</span>
      </div>`;
    });
  }

  Swal.fire({
    title: 'รายละเอียดออเดอร์',
    html: `
      <div class="text-left">
        <p><strong>เลขที่ออเดอร์:</strong> ${order.orderId || '-'}</p>
        <p><strong>วันที่/เวลา:</strong> ${formatDateTime(order.timestamp)}</p>
        <p><strong>การชำระเงิน:</strong> ${formatPaymentMethod(order.paymentMethod)}</p>
        <hr class="my-3">
        <div><strong>รายการสินค้า:</strong></div>
        ${itemsHtml}
        <hr class="my-3">
        <div class="flex justify-between font-bold text-lg">
          <span>ยอดรวม:</span>
          <span class="text-green-600">฿${(order.total || 0).toFixed(2)}</span>
        </div>
      </div>
    `,
    width: '600px',
    confirmButtonText: 'ปิด'
  });
}

// View Slip Image
function viewSlip(url) {
  Swal.fire({
    imageUrl: url,
    imageAlt: 'สลิปการโอนเงิน',
    showConfirmButton: true,
    confirmButtonText: 'ปิด'
  });
}

// Helper Functions
function formatDateTime(timestamp) {
  if (!timestamp) return '-';
  var d = new Date(timestamp);
  return d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
}

function formatOrderItems(items) {
  if (!items || items.length === 0) return '-';
  if (items.length === 1) return items[0].name + ' x' + items[0].quantity;
  return items[0].name + ' และอื่นๆ อีก ' + (items.length - 1) + ' รายการ';
}

function formatPaymentMethod(method) {
  if (!method) return '-';
  var methods = [];
  if (method.cash) methods.push('เงินสด');
  if (method.transfer) methods.push('โอนเงิน');
  if (method.qr) methods.push('QR Code');
  return methods.join(', ') || '-';
}

function getThaiMonth(monthIndex) {
  var months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
  return months[monthIndex];
}

// ==================== End Sales History Functions ====================


</script>

</body>
</html>